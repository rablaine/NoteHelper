{% extends 'base.html' %}

{% block title %}Data Management - NoteHelper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 mx-auto">
        <h1 class="mb-4"><i class="bi bi-database"></i> Data Management</h1>

        <!-- Import Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cloud-download"></i> Import from MSX</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Automatically imports all accounts you're assigned to in MSX, along with their territories, 
                    PODs, sellers, solution engineers, and verticals.
                </p>
                
                {% if has_data %}
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Note:</strong> This will add to existing data. Duplicate records will be skipped.
                </div>
                {% endif %}
                
                <button class="btn btn-primary btn-lg" type="button" id="importFromMsxBtn">
                    <i class="bi bi-cloud-download"></i> Import My Accounts from MSX
                </button>
                
                <!-- MSX Import Progress -->
                <div id="msxImportProgress" class="mt-4 d-none">
                    <div class="d-flex justify-content-between mb-1">
                        <small class="text-muted" id="msxImportStatusText">Starting import...</small>
                        <small class="text-muted" id="msxImportProgressPercent">0%</small>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                             role="progressbar" id="msxImportProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- MSX Import Results -->
                <div id="msxImportResults" class="mt-4 d-none">
                    <div class="alert alert-success mb-0">
                        <h6 class="alert-heading"><i class="bi bi-check-circle"></i> Import Complete!</h6>
                        <div id="msxImportSummary"></div>
                    </div>
                </div>
                
                <!-- MSX Import Error -->
                <div id="msxImportError" class="mt-4 d-none">
                    <div class="alert alert-danger mb-0">
                        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Import Error</h6>
                        <p class="mb-0" id="msxImportErrorText"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-download"></i> Export Call Logs</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Export your call logs with enriched data for external analysis or LLM processing.</p>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-success" id="exportCallLogsJsonBtn">
                        <i class="bi bi-file-earmark-code"></i> JSON
                    </button>
                    <button class="btn btn-success" id="exportCallLogsCsvBtn">
                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Export Call Logs JSON
    document.getElementById('exportCallLogsJsonBtn').addEventListener('click', function() {
        window.location.href = '/api/data-management/export/call-logs-json';
    });

    // Export Call Logs CSV
    document.getElementById('exportCallLogsCsvBtn').addEventListener('click', function() {
        window.location.href = '/api/data-management/export/call-logs-csv';
    });
    
    // =========================================================================
    // MSX Import
    // =========================================================================
    
    document.getElementById('importFromMsxBtn').addEventListener('click', async function() {
        const btn = this;
        const progressDiv = document.getElementById('msxImportProgress');
        const resultsDiv = document.getElementById('msxImportResults');
        const errorDiv = document.getElementById('msxImportError');
        const statusText = document.getElementById('msxImportStatusText');
        const progressPercent = document.getElementById('msxImportProgressPercent');
        const progressBar = document.getElementById('msxImportProgressBar');
        const summaryDiv = document.getElementById('msxImportSummary');
        
        // Reset UI
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Importing...';
        progressDiv.classList.remove('d-none');
        resultsDiv.classList.add('d-none');
        errorDiv.classList.add('d-none');
        statusText.textContent = 'Starting import...';
        progressPercent.textContent = '0%';
        progressBar.style.width = '0%';
        
        try {
            const response = await fetch('/api/msx/import-stream');
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.error) {
                                throw new Error(data.error);
                            }
                            
                            if (data.message) {
                                statusText.textContent = data.message;
                            }
                            
                            if (data.progress !== undefined) {
                                progressPercent.textContent = `${data.progress}%`;
                                progressBar.style.width = `${data.progress}%`;
                            }
                            
                            if (data.complete && data.summary) {
                                // Import complete - show summary
                                progressDiv.classList.add('d-none');
                                resultsDiv.classList.remove('d-none');
                                
                                const s = data.summary;
                                summaryDiv.innerHTML = `
                                    <ul class="mb-0">
                                        <li>PODs: ${s.pods_created || 0} created</li>
                                        <li>Territories: ${s.territories_created || 0} created</li>
                                        <li>Sellers: ${s.sellers_created || 0} created</li>
                                        <li>Solution Engineers: ${s.solution_engineers_created || 0} created</li>
                                        <li>Verticals: ${s.verticals_created || 0} created</li>
                                        <li>Customers: ${s.customers_created || 0} created, ${s.customers_skipped || 0} skipped</li>
                                    </ul>
                                    <a href="{{ url_for('customers.customers_list') }}" class="btn btn-sm btn-outline-primary mt-2">
                                        <i class="bi bi-people"></i> View Customers
                                    </a>
                                `;
                            }
                        } catch (parseError) {
                            if (parseError.message !== 'Unexpected end of JSON input') {
                                console.error('SSE parse error:', parseError);
                            }
                        }
                    }
                }
            }
        } catch (error) {
            progressDiv.classList.add('d-none');
            errorDiv.classList.remove('d-none');
            document.getElementById('msxImportErrorText').textContent = error.message;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-cloud-download"></i> Import My Accounts from MSX';
        }
    });
</script>

{% endblock %}
