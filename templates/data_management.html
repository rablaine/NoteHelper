{% extends 'base.html' %}

{% block title %}Data Management - NoteHelper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 mx-auto">
        <h1 class="mb-4"><i class="bi bi-database"></i> Data Management</h1>

        <!-- Import Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cloud-download"></i> Import from MSX</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Automatically imports all accounts you're assigned to in MSX, along with their territories, 
                    PODs, sellers, solution engineers, and verticals.
                </p>
                
                {% if has_data %}
                <div class="alert alert-warning mb-3">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Note:</strong> This will add to existing data. Duplicate records will be skipped.
                </div>
                {% endif %}
                
                <button class="btn btn-primary btn-lg" type="button" id="importFromMsxBtn">
                    <i class="bi bi-cloud-download"></i> Import My Accounts from MSX
                </button>
                
                <!-- MSX Import Progress -->
                <div id="msxImportProgress" class="mt-4 d-none">
                    <div class="d-flex justify-content-between mb-1">
                        <small class="text-muted" id="msxImportStatusText">Starting import...</small>
                        <small class="text-muted" id="msxImportProgressPercent">0%</small>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                             role="progressbar" id="msxImportProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- MSX Import Results -->
                <div id="msxImportResults" class="mt-4 d-none">
                    <div class="alert alert-success mb-0">
                        <h6 class="alert-heading"><i class="bi bi-check-circle"></i> Import Complete!</h6>
                        <div id="msxImportSummary"></div>
                    </div>
                </div>
                
                <!-- MSX Import Error -->
                <div id="msxImportError" class="mt-4 d-none">
                    <div class="alert alert-danger mb-0">
                        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Import Error</h6>
                        <p class="mb-0" id="msxImportErrorText"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-download"></i> Export Call Logs</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Export your call logs with enriched data for backup or analysis.</p>
                
                <div class="d-flex gap-2">
                    <button class="btn btn-success" id="exportCallLogsJsonBtn">
                        <i class="bi bi-file-earmark-code"></i> JSON
                    </button>
                    <button class="btn btn-success" id="exportCallLogsCsvBtn">
                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                    </button>
                </div>
            </div>
        </div>

        <!-- Import Call Logs Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-upload"></i> Import Call Logs</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Import call logs from a JSON file previously exported from NoteHelper.</p>
                
                <form id="importCallLogsForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="importCallLogsFile" class="form-label">Select JSON File</label>
                        <input type="file" class="form-control" id="importCallLogsFile" name="file" accept=".json" required>
                        <div class="form-text">Only JSON files exported from NoteHelper are supported.</div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="skipDuplicates" name="skip_duplicates" checked>
                        <label class="form-check-label" for="skipDuplicates">
                            Skip duplicate entries (recommended)
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-success" id="importCallLogsBtn">
                        <i class="bi bi-upload"></i> Import Call Logs
                    </button>
                </form>

                <div id="importCallLogsProgress" class="mt-3 d-none">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                    <p class="text-muted mt-2">Importing...</p>
                </div>

                <div id="importCallLogsResults" class="mt-3 d-none"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Export Call Logs JSON
    document.getElementById('exportCallLogsJsonBtn').addEventListener('click', function() {
        window.location.href = '/api/data-management/export/call-logs-json';
    });

    // Export Call Logs CSV
    document.getElementById('exportCallLogsCsvBtn').addEventListener('click', function() {
        window.location.href = '/api/data-management/export/call-logs-csv';
    });

    // =========================================================================
    // Import Call Logs from JSON
    // =========================================================================
    
    document.getElementById('importCallLogsForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const importBtn = document.getElementById('importCallLogsBtn');
        const importProgress = document.getElementById('importCallLogsProgress');
        const importResults = document.getElementById('importCallLogsResults');
        const fileInput = document.getElementById('importCallLogsFile');
        const skipDuplicates = document.getElementById('skipDuplicates').checked;
        
        if (!fileInput.files[0]) {
            alert('Please select a file');
            return;
        }
        
        // Show progress
        importBtn.disabled = true;
        importProgress.classList.remove('d-none');
        importResults.classList.add('d-none');
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('skip_duplicates', skipDuplicates);
        
        try {
            const response = await fetch('/api/my-data/import/json', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            // Hide progress
            importProgress.classList.add('d-none');
            
            // Show results
            importResults.classList.remove('d-none');
            if (result.success) {
                importResults.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle"></i> Import Successful!</h6>
                        <ul class="mb-0">
                            <li>Call Logs: ${result.imported.call_logs} imported, ${result.skipped.call_logs} skipped</li>
                            <li>Customers: ${result.imported.customers} imported, ${result.skipped.customers} skipped</li>
                            <li>Topics: ${result.imported.topics} imported, ${result.skipped.topics} skipped</li>
                        </ul>
                    </div>
                `;
            } else {
                importResults.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-x-circle"></i> Import Failed</h6>
                        <p class="mb-0">${result.error}</p>
                    </div>
                `;
            }
            
        } catch (error) {
            importProgress.classList.add('d-none');
            importResults.classList.remove('d-none');
            importResults.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="bi bi-x-circle"></i> Import Failed</h6>
                    <p class="mb-0">Error: ${error.message}</p>
                </div>
            `;
        } finally {
            importBtn.disabled = false;
            fileInput.value = '';
        }
    });
    
    // =========================================================================
    // MSX Import
    // =========================================================================
    
    document.getElementById('importFromMsxBtn').addEventListener('click', async function() {
        const btn = this;
        const progressDiv = document.getElementById('msxImportProgress');
        const resultsDiv = document.getElementById('msxImportResults');
        const errorDiv = document.getElementById('msxImportError');
        const statusText = document.getElementById('msxImportStatusText');
        const progressPercent = document.getElementById('msxImportProgressPercent');
        const progressBar = document.getElementById('msxImportProgressBar');
        const summaryDiv = document.getElementById('msxImportSummary');
        
        // Reset UI
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Importing...';
        progressDiv.classList.remove('d-none');
        resultsDiv.classList.add('d-none');
        errorDiv.classList.add('d-none');
        statusText.textContent = 'Starting import...';
        progressPercent.textContent = '0%';
        progressBar.style.width = '0%';
        
        try {
            const response = await fetch('/api/msx/import-stream');
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.error) {
                                throw new Error(data.error);
                            }
                            
                            if (data.message) {
                                statusText.textContent = data.message;
                            }
                            
                            if (data.progress !== undefined) {
                                progressPercent.textContent = `${data.progress}%`;
                                progressBar.style.width = `${data.progress}%`;
                            }
                            
                            if (data.complete && data.summary) {
                                // Import complete - show summary
                                progressDiv.classList.add('d-none');
                                resultsDiv.classList.remove('d-none');
                                
                                const s = data.summary;
                                summaryDiv.innerHTML = `
                                    <ul class="mb-0">
                                        <li>PODs: ${s.pods_created || 0} created</li>
                                        <li>Territories: ${s.territories_created || 0} created</li>
                                        <li>Sellers: ${s.sellers_created || 0} created</li>
                                        <li>Solution Engineers: ${s.solution_engineers_created || 0} created</li>
                                        <li>Verticals: ${s.verticals_created || 0} created</li>
                                        <li>Customers: ${s.customers_created || 0} created, ${s.customers_skipped || 0} skipped</li>
                                    </ul>
                                    <a href="{{ url_for('customers.customers_list') }}" class="btn btn-sm btn-outline-primary mt-2">
                                        <i class="bi bi-people"></i> View Customers
                                    </a>
                                `;
                            }
                        } catch (parseError) {
                            if (parseError.message !== 'Unexpected end of JSON input') {
                                console.error('SSE parse error:', parseError);
                            }
                        }
                    }
                }
            }
        } catch (error) {
            progressDiv.classList.add('d-none');
            errorDiv.classList.remove('d-none');
            document.getElementById('msxImportErrorText').textContent = error.message;
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-cloud-download"></i> Import My Accounts from MSX';
        }
    });
</script>

{% endblock %}
