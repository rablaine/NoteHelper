{% extends "base.html" %}

{% block title %}Home - NoteHelper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-2">Welcome to NoteHelper</h1>
                <p class="lead mb-0">Track and manage your customer call notes efficiently.</p>
            </div>
            <button type="button" class="btn btn-primary btn-lg home-cta-button" data-bs-toggle="modal" data-bs-target="#quickCallLogModal">
                <i class="bi bi-plus-circle"></i> New Call Log
            </button>
        </div>
    </div>
</div>

<style>
    .home-cta-button {
        border: 1px solid rgba(0, 0, 0, 0.15) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15) !important;
    }
    .home-cta-button:hover {
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2) !important;
        transform: translateY(-1px);
        transition: all 0.2s;
    }
    [data-bs-theme="dark"] .home-cta-button {
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4) !important;
    }
    [data-bs-theme="dark"] .home-cta-button:hover {
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5) !important;
    }
</style>

<div class="row mt-4">
    <div class="col-md-3">
        <a href="{{ url_for('call_logs.call_logs_list') }}" class="text-decoration-none">
            <div class="card text-center h-100" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body">
                    <i class="bi bi-telephone-fill text-primary" style="font-size: 3rem;"></i>
                    <h5 class="card-title mt-3">Call Logs</h5>
                    <p class="card-text text-muted">{{ stats.call_logs }} total</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('customers.customers_list') }}" class="text-decoration-none">
            <div class="card text-center h-100" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body">
                    <i class="bi bi-building text-success" style="font-size: 3rem;"></i>
                    <h5 class="card-title mt-3">Customers</h5>
                    <p class="card-text text-muted">{{ stats.customers }} total</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('sellers.sellers_list') }}" class="text-decoration-none">
            <div class="card text-center h-100" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body">
                    <i class="bi bi-people text-info" style="font-size: 3rem;"></i>
                    <h5 class="card-title mt-3">Sellers</h5>
                    <p class="card-text text-muted">{{ stats.sellers }} total</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('topics.topics_list') }}" class="text-decoration-none">
            <div class="card text-center h-100" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body">
                    <i class="bi bi-tags text-warning" style="font-size: 3rem;"></i>
                    <h5 class="card-title mt-3">Topics</h5>
                    <p class="card-text text-muted">{{ stats.topics }} total</p>
                </div>
            </div>
        </a>
    </div>
</div>

<style>
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    html[data-bs-theme="dark"] .card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
</style>

<div class="row mt-4" id="draftsSection" style="display: none;">
    <div class="col-md-12">
        <div class="alert alert-warning d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-pencil-square"></i> <strong>Unsaved Drafts</strong>
                <span id="draftCount" class="badge bg-warning text-dark ms-2">0</span>
            </div>
            <button type="button" class="btn btn-sm btn-outline-warning" onclick="clearAllDrafts()">
                <i class="bi bi-trash"></i> Clear All Drafts
            </button>
        </div>
        <div id="draftsList" class="list-group mb-3"></div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-md-12">
        <h3 class="mb-3">Recent Call Logs</h3>
        {% if recent_calls %}
            <div class="list-group">
                {% for call in recent_calls %}
                    <div class="list-group-item list-group-item-action" style="cursor: pointer;" onclick="window.location.href='{{ url_for('call_logs.call_log_view', id=call.id) }}';">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">
                                <a href="{{ url_for('customers.customer_view', id=call.customer.id) }}" class="text-decoration-none" onclick="event.stopPropagation();">
                                    {{ call.customer.name }}
                                </a>
                            </h5>
                            <small class="text-muted">{{ call.call_date.strftime('%b %d, %Y') }}</small>
                        </div>
                        <div class="mb-2">
                            {% if call.seller %}
                                <a href="{{ url_for('sellers.seller_view', id=call.seller.id) }}" class="badge {{ get_seller_color(call.seller.id) }} text-decoration-none" onclick="event.stopPropagation();"><i class="bi bi-person"></i> {{ call.seller.name }}</a>
                            {% endif %}
                            {% if call.territory %}
                                <a href="{{ url_for('territories.territory_view', id=call.territory.id) }}" class="badge bg-info text-dark text-decoration-none" onclick="event.stopPropagation();"><i class="bi bi-geo-alt"></i> {{ call.territory.name }}</a>
                            {% endif %}
                            {% for topic in call.topics %}
                                <a href="{{ url_for('topics.topic_view', id=topic.id) }}" class="badge bg-warning text-dark text-decoration-none" onclick="event.stopPropagation();"><i class="bi bi-tag"></i> {{ topic.name }}</a>
                            {% endfor %}
                        </div>
                        <div class="text-muted">{{ call.content|striptags|truncate(200) }}</div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> No call logs yet. <a href="{{ url_for('call_logs.call_log_create') }}">Create your first call log</a>!
            </div>
        {% endif %}
    </div>
</div>

<!-- First-Time User Welcome Modal -->
{% if show_first_time_modal %}
<div class="modal fade" id="firstTimeModal" tabindex="-1" aria-labelledby="firstTimeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="firstTimeModalLabel">
                    <i class="bi bi-rocket"></i> Welcome to NoteHelper!
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="lead">Thanks for signing up! Let's get you started.</p>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-moon-stars text-primary"></i> Personalize Your Experience</h6>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <strong>Dark Mode</strong>
                                <p class="text-muted mb-0 small">Easy on the eyes for extended use</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="firstTimeDarkModeSwitch" style="width: 3em; height: 1.5em;">
                            </div>
                        </div>
                        <small class="text-muted">You can change this anytime in Settings.</small>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-info-circle text-primary"></i> Quick Start Tip</h6>
                        <p class="card-text mb-0">
                            If you have an existing customer alignment spreadsheet, you can upload it to quickly import your customers, territories, and sellers.
                        </p>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong><i class="bi bi-file-earmark-spreadsheet"></i> Supported Format:</strong>
                    CSV file with columns: Customer Name, Territory, Seller Name (and optionally TPID, POD, Vertical)
                </div>
                
                <p>Would you like to import your customer alignment now?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Skip for Now
                </button>
                <a href="{{ url_for('main.preferences') }}#import-section" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="bi bi-upload"></i> Import Customer Alignment
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Call Log Modal -->
<div class="modal fade" id="quickCallLogModal" tabindex="-1" aria-labelledby="quickCallLogModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickCallLogModalLabel">Create Call Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="customerSearch" class="form-label">Search for Customer</label>
                    <input type="text" class="form-control" id="customerSearch" placeholder="Start typing customer name..." autocomplete="off">
                    <small class="form-text text-muted">Type at least 2 characters to search</small>
                </div>
                <div id="customerResults" class="list-group"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // ===== DRAFT MANAGEMENT =====
    const DRAFT_KEY_PREFIX = 'notehelper_draft_';
    
    // Load drafts on page load
    function loadDrafts() {
        const drafts = [];
        
        // Find all drafts in localStorage
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith(DRAFT_KEY_PREFIX)) {
                try {
                    const draftData = JSON.parse(localStorage.getItem(key));
                    const customerId = key.replace(DRAFT_KEY_PREFIX, '');
                    
                    drafts.push({
                        key,
                        customerId,
                        customerName: draftData.customer_name || 'Unknown Customer',
                        data: draftData,
                        timestamp: draftData.timestamp || 0
                    });
                } catch (e) {
                    console.error('Error loading draft:', e);
                    // Invalid draft, remove it
                    localStorage.removeItem(key);
                }
            }
        }
        
        // Sort by timestamp (newest first)
        drafts.sort((a, b) => b.timestamp - a.timestamp);
        
        // Show/hide drafts section
        if (drafts.length > 0) {
            document.getElementById('draftsSection').style.display = 'block';
            document.getElementById('draftCount').textContent = drafts.length;
            
            // Render draft list
            const draftsList = document.getElementById('draftsList');
            draftsList.innerHTML = drafts.map(draft => {
                const date = new Date(draft.timestamp);
                const timeAgo = formatTimeAgo(date);
                const topicCount = draft.data.topics ? draft.data.topics.length : 0;
                
                return `
                    <a href="{{ url_for('call_logs.call_log_create') }}?customer_id=${draft.customerId}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    <i class="bi bi-building"></i> ${draft.customerName}
                                    <span class="badge bg-warning text-dark ms-2"><i class="bi bi-pencil"></i> Draft</span>
                                </h6>
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> ${timeAgo}
                                    ${topicCount > 0 ? `<span class="ms-2"><i class="bi bi-tag"></i> ${topicCount} topic${topicCount > 1 ? 's' : ''}</span>` : ''}
                                </small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteDraft(event, '${draft.key}', ${draft.customerId})" title="Delete draft">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </a>
                `;
            }).join('');
        } else {
            document.getElementById('draftsSection').style.display = 'none';
        }
    }
    
    function formatTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
        
        return date.toLocaleDateString();
    }
    
    function deleteDraft(event, draftKey, customerId) {
        event.preventDefault();
        event.stopPropagation();
        
        if (confirm('Delete this draft? This cannot be undone.')) {
            localStorage.removeItem(draftKey);
            loadDrafts();
        }
    }
    
    function clearAllDrafts() {
        if (confirm('Delete all drafts? This cannot be undone.')) {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(DRAFT_KEY_PREFIX)) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            loadDrafts();
        }
    }
    
    // Load drafts when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadDrafts();
        
        // Show first-time user modal if flag is set
        {% if show_first_time_modal %}
        const firstTimeModal = new bootstrap.Modal(document.getElementById('firstTimeModal'));
        firstTimeModal.show();
        
        // Dark mode toggle in first-time modal
        const firstTimeDarkModeSwitch = document.getElementById('firstTimeDarkModeSwitch');
        firstTimeDarkModeSwitch.addEventListener('change', function() {
            const darkMode = this.checked;
            
            fetch('/api/preferences/dark-mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ dark_mode: darkMode })
            })
            .then(response => response.json())
            .then(() => {
                // Update UI immediately
                document.documentElement.setAttribute('data-bs-theme', darkMode ? 'dark' : 'light');
            })
            .catch(error => {
                console.error('Error saving dark mode preference:', error);
            });
        });
        {% endif %}
    });
    
    // Reload drafts when storage changes (multi-tab support)
    window.addEventListener('storage', function(e) {
        if (e.key && e.key.startsWith(DRAFT_KEY_PREFIX)) {
            loadDrafts();
        }
    });
    
    // ===== CUSTOMER AUTOCOMPLETE =====
    // Customer autocomplete for quick call log creation
    let debounceTimer;
    const customerSearch = document.getElementById('customerSearch');
    const customerResults = document.getElementById('customerResults');
    const modal = document.getElementById('quickCallLogModal');

    // Focus input when modal opens
    modal.addEventListener('shown.bs.modal', function () {
        customerSearch.focus();
    });

    // Clear search when modal closes
    modal.addEventListener('hidden.bs.modal', function () {
        customerSearch.value = '';
        customerResults.innerHTML = '';
    });

    customerSearch.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();

        if (query.length < 2) {
            customerResults.innerHTML = '';
            return;
        }

        debounceTimer = setTimeout(async () => {
            try {
                const response = await fetch(`{{ url_for('customers.api_customers_autocomplete') }}?q=${encodeURIComponent(query)}`);
                const customers = await response.json();

                if (customers.length === 0) {
                    customerResults.innerHTML = '<div class="list-group-item text-muted">No customers found</div>';
                    return;
                }

                customerResults.innerHTML = customers.map(customer => {
                    const displayName = customer.nickname ? `${customer.name} (${customer.nickname})` : customer.name;
                    const tpidBadge = customer.tpid ? `<span class="badge bg-secondary ms-2">TPID: ${customer.tpid}</span>` : '';
                    return `
                        <a href="{{ url_for('call_logs.call_log_create') }}?customer_id=${customer.id}" class="list-group-item list-group-item-action">
                            <i class="bi bi-building"></i> ${displayName}${tpidBadge}
                        </a>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error fetching customers:', error);
                customerResults.innerHTML = '<div class="list-group-item text-danger">Error loading results</div>';
            }
        }, 300);
    });
</script>

{% endblock %}










