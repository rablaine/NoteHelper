{% extends "base.html" %}

{% block title %}Home - NoteHelper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="mb-4">
            <h1 class="mb-2">Welcome to NoteHelper</h1>
            <p class="lead mb-0">Track and manage your customer call notes efficiently.</p>
        </div>
    </div>
</div>

<style>
    .home-cta-button {
        border: 1px solid rgba(0, 0, 0, 0.15) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15) !important;
    }
    .home-cta-button:hover {
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2) !important;
        transform: translateY(-1px);
        transition: all 0.2s;
    }
    [data-bs-theme="dark"] .home-cta-button {
        border: 1px solid rgba(255, 255, 255, 0.15) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4) !important;
    }
    [data-bs-theme="dark"] .home-cta-button:hover {
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.5) !important;
    }
</style>

<div class="row mt-4">
    <div class="col-md-3">
        <a href="{{ url_for('call_logs.call_logs_list') }}" class="text-decoration-none">
            <div class="card text-center h-100" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body">
                    <i class="bi bi-telephone-fill text-primary" style="font-size: 3rem;"></i>
                    <h5 class="card-title mt-3">Call Logs</h5>
                    <p class="card-text text-muted">{{ stats.call_logs }} total</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('customers.customers_list') }}" class="text-decoration-none">
            <div class="card text-center h-100" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body">
                    <i class="bi bi-building text-success" style="font-size: 3rem;"></i>
                    <h5 class="card-title mt-3">Customers</h5>
                    <p class="card-text text-muted">{{ stats.customers }} total</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('sellers.sellers_list') }}" class="text-decoration-none">
            <div class="card text-center h-100" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body">
                    <i class="bi bi-people text-info" style="font-size: 3rem;"></i>
                    <h5 class="card-title mt-3">Sellers</h5>
                    <p class="card-text text-muted">{{ stats.sellers }} total</p>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('topics.topics_list') }}" class="text-decoration-none">
            <div class="card text-center h-100" style="cursor: pointer; transition: transform 0.2s;">
                <div class="card-body">
                    <i class="bi bi-tags text-warning" style="font-size: 3rem;"></i>
                    <h5 class="card-title mt-3">Topics</h5>
                    <p class="card-text text-muted">{{ stats.topics }} total</p>
                </div>
            </div>
        </a>
    </div>
</div>

<style>
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    html[data-bs-theme="dark"] .card:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    /* Calendar styles */
    #calendarTable {
        table-layout: fixed;
        width: 100%;
    }
    #calendarTable th,
    #calendarTable td {
        width: 14.28%;
        overflow: hidden;
    }
    #calendarTable td {
        transition: background-color 0.15s;
    }
    #calendarTable td:hover:not(.bg-light) {
        background-color: rgba(13, 110, 253, 0.05);
    }
    html[data-bs-theme="dark"] #calendarTable td.bg-light {
        background-color: rgba(255,255,255,0.03) !important;
    }
    .calendar-entries::-webkit-scrollbar {
        width: 4px;
    }
    .calendar-entries::-webkit-scrollbar-thumb {
        background-color: rgba(0,0,0,0.2);
        border-radius: 2px;
    }
    html[data-bs-theme="dark"] .calendar-entries::-webkit-scrollbar-thumb {
        background-color: rgba(255,255,255,0.2);
    }
    /* Customer color palette for calendar - 15 distinct colors */
    .cal-customer-1 { background-color: rgba(220, 53, 69, 0.3) !important; } /* Red */
    .cal-customer-2 { background-color: rgba(25, 135, 84, 0.35) !important; } /* Green */
    .cal-customer-3 { background-color: rgba(13, 110, 253, 0.3) !important; } /* Blue */
    .cal-customer-4 { background-color: rgba(255, 193, 7, 0.4) !important; } /* Yellow */
    .cal-customer-5 { background-color: rgba(111, 66, 193, 0.35) !important; } /* Purple */
    .cal-customer-6 { background-color: rgba(253, 126, 20, 0.35) !important; } /* Orange */
    .cal-customer-7 { background-color: rgba(214, 51, 132, 0.3) !important; } /* Pink */
    .cal-customer-8 { background-color: rgba(13, 202, 240, 0.3) !important; } /* Cyan */
    .cal-customer-9 { background-color: rgba(102, 16, 242, 0.3) !important; } /* Indigo */
    .cal-customer-10 { background-color: rgba(32, 201, 151, 0.35) !important; } /* Teal */
    .cal-customer-11 { background-color: rgba(165, 42, 42, 0.35) !important; } /* Brown */
    .cal-customer-12 { background-color: rgba(0, 128, 128, 0.35) !important; } /* Dark Teal */
    .cal-customer-13 { background-color: rgba(255, 99, 71, 0.35) !important; } /* Tomato */
    .cal-customer-14 { background-color: rgba(75, 0, 130, 0.3) !important; } /* Dark Indigo */
    .cal-customer-15 { background-color: rgba(184, 134, 11, 0.4) !important; } /* Dark Gold */
    /* Highlight state for same-customer entries */
    .cal-customer-1.cal-highlight { background-color: rgba(220, 53, 69, 0.7) !important; box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.8); }
    .cal-customer-2.cal-highlight { background-color: rgba(25, 135, 84, 0.7) !important; box-shadow: 0 0 0 2px rgba(25, 135, 84, 0.8); }
    .cal-customer-3.cal-highlight { background-color: rgba(13, 110, 253, 0.7) !important; box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.8); }
    .cal-customer-4.cal-highlight { background-color: rgba(255, 193, 7, 0.75) !important; box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.9); }
    .cal-customer-5.cal-highlight { background-color: rgba(111, 66, 193, 0.7) !important; box-shadow: 0 0 0 2px rgba(111, 66, 193, 0.8); }
    .cal-customer-6.cal-highlight { background-color: rgba(253, 126, 20, 0.7) !important; box-shadow: 0 0 0 2px rgba(253, 126, 20, 0.8); }
    .cal-customer-7.cal-highlight { background-color: rgba(214, 51, 132, 0.7) !important; box-shadow: 0 0 0 2px rgba(214, 51, 132, 0.8); }
    .cal-customer-8.cal-highlight { background-color: rgba(13, 202, 240, 0.7) !important; box-shadow: 0 0 0 2px rgba(13, 202, 240, 0.8); }
    .cal-customer-9.cal-highlight { background-color: rgba(102, 16, 242, 0.7) !important; box-shadow: 0 0 0 2px rgba(102, 16, 242, 0.8); }
    .cal-customer-10.cal-highlight { background-color: rgba(32, 201, 151, 0.7) !important; box-shadow: 0 0 0 2px rgba(32, 201, 151, 0.8); }
    .cal-customer-11.cal-highlight { background-color: rgba(165, 42, 42, 0.7) !important; box-shadow: 0 0 0 2px rgba(165, 42, 42, 0.8); }
    .cal-customer-12.cal-highlight { background-color: rgba(0, 128, 128, 0.7) !important; box-shadow: 0 0 0 2px rgba(0, 128, 128, 0.8); }
    .cal-customer-13.cal-highlight { background-color: rgba(255, 99, 71, 0.7) !important; box-shadow: 0 0 0 2px rgba(255, 99, 71, 0.8); }
    .cal-customer-14.cal-highlight { background-color: rgba(75, 0, 130, 0.7) !important; box-shadow: 0 0 0 2px rgba(75, 0, 130, 0.8); }
    .cal-customer-15.cal-highlight { background-color: rgba(184, 134, 11, 0.75) !important; box-shadow: 0 0 0 2px rgba(184, 134, 11, 0.9); }
    
    [data-customer-id] { cursor: pointer; transition: all 0.15s ease; }
    .cal-add-btn { opacity: 0.3; transition: opacity 0.15s; font-size: 0.85rem; }
    .cal-add-btn:hover { opacity: 1; color: var(--bs-primary) !important; }
    .cal-fill-btn { opacity: 0.3; transition: opacity 0.15s; font-size: 0.85rem; }
    .cal-fill-btn:hover { opacity: 1; color: var(--bs-warning) !important; }
    #calendarTable td:hover .cal-add-btn { opacity: 0.7; }
    #calendarTable td:hover .cal-fill-btn { opacity: 0.7; }
    /* Milestone calendar styles */
    #msCalendarTable {
        table-layout: fixed;
        width: 100%;
    }
    #msCalendarTable th,
    #msCalendarTable td {
        width: 14.28%;
        overflow: hidden;
    }
    #msCalendarTable td {
        transition: background-color 0.15s;
    }
    .ms-cal-entry {
        font-size: 0.72rem;
        line-height: 1.3;
        cursor: pointer;
        transition: all 0.15s;
    }
    .ms-cal-entry:hover {
        opacity: 0.85;
    }
    .ms-status-ontrack { border-left: 3px solid #198754; }
    .ms-status-atrisk  { border-left: 3px solid #ffc107; }
    .ms-status-blocked  { border-left: 3px solid #dc3545; }
</style>

<div class="row mt-4" id="draftsSection" style="display: none;">
    <div class="col-md-12">
        <div class="alert alert-warning d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-pencil-square"></i> <strong>Unsaved Drafts</strong>
                <span id="draftCount" class="badge bg-warning text-dark ms-2">0</span>
            </div>
            <button type="button" class="btn btn-sm btn-outline-warning" onclick="clearAllDrafts()">
                <i class="bi bi-trash"></i> Clear All Drafts
            </button>
        </div>
        <div id="draftsList" class="list-group mb-3"></div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="mb-0">Recent Call Logs</h3>
            <ul class="nav nav-pills" id="callLogViewTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="list-tab" data-bs-toggle="pill" data-bs-target="#list-view" type="button" role="tab" aria-controls="list-view" aria-selected="true">
                        <i class="bi bi-list-ul"></i> List
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="calendar-tab" data-bs-toggle="pill" data-bs-target="#calendar-view" type="button" role="tab" aria-controls="calendar-view" aria-selected="false">
                        <i class="bi bi-calendar3"></i> Calendar
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="milestones-tab" data-bs-toggle="pill" data-bs-target="#milestones-view" type="button" role="tab" aria-controls="milestones-view" aria-selected="false">
                        <i class="bi bi-flag-fill"></i> Milestones
                    </button>
                </li>
            </ul>
        </div>
        
        <div class="tab-content" id="callLogViewTabContent">
            <!-- List View Tab -->
            <div class="tab-pane fade show active" id="list-view" role="tabpanel" aria-labelledby="list-tab">
                {% if recent_calls %}
                    <div class="list-group">
                        {% for call in recent_calls %}
                            <div class="list-group-item list-group-item-action" style="cursor: pointer;" onclick="window.location.href='{{ url_for('call_logs.call_log_view', id=call.id) }}';">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">
                                        <a href="{{ url_for('customers.customer_view', id=call.customer.id) }}" class="text-decoration-none" onclick="event.stopPropagation();">
                                            {{ call.customer.name }}
                                        </a>
                                    </h5>
                                    <small class="text-muted">{{ call.call_date.strftime('%b %d, %Y') }}{% if call.call_date.hour != 0 or call.call_date.minute != 0 %} {{ call.call_date.strftime('%I:%M %p') }}{% endif %}</small>
                                </div>
                                <div class="mb-2">
                                    {% if call.seller %}
                                        <a href="{{ url_for('sellers.seller_view', id=call.seller.id) }}" class="badge {{ get_seller_color(call.seller.id) }} text-decoration-none" onclick="event.stopPropagation();"><i class="bi bi-person"></i> {{ call.seller.name }}</a>
                                    {% endif %}
                                    {% if call.territory %}
                                        <a href="{{ url_for('territories.territory_view', id=call.territory.id) }}" class="badge bg-info text-dark text-decoration-none" onclick="event.stopPropagation();"><i class="bi bi-geo-alt"></i> {{ call.territory.name }}</a>
                                    {% endif %}
                                    {% for topic in call.topics %}
                                        <a href="{{ url_for('topics.topic_view', id=topic.id) }}" class="badge bg-warning text-dark text-decoration-none" onclick="event.stopPropagation();"><i class="bi bi-tag"></i> {{ topic.name }}</a>
                                    {% endfor %}
                                    {% for partner in call.partners %}
                                        <a href="{{ url_for('partners.partner_view', id=partner.id) }}" class="badge text-decoration-none" style="background-color: #6f42c1;" onclick="event.stopPropagation();"><i class="bi bi-building"></i> {{ partner.name }}</a>
                                    {% endfor %}
                                    {% for milestone in call.milestones %}
                                        <a href="{{ url_for('milestones.milestone_view', id=milestone.id) }}" class="badge bg-success text-decoration-none" title="{{ milestone.display_text }}" onclick="event.stopPropagation();"><i class="bi bi-flag"></i> {{ milestone.display_text[:25] }}{% if milestone.display_text|length > 25 %}...{% endif %}</a>
                                    {% endfor %}
                                    {% for task in call.msx_tasks %}
                                        {% if task.msx_task_url %}
                                        <a href="{{ task.msx_task_url }}" target="_blank" class="badge bg-secondary text-decoration-none" title="{{ task.subject }}" onclick="event.stopPropagation();"><i class="bi bi-check2-circle"></i> {{ task.subject[:20] }}{% if task.subject|length > 20 %}...{% endif %} <i class="bi bi-box-arrow-up-right"></i></a>
                                        {% else %}
                                        <span class="badge bg-secondary" title="{{ task.subject }}"><i class="bi bi-check2-circle"></i> {{ task.subject[:20] }}{% if task.subject|length > 20 %}...{% endif %}</span>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <div class="text-muted">{{ call.content|striptags|truncate(200, true) }}</div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> No call logs yet. Use the <strong>New Call Log</strong> button in the navigation bar to get started!
                    </div>
                {% endif %}
            </div>
            
            <!-- Calendar View Tab -->
            <div class="tab-pane fade" id="calendar-view" role="tabpanel" aria-labelledby="calendar-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <button class="btn btn-outline-secondary btn-sm" id="prevMonthBtn">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <h5 class="mb-0" id="calendarTitle">Loading...</h5>
                        <button class="btn btn-outline-secondary btn-sm" id="nextMonthBtn">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-bordered mb-0" id="calendarTable">
                            <thead>
                                <tr class="text-center">
                                    <th>Mon</th>
                                    <th>Tue</th>
                                    <th>Wed</th>
                                    <th>Thu</th>
                                    <th>Fri</th>
                                </tr>
                            </thead>
                                <tbody id="calendarBody">
                                    <!-- Calendar cells will be rendered here -->
                                </tbody>
                            </table>
                    </div>
                    <div class="card-footer text-center">
                        <button class="btn btn-outline-primary btn-sm" id="todayBtn">
                            <i class="bi bi-calendar-day"></i> Today
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Milestones Calendar Tab -->
            <div class="tab-pane fade" id="milestones-view" role="tabpanel" aria-labelledby="milestones-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <button class="btn btn-outline-secondary btn-sm" id="msPrevMonthBtn">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <h5 class="mb-0" id="msCalendarTitle">Loading...</h5>
                        <button class="btn btn-outline-secondary btn-sm" id="msNextMonthBtn">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <table class="table table-bordered mb-0" id="msCalendarTable">
                            <thead>
                                <tr class="text-center">
                                    <th>Sun</th>
                                    <th>Mon</th>
                                    <th>Tue</th>
                                    <th>Wed</th>
                                    <th>Thu</th>
                                    <th>Fri</th>
                                    <th>Sat</th>
                                </tr>
                            </thead>
                            <tbody id="msCalendarBody">
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <a href="{{ url_for('milestones.milestone_tracker') }}" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-flag-fill"></i> Full Tracker
                        </a>
                        <button class="btn btn-outline-primary btn-sm" id="msTodayBtn">
                            <i class="bi bi-calendar-day"></i> Today
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- First-Time User Welcome Modal -->
{% if show_first_time_modal %}
<div class="modal fade" id="firstTimeModal" tabindex="-1" aria-labelledby="firstTimeModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="firstTimeModalLabel">
                    <i class="bi bi-rocket"></i> Welcome to NoteHelper!
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="lead">Thanks for signing up! Let's get you started.</p>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-moon-stars text-primary"></i> Personalize Your Experience</h6>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <strong>Dark Mode</strong>
                                <p class="text-muted mb-0 small">Easy on the eyes for extended use</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="firstTimeDarkModeSwitch" style="width: 3em; height: 1.5em;">
                            </div>
                        </div>
                        <small class="text-muted">You can change this anytime in Settings.</small>
                    </div>
                </div>
                
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title"><i class="bi bi-info-circle text-primary"></i> Quick Start Tip</h6>
                        <p class="card-text mb-0">
                            If you have an existing customer alignment spreadsheet, you can upload it to quickly import your customers, territories, and sellers.
                        </p>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong><i class="bi bi-file-earmark-spreadsheet"></i> Supported Format:</strong>
                    CSV file with columns: Customer Name, Territory, Seller Name (and optionally TPID, POD, Vertical)
                </div>
                
                <p>Would you like to import your customer alignment now?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Skip for Now
                </button>
                <a href="{{ url_for('main.preferences') }}#import-section" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="bi bi-upload"></i> Import Customer Alignment
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Create Customer Picker Modal -->
<div class="modal fade" id="quickCreateModal" tabindex="-1" aria-labelledby="quickCreateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="quickCreateModalLabel">
                    <i class="bi bi-plus-circle"></i> New Call Log for <span id="quickCreateDate"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Select a customer to create a call log:</p>
                <input type="text" class="form-control mb-3" id="quickCreateSearch" placeholder="Search customers...">
                <div class="list-group" id="quickCreateCustomerList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Customer list will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ===== QUICK CREATE FROM CALENDAR =====
    let quickCreateDate = null;
    let quickCreateModal = null;
    
    function openQuickCreateModal(dateStr) {
        // Lazily initialize modal
        if (!quickCreateModal) {
            quickCreateModal = new bootstrap.Modal(document.getElementById('quickCreateModal'));
        }
        quickCreateDate = dateStr;
        // Format date for display
        const dateObj = new Date(dateStr + 'T00:00:00');
        const options = { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' };
        document.getElementById('quickCreateDate').textContent = dateObj.toLocaleDateString('en-US', options);
        
        // Load customers
        loadQuickCreateCustomers();
        quickCreateModal.show();
        
        // Focus search after modal opens
        document.getElementById('quickCreateModal').addEventListener('shown.bs.modal', function() {
            document.getElementById('quickCreateSearch').focus();
        }, { once: true });
    }
    
    function loadQuickCreateCustomers() {
        const listEl = document.getElementById('quickCreateCustomerList');
        listEl.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm"></div> Loading...</div>';
        
        fetch('/api/customers')
            .then(r => r.json())
            .then(customers => {
                renderQuickCreateCustomers(customers);
            })
            .catch(err => {
                listEl.innerHTML = '<div class="alert alert-danger">Error loading customers</div>';
            });
    }
    
    function renderQuickCreateCustomers(customers, filter = '') {
        const listEl = document.getElementById('quickCreateCustomerList');
        listEl.innerHTML = '';
        
        const filtered = filter 
            ? customers.filter(c => c.name.toLowerCase().includes(filter.toLowerCase()))
            : customers;
        
        if (filtered.length === 0) {
            listEl.innerHTML = '<div class="text-muted text-center py-3">No customers found</div>';
            return;
        }
        
        filtered.forEach(customer => {
            const item = document.createElement('a');
            item.href = `/call-log/new?customer_id=${customer.id}&date=${quickCreateDate}`;
            item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
            item.innerHTML = `
                <div>
                    <strong>${customer.name}</strong>
                    ${customer.territory ? `<small class="text-muted ms-2"><i class="bi bi-geo-alt"></i> ${customer.territory}</small>` : ''}
                </div>
                <i class="bi bi-chevron-right text-muted"></i>
            `;
            listEl.appendChild(item);
        });
        
        // Store for filtering
        listEl._allCustomers = customers;
    }
    
    // Search filter
    document.getElementById('quickCreateSearch').addEventListener('input', function(e) {
        const listEl = document.getElementById('quickCreateCustomerList');
        if (listEl._allCustomers) {
            renderQuickCreateCustomers(listEl._allCustomers, e.target.value);
        }
    });
    
    // Clear search when modal closes
    document.getElementById('quickCreateModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('quickCreateSearch').value = '';
    });
    
    // ===== DRAFT MANAGEMENT =====
    const DRAFT_KEY_PREFIX = 'notehelper_draft_';
    
    // Load drafts on page load
    function loadDrafts() {
        const drafts = [];
        
        // Find all drafts in localStorage
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith(DRAFT_KEY_PREFIX)) {
                try {
                    const draftData = JSON.parse(localStorage.getItem(key));
                    const customerId = key.replace(DRAFT_KEY_PREFIX, '');
                    
                    drafts.push({
                        key,
                        customerId,
                        customerName: draftData.customer_name || 'Unknown Customer',
                        data: draftData,
                        timestamp: draftData.timestamp || 0
                    });
                } catch (e) {
                    console.error('Error loading draft:', e);
                    // Invalid draft, remove it
                    localStorage.removeItem(key);
                }
            }
        }
        
        // Sort by timestamp (newest first)
        drafts.sort((a, b) => b.timestamp - a.timestamp);
        
        // Show/hide drafts section
        if (drafts.length > 0) {
            document.getElementById('draftsSection').style.display = 'block';
            document.getElementById('draftCount').textContent = drafts.length;
            
            // Render draft list
            const draftsList = document.getElementById('draftsList');
            draftsList.innerHTML = drafts.map(draft => {
                const date = new Date(draft.timestamp);
                const timeAgo = formatTimeAgo(date);
                const topicCount = draft.data.topics ? draft.data.topics.length : 0;
                
                return `
                    <a href="{{ url_for('call_logs.call_log_create') }}?customer_id=${draft.customerId}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    <i class="bi bi-building"></i> ${draft.customerName}
                                    <span class="badge bg-warning text-dark ms-2"><i class="bi bi-pencil"></i> Draft</span>
                                </h6>
                                <small class="text-muted">
                                    <i class="bi bi-clock"></i> ${timeAgo}
                                    ${topicCount > 0 ? `<span class="ms-2"><i class="bi bi-tag"></i> ${topicCount} topic${topicCount > 1 ? 's' : ''}</span>` : ''}
                                </small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteDraft(event, '${draft.key}', ${draft.customerId})" title="Delete draft">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </a>
                `;
            }).join('');
        } else {
            document.getElementById('draftsSection').style.display = 'none';
        }
    }
    
    function formatTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)} min ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)} days ago`;
        
        return date.toLocaleDateString();
    }
    
    function deleteDraft(event, draftKey, customerId) {
        event.preventDefault();
        event.stopPropagation();
        
        if (confirm('Delete this draft? This cannot be undone.')) {
            localStorage.removeItem(draftKey);
            loadDrafts();
        }
    }
    
    function clearAllDrafts() {
        if (confirm('Delete all drafts? This cannot be undone.')) {
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(DRAFT_KEY_PREFIX)) {
                    keysToRemove.push(key);
                }
            }
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            loadDrafts();
        }
    }
    
    // Load drafts when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadDrafts();
        
        // Show first-time user modal if flag is set
        {% if show_first_time_modal %}
        const firstTimeModal = new bootstrap.Modal(document.getElementById('firstTimeModal'));
        firstTimeModal.show();
        
        // Dark mode toggle in first-time modal
        const firstTimeDarkModeSwitch = document.getElementById('firstTimeDarkModeSwitch');
        firstTimeDarkModeSwitch.addEventListener('change', function() {
            const darkMode = this.checked;
            
            fetch('/api/preferences/dark-mode', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ dark_mode: darkMode })
            })
            .then(response => response.json())
            .then(() => {
                // Update UI immediately
                document.documentElement.setAttribute('data-bs-theme', darkMode ? 'dark' : 'light');
            })
            .catch(error => {
                console.error('Error saving dark mode preference:', error);
            });
        });
        {% endif %}
    });
    
    // Reload drafts when storage changes (multi-tab support)
    window.addEventListener('storage', function(e) {
        if (e.key && e.key.startsWith(DRAFT_KEY_PREFIX)) {
            loadDrafts();
        }
    });
    
    // ===== CALENDAR VIEW =====
    let calendarYear = new Date().getFullYear();
    let calendarMonth = new Date().getMonth() + 1; // 1-indexed
    let calendarLoaded = false;
    
    // Tab persistence with localStorage
    const TAB_STORAGE_KEY = 'notehelper_home_tab';
    
    // Apply saved tab after Bootstrap is loaded
    window.addEventListener('DOMContentLoaded', function() {
        const savedTab = localStorage.getItem(TAB_STORAGE_KEY);
        if (savedTab === 'calendar') {
            const calendarTabEl = document.getElementById('calendar-tab');
            const calendarTab = new bootstrap.Tab(calendarTabEl);
            calendarTab.show();
        } else if (savedTab === 'milestones') {
            const msTabEl = document.getElementById('milestones-tab');
            const msTab = new bootstrap.Tab(msTabEl);
            msTab.show();
        }
    });
    
    // Save tab selection when changed
    document.getElementById('list-tab').addEventListener('shown.bs.tab', function() {
        localStorage.setItem(TAB_STORAGE_KEY, 'list');
    });
    
    // Load calendar when tab is shown
    document.getElementById('calendar-tab').addEventListener('shown.bs.tab', function() {
        localStorage.setItem(TAB_STORAGE_KEY, 'calendar');
        if (!calendarLoaded) {
            loadCalendar(calendarYear, calendarMonth);
            calendarLoaded = true;
        }
    });
    
    // Month navigation
    document.getElementById('prevMonthBtn').addEventListener('click', function() {
        if (calendarMonth === 1) {
            calendarMonth = 12;
            calendarYear--;
        } else {
            calendarMonth--;
        }
        loadCalendar(calendarYear, calendarMonth);
    });
    
    document.getElementById('nextMonthBtn').addEventListener('click', function() {
        if (calendarMonth === 12) {
            calendarMonth = 1;
            calendarYear++;
        } else {
            calendarMonth++;
        }
        loadCalendar(calendarYear, calendarMonth);
    });
    
    document.getElementById('todayBtn').addEventListener('click', function() {
        const now = new Date();
        calendarYear = now.getFullYear();
        calendarMonth = now.getMonth() + 1;
        loadCalendar(calendarYear, calendarMonth);
    });
    
    function loadCalendar(year, month) {
        const calendarBody = document.getElementById('calendarBody');
        const calendarTitle = document.getElementById('calendarTitle');
        
        // Show loading state
        calendarBody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border spinner-border-sm" role="status"></div> Loading...</td></tr>';
        
        fetch(`/api/call-logs/calendar?year=${year}&month=${month}`)
            .then(response => response.json())
            .then(data => {
                calendarTitle.textContent = `${data.month_name} ${data.year}`;
                renderCalendar(data);
            })
            .catch(error => {
                console.error('Error loading calendar:', error);
                calendarBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-danger">Error loading calendar</td></tr>';
            });
    }
    
    function renderCalendar(data) {
        const calendarBody = document.getElementById('calendarBody');
        calendarBody.innerHTML = '';
        
        const days = data.days || {};
        const daysInMonth = data.days_in_month;
        const todayDay = data.today_day;
        
        // Helper to escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Build a map of customer_id -> color index for THIS month only
        const customerColorMap = {};
        const allCustomerIds = new Set();
        Object.values(days).forEach(logs => {
            logs.forEach(log => allCustomerIds.add(log.customer_id));
        });
        const customerList = Array.from(allCustomerIds);
        customerList.forEach((id, index) => {
            customerColorMap[id] = (index % 15) + 1;
        });
        
        // Build array of weekday info for the month
        // firstWeekday: 0=Sun, 1=Mon, ..., 6=Sat
        // We want Mon-Fri only (columns 0-4 = Mon-Fri)
        const weekdayDays = []; // Array of {dayNum, column} for weekdays only
        for (let d = 1; d <= daysInMonth; d++) {
            // Calculate day of week for this date
            const dateObj = new Date(data.year, data.month - 1, d);
            const dow = dateObj.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
            if (dow >= 1 && dow <= 5) { // Mon-Fri
                weekdayDays.push({ dayNum: d, column: dow - 1 }); // column 0-4
            }
        }
        
        // Build calendar rows (each row = Mon-Fri)
        let dayIndex = 0;
        while (dayIndex < weekdayDays.length) {
            const row = document.createElement('tr');
            
            for (let col = 0; col < 5; col++) {
                const cell = document.createElement('td');
                cell.className = 'p-1';
                cell.style.verticalAlign = 'top';
                cell.style.height = '100px';
                
                // Check if we have a day for this column in this week
                if (dayIndex < weekdayDays.length && weekdayDays[dayIndex].column === col) {
                    // This cell has content
                    const dayNum = weekdayDays[dayIndex].dayNum;
                    
                    // Day number header
                    const dayHeader = document.createElement('div');
                    dayHeader.className = 'd-flex justify-content-between align-items-center mb-1';
                    
                    const dayNumber = document.createElement('span');
                    dayNumber.className = 'fw-bold';
                    if (dayNum === todayDay) {
                        dayNumber.innerHTML = `<span class="badge bg-primary rounded-circle">${dayNum}</span>`;
                    } else {
                        dayNumber.textContent = dayNum;
                    }
                    dayHeader.appendChild(dayNumber);
                    
                    // Build date string for this day
                    const dateStr = `${data.year}-${String(data.month).padStart(2, '0')}-${String(dayNum).padStart(2, '0')}`;
                    
                    // Add icons container (right side)
                    const iconsContainer = document.createElement('span');
                    iconsContainer.className = 'd-flex gap-1';
                    
                    // Add "Fill My Day" button (lightning bolt)
                    const fillBtn = document.createElement('a');
                    fillBtn.href = `/fill-my-day?date=${dateStr}`;
                    fillBtn.className = 'text-muted text-decoration-none cal-fill-btn';
                    fillBtn.innerHTML = '<i class="bi bi-lightning-charge"></i>';
                    fillBtn.title = 'Fill My Day - bulk import meetings';
                    iconsContainer.appendChild(fillBtn);
                    
                    // Add "+" button for quick create
                    const addBtn = document.createElement('a');
                    addBtn.href = '#';
                    addBtn.className = 'text-muted text-decoration-none cal-add-btn';
                    addBtn.innerHTML = '<i class="bi bi-plus-circle"></i>';
                    addBtn.title = 'New call log';
                    addBtn.setAttribute('data-date', dateStr);
                    addBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        openQuickCreateModal(dateStr);
                    });
                    iconsContainer.appendChild(addBtn);
                    
                    dayHeader.appendChild(iconsContainer);
                    
                    cell.appendChild(dayHeader);
                    
                    // Call log entries for this day
                    const callLogs = days[dayNum] || [];
                    if (callLogs.length > 0) {
                        const entriesContainer = document.createElement('div');
                        entriesContainer.className = 'calendar-entries';
                        entriesContainer.style.fontSize = '0.75rem';
                        entriesContainer.style.maxHeight = '70px';
                        entriesContainer.style.overflowY = 'auto';
                        
                        callLogs.forEach(log => {
                            const entry = document.createElement('a');
                            entry.href = `/call-log/${log.id}`;
                            const colorIndex = customerColorMap[log.customer_id];
                            entry.className = `d-block text-decoration-none text-truncate mb-1 px-1 rounded cal-customer-${colorIndex}`;
                            entry.style.color = 'inherit';
                            
                            // Build entry content with indicators
                            let indicators = '';
                            if (log.has_milestone) {
                                indicators += '<i class="bi bi-flag-fill text-success" title="Has milestone"></i> ';
                            }
                            if (log.has_task) {
                                indicators += '<i class="bi bi-check2-square text-info" title="Has task"></i> ';
                            }
                            if (log.has_hok) {
                                indicators += '<i class="bi bi-keyboard text-warning" title="HOK task"></i> ';
                            }
                            let timePrefix = log.time ? `<small class="text-muted">${escapeHtml(log.time)}</small> ` : '';
                            entry.innerHTML = indicators + timePrefix + escapeHtml(log.customer_name);
                            entry.title = (log.time ? log.time + ' - ' : '') + log.customer_name + (log.has_milestone ? ' (Milestone)' : '') + (log.has_task ? ' (Task)' : '') + (log.has_hok ? ' (HOK)' : '');
                            entry.setAttribute('data-customer-id', log.customer_id);
                            
                            // Hover: highlight all entries for this customer
                            entry.addEventListener('mouseenter', function() {
                                document.querySelectorAll(`[data-customer-id="${log.customer_id}"]`).forEach(el => {
                                    el.classList.add('cal-highlight');
                                });
                            });
                            entry.addEventListener('mouseleave', function() {
                                document.querySelectorAll(`[data-customer-id="${log.customer_id}"]`).forEach(el => {
                                    el.classList.remove('cal-highlight');
                                });
                            });
                            
                            entriesContainer.appendChild(entry);
                        });
                        
                        cell.appendChild(entriesContainer);
                    }
                    
                    dayIndex++;
                } else {
                    // Empty cell (day not in this week's column)
                    cell.classList.add('bg-light');
                    if (document.documentElement.getAttribute('data-bs-theme') === 'dark') {
                        cell.style.backgroundColor = 'rgba(255,255,255,0.03)';
                    }
                }
                
                row.appendChild(cell);
            }
            
            calendarBody.appendChild(row);
        }
    }

    // ===== MILESTONE CALENDAR VIEW =====
    let msCalYear = new Date().getFullYear();
    let msCalMonth = new Date().getMonth() + 1;
    let msCalLoaded = false;

    // Load milestone calendar when tab is shown
    document.getElementById('milestones-tab').addEventListener('shown.bs.tab', function() {
        localStorage.setItem(TAB_STORAGE_KEY, 'milestones');
        if (!msCalLoaded) {
            loadMsCalendar(msCalYear, msCalMonth);
            msCalLoaded = true;
        }
    });

    // Month navigation
    document.getElementById('msPrevMonthBtn').addEventListener('click', function() {
        if (msCalMonth === 1) { msCalMonth = 12; msCalYear--; }
        else { msCalMonth--; }
        loadMsCalendar(msCalYear, msCalMonth);
    });
    document.getElementById('msNextMonthBtn').addEventListener('click', function() {
        if (msCalMonth === 12) { msCalMonth = 1; msCalYear++; }
        else { msCalMonth++; }
        loadMsCalendar(msCalYear, msCalMonth);
    });
    document.getElementById('msTodayBtn').addEventListener('click', function() {
        const now = new Date();
        msCalYear = now.getFullYear();
        msCalMonth = now.getMonth() + 1;
        loadMsCalendar(msCalYear, msCalMonth);
    });

    function loadMsCalendar(year, month) {
        const body = document.getElementById('msCalendarBody');
        const title = document.getElementById('msCalendarTitle');
        body.innerHTML = '<tr><td colspan="7" class="text-center py-4"><div class="spinner-border spinner-border-sm"></div> Loading...</td></tr>';

        fetch(`/api/milestones/calendar?year=${year}&month=${month}`)
            .then(r => r.json())
            .then(data => {
                title.textContent = `${data.month_name} ${data.year}`;
                renderMsCalendar(data);
            })
            .catch(err => {
                console.error('Error loading milestone calendar:', err);
                body.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-danger">Error loading calendar</td></tr>';
            });
    }

    function renderMsCalendar(data) {
        const body = document.getElementById('msCalendarBody');
        body.innerHTML = '';

        const days = data.days || {};
        const daysInMonth = data.days_in_month;
        const todayDay = data.today_day;

        function escapeHtml(text) {
            if (!text) return '';
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }

        // Build color map for customers this month
        const customerColorMap = {};
        const allIds = new Set();
        Object.values(days).forEach(items => items.forEach(m => allIds.add(m.customer_id)));
        Array.from(allIds).forEach((id, i) => { customerColorMap[id] = (i % 15) + 1; });

        // First day of month: 0=Sun ... 6=Sat (full 7-day week)
        const firstDow = new Date(data.year, data.month - 1, 1).getDay();

        let dayNum = 1;
        let started = false;

        while (dayNum <= daysInMonth) {
            const row = document.createElement('tr');

            for (let col = 0; col < 7; col++) {
                const cell = document.createElement('td');
                cell.className = 'p-1';
                cell.style.verticalAlign = 'top';
                cell.style.height = '100px';

                if ((!started && col < firstDow) || dayNum > daysInMonth) {
                    // Empty cell
                    cell.classList.add('bg-light');
                } else {
                    started = true;
                    const d = dayNum;

                    // Day number
                    const header = document.createElement('div');
                    header.className = 'd-flex justify-content-between align-items-center mb-1';
                    const numEl = document.createElement('span');
                    numEl.className = 'fw-bold small';
                    if (d === todayDay) {
                        numEl.innerHTML = `<span class="badge bg-primary rounded-circle">${d}</span>`;
                    } else {
                        numEl.textContent = d;
                    }
                    header.appendChild(numEl);

                    // Milestone count badge
                    const msForDay = days[d] || [];
                    if (msForDay.length > 0) {
                        const countBadge = document.createElement('span');
                        countBadge.className = 'badge bg-success rounded-pill';
                        countBadge.style.fontSize = '0.65rem';
                        countBadge.textContent = msForDay.length;
                        header.appendChild(countBadge);
                    }
                    cell.appendChild(header);

                    // Milestone entries
                    if (msForDay.length > 0) {
                        const container = document.createElement('div');
                        container.style.maxHeight = '72px';
                        container.style.overflowY = 'auto';
                        container.className = 'calendar-entries';

                        msForDay.forEach(ms => {
                            const entry = document.createElement('a');
                            entry.href = ms.url || '#';
                            if (ms.url) entry.target = '_blank';
                            const statusClass = ms.status === 'On Track' ? 'ms-status-ontrack'
                                : ms.status === 'At Risk' ? 'ms-status-atrisk' : 'ms-status-blocked';
                            const colorIdx = customerColorMap[ms.customer_id] || 1;
                            entry.className = `d-block text-decoration-none text-truncate mb-1 px-1 rounded ms-cal-entry ${statusClass} cal-customer-${colorIdx}`;
                            entry.style.color = 'inherit';

                            let label = '';
                            if (ms.on_my_team) {
                                label += '<i class="bi bi-people-fill text-primary" style="font-size:.7em"></i> ';
                            }
                            label += escapeHtml(ms.customer_name);
                            if (ms.monthly_usage) {
                                label += ` <span class="text-muted">$${Number(ms.monthly_usage).toLocaleString()}</span>`;
                            }
                            entry.innerHTML = label;

                            let tip = ms.customer_name + '  ' + escapeHtml(ms.title);
                            if (ms.seller_name) tip += ' (' + ms.seller_name + ')';
                            if (ms.status) tip += ' [' + ms.status + ']';
                            entry.title = tip;

                            // Highlight all entries for same customer on hover
                            entry.setAttribute('data-customer-id', ms.customer_id);
                            entry.addEventListener('mouseenter', function() {
                                document.querySelectorAll(`#msCalendarBody [data-customer-id="${ms.customer_id}"]`)
                                    .forEach(el => el.classList.add('cal-highlight'));
                            });
                            entry.addEventListener('mouseleave', function() {
                                document.querySelectorAll(`#msCalendarBody [data-customer-id="${ms.customer_id}"]`)
                                    .forEach(el => el.classList.remove('cal-highlight'));
                            });

                            container.appendChild(entry);
                        });
                        cell.appendChild(container);
                    }

                    dayNum++;
                }
                row.appendChild(cell);
            }
            body.appendChild(row);
        }
    }
</script>

{% endblock %}










