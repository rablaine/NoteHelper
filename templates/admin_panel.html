{% extends "base.html" %}

{% block title %}Admin Panel - NoteHelper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="bi bi-shield-lock"></i> Admin Panel</h1>
        
        <!-- System Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> System Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('call_logs.call_logs_list') }}" class="text-decoration-none">
                            <h3 class="text-success">{{ stats.total_call_logs }}</h3>
                            <small class="text-muted">Call Logs</small>
                        </a>
                    </div>
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('customers.customers_list') }}" class="text-decoration-none">
                            <h3 class="text-info">{{ stats.total_customers }}</h3>
                            <small class="text-muted">Customers</small>
                        </a>
                    </div>
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('sellers.sellers_list') }}" class="text-decoration-none">
                            <h3>{{ stats.total_sellers }}</h3>
                            <small class="text-muted">Sellers</small>
                        </a>
                    </div>
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('territories.territories_list') }}" class="text-decoration-none">
                            <h3>{{ stats.total_territories }}</h3>
                            <small class="text-muted">Territories</small>
                        </a>
                    </div>
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('topics.topics_list') }}" class="text-decoration-none">
                            <h3>{{ stats.total_topics }}</h3>
                            <small class="text-muted">Topics</small>
                        </a>
                    </div>
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('pods.pods_list') }}" class="text-decoration-none">
                            <h3>{{ stats.total_pods }}</h3>
                            <small class="text-muted">PODs</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- MSX Integration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-link-45deg"></i> MSX Integration</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 d-flex flex-column">
                        <h6>Authentication Status</h6>
                        <div id="msxAuthStatus" class="p-3 rounded border mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span>Checking...</span>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-primary" id="msxRefreshBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Token
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" id="msxTestBtn">
                                    <i class="bi bi-lightning"></i> Test Connection
                                </button>
                            </div>
                        </div>
                        <div id="msxTestResult" class="mt-3"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>How to Authenticate</h6>
                        <div id="msxLoginInstructions">
                            <p class="small text-muted mb-2">MSX uses your Azure CLI session. To authenticate:</p>
                            <ol class="small mb-0">
                                <li>Connect to VPN</li>
                                <li>Open a terminal on this machine</li>
                                <li>Run: <code>az login --tenant 72f988bf-86f1-41af-91ab-2d7cd011db47</code></li>
                                <li>Complete the browser sign-in</li>
                                <li>Click "Refresh Token"</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System-Wide Data Management -->
        <div class="card mb-4 border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> System-Wide Data</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <h6><i class="bi bi-download"></i> Export</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="includeAiConfig" checked>
                            <label class="form-check-label" for="includeAiConfig">Include AI Config</label>
                        </div>
                        <div class="d-flex gap-2">
                            <button id="exportJsonBtn" class="btn btn-sm btn-primary">
                                <i class="bi bi-filetype-json"></i> JSON
                            </button>
                            <a href="{{ url_for('main.export_full_csv') }}" class="btn btn-sm btn-info">
                                <i class="bi bi-filetype-csv"></i> CSV
                            </a>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <h6><i class="bi bi-upload"></i> Import</h6>
                        <form id="importJsonForm" enctype="multipart/form-data">
                            <input type="file" class="form-control form-control-sm mb-2" id="importJsonFile" accept=".json" required>
                            <button type="submit" class="btn btn-sm btn-warning">
                                <i class="bi bi-upload"></i> Restore Backup
                            </button>
                        </form>
                        <div id="importJsonResult" class="mt-2"></div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <h6><i class="bi bi-trash"></i> Clear All</h6>
                        <p class="small text-danger mb-2">Deletes ALL data from ALL users</p>
                        <button class="btn btn-sm btn-danger" id="clearAllDataBtn">
                            <i class="bi bi-trash"></i> Clear Everything
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

// Clear All Data
document.getElementById('clearAllDataBtn').addEventListener('click', function() {
    const confirmation = prompt('⚠️ WARNING: This will delete ALL data from ALL users!\n\nType "DELETE ALL DATA" to confirm:');
    if (confirmation === 'DELETE ALL DATA') {
        fetch('/api/data-management/clear', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('All data has been cleared successfully.');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    } else if (confirmation !== null) {
        alert('Confirmation text did not match. Operation cancelled.');
    }
});

// Parse full AI Foundry URL and auto-fill fields (optional feature)
const aiFullUrlInput = document.getElementById('aiFullUrl');
if (aiFullUrlInput) {
    aiFullUrlInput.addEventListener('input', function() {
        const fullUrl = this.value.trim();
        if (!fullUrl) return;
        
        try {
            const url = new URL(fullUrl);
            
            // Extract deployment name from path
            // Pattern: /openai/deployments/{deployment_name}/chat/completions
            const pathMatch = url.pathname.match(/\/deployments\/([^\/]+)/);
            if (pathMatch) {
                const deploymentName = pathMatch[1];
                document.getElementById('aiDeployment').value = deploymentName;
                
                // Use just the origin (base URL) - SDK adds the path automatically
                document.getElementById('aiEndpoint').value = url.origin;
            }
            
            // Extract api-version from query params
            const apiVersion = url.searchParams.get('api-version');
            if (apiVersion) {
                document.getElementById('aiApiVersion').value = apiVersion;
            }
            
            // Show success feedback
            this.classList.add('is-valid');
            setTimeout(() => this.classList.remove('is-valid'), 2000);
        } catch (e) {
            // Invalid URL, show error feedback
            if (fullUrl.length > 10) {
                this.classList.add('is-invalid');
                setTimeout(() => this.classList.remove('is-invalid'), 2000);
            }
        }
    });
}

// JSON Export with optional AI config
document.getElementById('exportJsonBtn').addEventListener('click', function() {
    const includeAiConfig = document.getElementById('includeAiConfig').checked;
    const url = includeAiConfig 
        ? '{{ url_for("main.export_full_json") }}'
        : '{{ url_for("main.export_full_json") }}?exclude_ai_config=true';
    window.location.href = url;
});

// JSON Import
document.getElementById('importJsonForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const fileInput = document.getElementById('importJsonFile');
    const resultDiv = document.getElementById('importJsonResult');
    
    if (!fileInput.files[0]) {
        resultDiv.innerHTML = '<div class="alert alert-danger mt-2">Please select a file</div>';
        return;
    }
    
    if (!confirm('⚠️ WARNING: This will import data and may create duplicate entries if not cleared first.\n\nAre you sure you want to proceed?')) {
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    resultDiv.innerHTML = '<div class="alert alert-info">Importing... <div class="spinner-border spinner-border-sm ms-2"></div></div>';
    
    try {
        const response = await fetch('/api/data-management/import/json', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            resultDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> ${data.message}</div>`;
            fileInput.value = '';
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ${data.error}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> Import failed: ${error.message}</div>`;
    }
});

// MSX Integration - Load status on page load
async function loadMsxStatus() {
    const statusDiv = document.getElementById('msxAuthStatus');
    try {
        const response = await fetch('/api/msx/status');
        const data = await response.json();
        
        if (data.authenticated) {
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center gap-2 text-success">
                    <i class="bi bi-check-circle-fill fs-4"></i>
                    <div>
                        <strong>Connected</strong><br>
                        <small class="text-muted">Token expires in ${data.expires_in_minutes} minutes</small>
                    </div>
                </div>
            `;
        } else {
            let errorMsg = data.error || 'Not authenticated';
            // Make common errors more user-friendly
            if (errorMsg.includes('az login')) {
                errorMsg = 'Run "az login" in a terminal first';
            } else if (errorMsg.includes('not installed')) {
                errorMsg = 'Azure CLI not installed';
            }
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center gap-2 text-danger">
                    <i class="bi bi-x-circle-fill fs-4"></i>
                    <div>
                        <strong>Not Connected</strong><br>
                        <small>${errorMsg}</small>
                    </div>
                </div>
            `;
        }
    } catch (err) {
        statusDiv.innerHTML = `
            <div class="d-flex align-items-center gap-2 text-warning">
                <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                <div>
                    <strong>Error</strong><br>
                    <small>Could not check status</small>
                </div>
            </div>
        `;
    }
}

// MSX Refresh Token
document.getElementById('msxRefreshBtn').addEventListener('click', async function() {
    const btn = this;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Refreshing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/msx/refresh', { method: 'POST' });
        const data = await response.json();
        loadMsxStatus();
    } catch (err) {
        console.error('Refresh failed:', err);
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
});

// MSX Test Connection
document.getElementById('msxTestBtn').addEventListener('click', async function() {
    const btn = this;
    const resultDiv = document.getElementById('msxTestResult');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/msx/test');
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> <strong>Connection Successful!</strong><br>
                    <small>User ID: ${data.user_id}</small>
                </div>
            `;
            loadMsxStatus();
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> <strong>Connection Failed</strong><br>
                    <small>${data.error}</small>
                </div>
            `;
        }
    } catch (err) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> <strong>Error</strong><br>
                <small>${err.message}</small>
            </div>
        `;
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
});

// Load MSX status on page load
loadMsxStatus();

}); // end DOMContentLoaded
</script>
{% endblock %}










