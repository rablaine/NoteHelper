{% extends "base.html" %}

{% block title %}Admin Panel - NoteHelper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="bi bi-shield-lock"></i> Admin Panel</h1>
        
        <!-- System Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> System Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('call_logs.call_logs_list') }}" class="text-decoration-none">
                            <h3 class="text-success">{{ stats.total_call_logs }}</h3>
                            <small class="text-muted">Call Logs</small>
                        </a>
                    </div>
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('customers.customers_list') }}" class="text-decoration-none">
                            <h3 class="text-info">{{ stats.total_customers }}</h3>
                            <small class="text-muted">Customers</small>
                        </a>
                    </div>
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('sellers.sellers_list') }}" class="text-decoration-none">
                            <h3>{{ stats.total_sellers }}</h3>
                            <small class="text-muted">Sellers</small>
                        </a>
                    </div>
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('territories.territories_list') }}" class="text-decoration-none">
                            <h3>{{ stats.total_territories }}</h3>
                            <small class="text-muted">Territories</small>
                        </a>
                    </div>
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('topics.topics_list') }}" class="text-decoration-none">
                            <h3>{{ stats.total_topics }}</h3>
                            <small class="text-muted">Topics</small>
                        </a>
                    </div>
                    <div class="col-6 col-md-3 col-lg mb-3">
                        <a href="{{ url_for('pods.pods_list') }}" class="text-decoration-none">
                            <h3>{{ stats.total_pods }}</h3>
                            <small class="text-muted">PODs</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- MSX Integration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-link-45deg"></i> MSX Integration</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 d-flex flex-column">
                        <h6>Authentication Status</h6>
                        <div id="msxAuthStatus" class="p-3 rounded border mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span>Checking...</span>
                            </div>
                        </div>
                        <div class="mt-auto">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-sm btn-primary" id="msxRefreshBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Token
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" id="msxTestBtn">
                                    <i class="bi bi-lightning"></i> Test Connection
                                </button>
                            </div>
                        </div>
                        <div id="msxTestResult" class="mt-3"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Sign In</h6>
                        <div id="adminAuthCard">
                            <!-- Initial state -->
                            <div id="adminAuthInitial">
                                <p class="small text-muted mb-2">Click below to sign in via Azure CLI. A browser window will open.</p>
                                <p class="small text-muted mb-3"><i class="bi bi-info-circle"></i> Make sure you select your <strong>Microsoft corporate account</strong>.</p>
                                <button class="btn btn-primary" id="adminStartAuthBtn">
                                    <i class="bi bi-box-arrow-in-right"></i> Sign In to Azure
                                </button>
                            </div>
                            <!-- Waiting state -->
                            <div id="adminAuthWaiting" class="d-none">
                                <p class="small text-primary fw-bold mb-2">A browser window should open for sign-in.</p>
                                <p class="small mb-2">Select your <strong>Microsoft corporate account</strong>. This will update automatically.</p>
                                <div class="mb-2">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <span class="text-muted ms-2 small" id="adminAuthWaitingStatus">Waiting for sign-in to complete...</span>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm" id="adminAuthCancelBtn">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                            </div>
                            <!-- Success state -->
                            <div id="adminAuthSuccess" class="d-none">
                                <div class="d-flex align-items-center gap-2 text-success mb-2">
                                    <i class="bi bi-check-circle-fill fs-4"></i>
                                    <div>
                                        <strong>Connected to MSX!</strong><br>
                                        <small class="text-muted" id="adminAuthEmail"></small>
                                    </div>
                                </div>
                            </div>
                            <!-- Error state -->
                            <div id="adminAuthError" class="d-none">
                                <div class="d-flex align-items-center gap-2 text-warning mb-2">
                                    <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                                    <div>
                                        <strong id="adminAuthErrorMsg">Authentication failed</strong><br>
                                        <small class="text-muted">Make sure you selected your Microsoft corporate account.</small>
                                    </div>
                                </div>
                                <button class="btn btn-primary btn-sm" id="adminAuthRetryBtn">
                                    <i class="bi bi-arrow-clockwise"></i> Try Again
                                </button>
                            </div>
                            <!-- No CLI state -->
                            <div id="adminAuthNoCli" class="d-none">
                                <div class="d-flex align-items-center gap-2 text-danger mb-2">
                                    <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                                    <div>
                                        <strong>Azure CLI not installed</strong><br>
                                        <small>Install from <a href="https://aka.ms/installazurecli" target="_blank">aka.ms/installazurecli</a>, then reload.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <!-- Import Accounts from MSX -->
                <h6><i class="bi bi-cloud-download"></i> Import Accounts from MSX</h6>
                <p class="text-muted small mb-2">
                    Imports all accounts you're assigned to in MSX, along with territories, PODs, sellers, solution engineers, and verticals.
                </p>
                <button class="btn btn-primary" type="button" id="importFromMsxBtn">
                    <i class="bi bi-cloud-download"></i> Import My Accounts
                </button>
                
                <!-- MSX Import Progress -->
                <div id="msxImportProgress" class="mt-3 d-none">
                    <div class="d-flex justify-content-between mb-1">
                        <small class="text-muted" id="msxImportStatusText">Starting import...</small>
                        <small class="text-muted" id="msxImportProgressPercent">0%</small>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary" 
                             role="progressbar" id="msxImportProgressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- MSX Import Results -->
                <div id="msxImportResults" class="mt-3 d-none">
                    <div class="alert alert-success mb-0">
                        <h6 class="alert-heading"><i class="bi bi-check-circle"></i> Import Complete!</h6>
                        <div id="msxImportSummary"></div>
                    </div>
                </div>
                
                <!-- MSX Import Error -->
                <div id="msxImportError" class="mt-3 d-none">
                    <div class="alert alert-danger mb-0">
                        <h6 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Import Error</h6>
                        <p class="mb-0" id="msxImportErrorText"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Integration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-stars"></i> AI Integration</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Configuration Status</h6>
                        <table class="table table-sm mb-0">
                            <tr>
                                <td class="text-muted">OpenAI Endpoint</td>
                                <td>
                                    {% if ai_config.endpoint %}
                                    <i class="bi bi-check-circle-fill text-success"></i> Configured
                                    {% else %}
                                    <i class="bi bi-x-circle-fill text-danger"></i> Not set
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">Deployment</td>
                                <td>
                                    {% if ai_config.deployment %}
                                    <i class="bi bi-check-circle-fill text-success"></i> {{ ai_config.deployment }}
                                    {% else %}
                                    <i class="bi bi-x-circle-fill text-danger"></i> Not set
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td class="text-muted">Service Principal</td>
                                <td>
                                    {% if ai_config.has_credentials %}
                                    <i class="bi bi-check-circle-fill text-success"></i> Configured
                                    {% else %}
                                    <i class="bi bi-x-circle-fill text-danger"></i> Not set
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Connection Test</h6>
                        {% if ai_config.enabled and ai_config.has_credentials %}
                        <p class="small text-muted mb-2">Click below to verify NoteHelper can reach your Azure OpenAI endpoint.</p>
                        <button class="btn btn-outline-success" id="aiTestBtn">
                            <i class="bi bi-lightning"></i> Test AI Connection
                        </button>
                        {% elif not ai_config.endpoint %}
                        <p class="small text-muted mb-2">Set <code>AZURE_OPENAI_ENDPOINT</code> and <code>AZURE_OPENAI_DEPLOYMENT</code> in your <code>.env</code> file to enable AI features.</p>
                        {% elif not ai_config.has_credentials %}
                        <p class="small text-muted mb-2">Set <code>AZURE_CLIENT_ID</code>, <code>AZURE_CLIENT_SECRET</code>, and <code>AZURE_TENANT_ID</code> in your <code>.env</code> file.</p>
                        {% endif %}
                        <div id="aiTestResult" class="mt-3"></div>
                    </div>
                </div>
                {% if not ai_config.enabled %}
                <div class="alert alert-info mb-0 py-2">
                    <i class="bi bi-info-circle"></i> AI features (Auto-tag with AI, Match Milestone) are hidden from the UI when not configured. See the <a href="https://github.com/rablaine/NoteHelper#ai-features-optional" target="_blank">README</a> for setup instructions.
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Setup Wizard -->
        {% set setup_complete = has_customers and has_milestones and has_revenue %}
        <div class="card mb-4">
            <div class="card-header {% if setup_complete %}collapsed{% endif %}" {% if setup_complete %}data-bs-toggle="collapse" data-bs-target="#setupWizardCollapse" aria-expanded="false" role="button" style="cursor: pointer;"{% endif %}>
                <h5 class="mb-0 d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-rocket-takeoff"></i> Setup Wizard</span>
                    <span class="d-flex align-items-center gap-2">
                        {% if setup_complete %}
                        <span class="badge bg-success"><i class="bi bi-check-circle-fill"></i> Complete</span>
                        <i class="bi bi-chevron-down"></i>
                        {% endif %}
                    </span>
                </h5>
            </div>
            <div {% if setup_complete %}class="collapse" id="setupWizardCollapse"{% endif %}>
                <div class="card-body">
                    <p class="text-muted small mb-3">Re-run the initial setup wizard to check your progress or complete any remaining steps.</p>
                    <div class="row text-center mb-3">
                        <div class="col">
                            <i class="bi bi-{% if has_customers %}check-circle-fill text-success{% else %}circle text-muted{% endif %} fs-4"></i>
                            <div class="small mt-1">Accounts</div>
                        </div>
                        <div class="col">
                            <i class="bi bi-{% if has_milestones %}check-circle-fill text-success{% else %}circle text-muted{% endif %} fs-4"></i>
                            <div class="small mt-1">Milestones</div>
                        </div>
                        <div class="col">
                            <i class="bi bi-{% if has_revenue %}check-circle-fill text-success{% else %}circle text-muted{% endif %} fs-4"></i>
                            <div class="small mt-1">Revenue</div>
                        </div>
                    </div>
                    <button class="btn btn-warning" id="adminRerunWizardBtn">
                        <i class="bi bi-rocket-takeoff"></i> {% if setup_complete %}Re-run Setup Wizard{% else %}Launch Setup Wizard{% endif %}
                    </button>
                </div>
            </div>
        </div>

        <!-- Danger Zone (collapsed by default) -->
        <div class="card mb-4 border-danger">
            <div class="card-header bg-danger text-white collapsed" data-bs-toggle="collapse" data-bs-target="#dangerZoneCollapse" aria-expanded="false" role="button" style="cursor: pointer;">
                <h5 class="mb-0 d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-exclamation-triangle"></i> Danger Zone</span>
                    <i class="bi bi-chevron-down"></i>
                </h5>
            </div>
            <div class="collapse" id="dangerZoneCollapse">
                <div class="card-body">
                    <!-- Delete Operations -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <h6><i class="bi bi-flag"></i> Delete Milestone & Opportunity Data</h6>
                            <p class="small text-muted mb-1">
                                <strong>{{ stats.total_milestones }}</strong> milestones,
                                <strong>{{ stats.total_opportunities }}</strong> opportunities,
                                <strong>{{ stats.total_msx_tasks }}</strong> tasks
                            </p>
                            <p class="small text-muted mb-2">Delete all milestone and opportunity data to re-sync from MSX.</p>
                            <button class="btn btn-sm btn-danger" id="clearMilestonesBtn">
                                <i class="bi bi-trash"></i> Delete Milestone Data
                            </button>
                        </div>
                        <div class="col-md-6 mb-3">
                            <h6><i class="bi bi-currency-dollar"></i> Delete Revenue Data</h6>
                            <p class="small text-muted mb-1">
                                <strong>{{ stats.total_revenue_records }}</strong> records,
                                <strong>{{ stats.total_revenue_analyses }}</strong> analyses,
                                <strong>{{ stats.total_revenue_imports }}</strong> imports
                            </p>
                            <p class="small text-muted mb-2">Delete all revenue data to re-import with updated matching.</p>
                            <button class="btn btn-sm btn-danger" id="clearRevenueBtn">
                                <i class="bi bi-trash"></i> Delete Revenue Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

// Clear Revenue Data
document.getElementById('clearRevenueBtn').addEventListener('click', function() {
    const confirmation = prompt('This will delete all revenue data (records, analyses, imports).\n\nType "DELETE REVENUE" to confirm:');
    if (confirmation === 'DELETE REVENUE') {
        fetch('/api/admin/clear-revenue', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    } else if (confirmation !== null) {
        alert('Confirmation text did not match. Operation cancelled.');
    }
});

// Clear Milestone & Opportunity Data
document.getElementById('clearMilestonesBtn').addEventListener('click', function() {
    const confirmation = prompt('This will delete all milestones, opportunities, and tasks.\n\nType "DELETE MILESTONES" to confirm:');
    if (confirmation === 'DELETE MILESTONES') {
        fetch('/api/admin/clear-milestones', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    } else if (confirmation !== null) {
        alert('Confirmation text did not match. Operation cancelled.');
    }
});

// MSX Integration - Load status on page load
async function loadMsxStatus() {
    const statusDiv = document.getElementById('msxAuthStatus');
    try {
        const response = await fetch('/api/msx/status');
        const data = await response.json();
        
        if (data.vpn_blocked) {
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center gap-2 text-danger">
                    <i class="bi bi-shield-exclamation fs-4"></i>
                    <div>
                        <strong>VPN Required</strong><br>
                        <small>IP address blocked — connect to VPN and use the banner above to retry</small>
                    </div>
                </div>
            `;
            // Disable import button when off VPN
            const importBtn = document.getElementById('importFromMsxBtn');
            if (importBtn) {
                importBtn.disabled = true;
                importBtn.classList.replace('btn-primary', 'btn-secondary');
                importBtn.title = 'VPN required — connect to corpnet first';
            }
            return;
        }

        if (data.authenticated) {
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center gap-2 text-success">
                    <i class="bi bi-check-circle-fill fs-4"></i>
                    <div>
                        <strong>Connected</strong><br>
                        <small class="text-muted">Token expires in ${data.expires_in_minutes} minutes</small>
                    </div>
                </div>
            `;
            // Show success state in auth card
            showAdminAuthState('adminAuthSuccess');
        } else {
            let errorMsg = data.error || 'Not authenticated';
            // Make common errors more user-friendly
            if (errorMsg.includes('az login')) {
                errorMsg = 'Not signed in — click Sign In to Azure';
            } else if (errorMsg.includes('not installed')) {
                errorMsg = 'Azure CLI not installed';
            }
            statusDiv.innerHTML = `
                <div class="d-flex align-items-center gap-2 text-danger">
                    <i class="bi bi-x-circle-fill fs-4"></i>
                    <div>
                        <strong>Not Connected</strong><br>
                        <small>${errorMsg}</small>
                    </div>
                </div>
            `;
        }
    } catch (err) {
        statusDiv.innerHTML = `
            <div class="d-flex align-items-center gap-2 text-warning">
                <i class="bi bi-exclamation-triangle-fill fs-4"></i>
                <div>
                    <strong>Error</strong><br>
                    <small>Could not check status</small>
                </div>
            </div>
        `;
    }
}

// --- Admin Panel: Browser-based Az Login Flow ---
const ADMIN_POLL_INTERVAL = 1500;
const ADMIN_POLL_TIMEOUT = 20000;
let adminPollTimer = null;
let adminElapsedTimer = null;
let adminPollStart = null;
let adminLoginHandled = false;

function showAdminAuthState(stateId) {
    ['adminAuthInitial', 'adminAuthWaiting', 'adminAuthSuccess',
     'adminAuthError', 'adminAuthNoCli'].forEach(id => {
        document.getElementById(id).classList.add('d-none');
    });
    document.getElementById(stateId).classList.remove('d-none');
}

async function checkAdminAuth() {
    try {
        const resp = await fetch('/api/msx/status');
        const data = await resp.json();

        // If VPN is blocked, show error instead of auto-completing login
        if (data.vpn_blocked) {
            showAdminAuthState('adminAuthError');
            const errEl = document.getElementById('adminAuthErrorMsg');
            if (errEl) errEl.textContent = 'VPN required — connect to corpnet first.';
            return;
        }

        if (data.authenticated) {
            showAdminAuthState('adminAuthSuccess');
            return;
        }
        const azResp = await fetch('/api/msx/az-status');
        const azData = await azResp.json();
        if (!azData.az_installed) {
            showAdminAuthState('adminAuthNoCli');
        } else if (azData.logged_in) {
            await completeAdminLogin(azData.user_email);
        } else {
            showAdminAuthState('adminAuthInitial');
        }
    } catch (err) {
        showAdminAuthState('adminAuthInitial');
    }
}

async function startAdminLogin() {
    showAdminAuthState('adminAuthWaiting');
    adminLoginHandled = false;
    const statusEl = document.getElementById('adminAuthWaitingStatus');
    if (statusEl) statusEl.textContent = 'Waiting for sign-in to complete...';

    try {
        const resp = await fetch('/api/msx/az-login/start', { method: 'POST' });
        const data = await resp.json();
        if (data.error) {
            document.getElementById('adminAuthErrorMsg').textContent = data.error;
            showAdminAuthState('adminAuthError');
            return;
        }
        pollAdminLoginStatus();
    } catch (err) {
        document.getElementById('adminAuthErrorMsg').textContent = 'Could not start sign-in';
        showAdminAuthState('adminAuthError');
    }
}

function cancelAdminLogin() {
    if (adminPollTimer) { clearInterval(adminPollTimer); adminPollTimer = null; }
    if (adminElapsedTimer) { clearInterval(adminElapsedTimer); adminElapsedTimer = null; }
    adminLoginHandled = false;
    showAdminAuthState('adminAuthInitial');
}

function pollAdminLoginStatus() {
    if (adminPollTimer) clearInterval(adminPollTimer);
    if (adminElapsedTimer) clearInterval(adminElapsedTimer);
    adminPollStart = Date.now();

    const statusEl = document.getElementById('adminAuthWaitingStatus');
    adminElapsedTimer = setInterval(() => {
        const elapsed = Math.round((Date.now() - adminPollStart) / 1000);
        if (statusEl) statusEl.textContent = 'Waiting for sign-in... (' + elapsed + 's)';
    }, 1000);

    adminPollTimer = setInterval(async () => {
        if (Date.now() - adminPollStart > ADMIN_POLL_TIMEOUT) {
            clearInterval(adminPollTimer); adminPollTimer = null;
            clearInterval(adminElapsedTimer); adminElapsedTimer = null;
            document.getElementById('adminAuthErrorMsg').textContent = 'Authentication timed out';
            showAdminAuthState('adminAuthError');
            return;
        }
        if (adminLoginHandled) return;
        try {
            const resp = await fetch('/api/msx/az-status');
            const data = await resp.json();
            if (adminLoginHandled) return;
            if (data.logged_in) {
                adminLoginHandled = true;
                clearInterval(adminPollTimer); adminPollTimer = null;
                clearInterval(adminElapsedTimer); adminElapsedTimer = null;
                await completeAdminLogin(data.user_email);
            }
        } catch (err) {
            console.error('Admin auth poll error:', err);
        }
    }, ADMIN_POLL_INTERVAL);
}

async function completeAdminLogin(userEmail) {
    const statusEl = document.getElementById('adminAuthWaitingStatus');
    if (statusEl) statusEl.textContent = 'Connecting to MSX...';
    showAdminAuthState('adminAuthWaiting');
    try {
        const resp = await fetch('/api/msx/az-login/complete', { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
            showAdminAuthState('adminAuthSuccess');
            const emailEl = document.getElementById('adminAuthEmail');
            const email = userEmail || data.user_email;
            if (emailEl && email) emailEl.textContent = 'Signed in as ' + email;
            // Refresh the status panel too
            loadMsxStatus();
        } else {
            document.getElementById('adminAuthErrorMsg').textContent =
                data.error || 'Failed to get CRM token';
            showAdminAuthState('adminAuthError');
        }
    } catch (err) {
        document.getElementById('adminAuthErrorMsg').textContent = 'Failed to complete sign-in';
        showAdminAuthState('adminAuthError');
    }
}

// Wire up admin auth buttons
document.getElementById('adminStartAuthBtn').addEventListener('click', startAdminLogin);
document.getElementById('adminAuthRetryBtn').addEventListener('click', startAdminLogin);
document.getElementById('adminAuthCancelBtn').addEventListener('click', cancelAdminLogin);

// MSX Refresh Token
document.getElementById('msxRefreshBtn').addEventListener('click', async function() {
    const btn = this;
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Refreshing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/msx/refresh', { method: 'POST' });
        const data = await response.json();
        loadMsxStatus();
    } catch (err) {
        console.error('Refresh failed:', err);
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
});

// MSX Test Connection
document.getElementById('msxTestBtn').addEventListener('click', async function() {
    const btn = this;
    const resultDiv = document.getElementById('msxTestResult');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';
    btn.disabled = true;
    
    try {
        const response = await fetch('/api/msx/test');
        const data = await response.json();
        
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> <strong>Connection Successful!</strong><br>
                    <small>User ID: ${data.user_id}</small>
                </div>
            `;
            loadMsxStatus();
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> <strong>Connection Failed</strong><br>
                    <small>${data.error}</small>
                </div>
            `;
        }
    } catch (err) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> <strong>Error</strong><br>
                <small>${err.message}</small>
            </div>
        `;
    } finally {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
});

// Load MSX status and auth state on page load
loadMsxStatus();
checkAdminAuth();

// Setup Wizard - Re-run
document.getElementById('adminRerunWizardBtn').addEventListener('click', async function() {
    try {
        await fetch('/api/preferences/reset-onboarding', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        window.location.href = '/';
    } catch (err) {
        alert('Failed to launch setup wizard: ' + err.message);
    }
});

// AI Connection Test
const aiTestBtn = document.getElementById('aiTestBtn');
if (aiTestBtn) {
    aiTestBtn.addEventListener('click', async function() {
        const btn = this;
        const resultDiv = document.getElementById('aiTestResult');
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Testing...';
        btn.disabled = true;
        
        try {
            const response = await fetch('/api/admin/ai-config/test', { method: 'POST' });
            const data = await response.json();
            
            if (data.success) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success py-2">
                        <i class="bi bi-check-circle-fill"></i> <strong>Connection successful!</strong><br>
                        <small class="text-muted">Response: ${data.response}</small>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-danger py-2">
                        <i class="bi bi-x-circle-fill"></i> <strong>Connection failed</strong><br>
                        <small>${data.error}</small>
                    </div>
                `;
            }
        } catch (err) {
            resultDiv.innerHTML = `
                <div class="alert alert-danger py-2">
                    <i class="bi bi-x-circle-fill"></i> <strong>Error</strong><br>
                    <small>${err.message}</small>
                </div>
            `;
        } finally {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    });
}

// MSX Import Accounts (SSE streaming)
document.getElementById('importFromMsxBtn').addEventListener('click', async function() {
    // Pre-flight VPN check
    if (window.isVpnBlocked && window.isVpnBlocked()) {
        window.showVpnBanner();
        return;
    }
    const btn = this;
    const progressDiv = document.getElementById('msxImportProgress');
    const resultsDiv = document.getElementById('msxImportResults');
    const errorDiv = document.getElementById('msxImportError');
    const statusText = document.getElementById('msxImportStatusText');
    const progressPercent = document.getElementById('msxImportProgressPercent');
    const progressBar = document.getElementById('msxImportProgressBar');
    const summaryDiv = document.getElementById('msxImportSummary');
    
    // Reset UI
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Importing...';
    
    function warnOnLeave(e) { e.preventDefault(); e.returnValue = ''; }
    window.addEventListener('beforeunload', warnOnLeave);
    progressDiv.classList.remove('d-none');
    resultsDiv.classList.add('d-none');
    errorDiv.classList.add('d-none');
    statusText.textContent = 'Starting import...';
    progressPercent.textContent = '0%';
    progressBar.style.width = '0%';
    
    try {
        const response = await fetch('/api/msx/import-stream');
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        if (data.message) {
                            statusText.textContent = data.message;
                        }
                        
                        if (data.progress !== undefined) {
                            progressPercent.textContent = `${data.progress}%`;
                            progressBar.style.width = `${data.progress}%`;
                        }
                        
                        if (data.complete && data.summary) {
                            progressDiv.classList.add('d-none');
                            resultsDiv.classList.remove('d-none');
                            
                            const s = data.summary;
                            summaryDiv.innerHTML = `
                                <ul class="mb-0">
                                    <li>PODs: ${s.pods_created || 0} created</li>
                                    <li>Territories: ${s.territories_created || 0} created</li>
                                    <li>Sellers: ${s.sellers_created || 0} created</li>
                                    <li>Solution Engineers: ${s.solution_engineers_created || 0} created</li>
                                    <li>Verticals: ${s.verticals_created || 0} created</li>
                                    <li>Customers: ${s.customers_created || 0} created, ${s.customers_skipped || 0} skipped</li>
                                </ul>
                                <a href="{{ url_for('customers.customers_list') }}" class="btn btn-sm btn-outline-primary mt-2">
                                    <i class="bi bi-people"></i> View Customers
                                </a>
                            `;
                        }
                    } catch (parseError) {
                        if (parseError.message !== 'Unexpected end of JSON input') {
                            console.error('SSE parse error:', parseError);
                        }
                    }
                }
            }
        }
    } catch (error) {
        progressDiv.classList.add('d-none');
        errorDiv.classList.remove('d-none');
        document.getElementById('msxImportErrorText').textContent = error.message;
    } finally {
        window.removeEventListener('beforeunload', warnOnLeave);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-cloud-download"></i> Import My Accounts';
    }
});

// Setup Wizard chevron rotation
const setupHeader = document.querySelector('[data-bs-target="#setupWizardCollapse"]');
if (setupHeader) {
    const setupChevron = setupHeader.querySelector('.bi-chevron-down');
    document.getElementById('setupWizardCollapse').addEventListener('shown.bs.collapse', function() {
        setupChevron.style.transform = 'rotate(180deg)';
        setupChevron.style.transition = 'transform 0.2s';
    });
    document.getElementById('setupWizardCollapse').addEventListener('hidden.bs.collapse', function() {
        setupChevron.style.transform = 'rotate(0deg)';
    });
}

// Danger Zone chevron rotation
const dangerHeader = document.querySelector('[data-bs-target="#dangerZoneCollapse"]');
if (dangerHeader) {
    const chevron = dangerHeader.querySelector('.bi-chevron-down');
    document.getElementById('dangerZoneCollapse').addEventListener('shown.bs.collapse', function() {
        chevron.style.transform = 'rotate(180deg)';
        chevron.style.transition = 'transform 0.2s';
    });
    document.getElementById('dangerZoneCollapse').addEventListener('hidden.bs.collapse', function() {
        chevron.style.transform = 'rotate(0deg)';
    });
}

}); // end DOMContentLoaded
</script>
{% endblock %}










