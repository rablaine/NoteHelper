{% extends "base.html" %}

{% block title %}Topics - NoteHelper{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-tags"></i> Topics</h1>
    <div class="d-flex align-items-center gap-2">
        <button id="sortToggle" class="btn btn-outline-secondary btn-sm" title="Toggle sort order">
            <i class="bi bi-sort-alpha-down"></i> <span id="sortLabel">By Calls</span>
        </button>
        <a href="{{ url_for('topics.topic_create') }}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle"></i> New Topic
        </a>
    </div>
</div>

{% if topics %}
    <div class="list-group">
        {% for topic in topics %}
            <a href="{{ url_for('topics.topic_view', id=topic.id) }}" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h5 class="mb-1">{{ topic.name }}</h5>
                    <small class="text-muted">{{ topic.call_logs|length }} calls</small>
                </div>
                {% if topic.description %}
                    <p class="mb-1 text-muted">{{ topic.description|truncate(150, true) }}</p>
                {% endif %}
            </a>
        {% endfor %}
    </div>
{% else %}
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> No topics yet. <a href="{{ url_for('topics.topic_create') }}">Create your first topic</a>!
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Handle sort toggle
document.addEventListener('DOMContentLoaded', function() {
    const sortToggle = document.getElementById('sortToggle');
    const sortLabel = document.getElementById('sortLabel');
    
    // Get current preference
    fetch('/api/preferences/topic-sort')
        .then(response => response.json())
        .then(data => {
            updateButtonLabel(data.topic_sort_by_calls);
        });
    
    sortToggle.addEventListener('click', function() {
        // Get current state
        fetch('/api/preferences/topic-sort')
            .then(response => response.json())
            .then(data => {
                const newSortByCalls = !data.topic_sort_by_calls;
                
                // Save new preference
                return fetch('/api/preferences/topic-sort', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ topic_sort_by_calls: newSortByCalls })
                });
            })
            .then(response => response.json())
            .then(() => {
                // Reload page to show new sort order
                window.location.reload();
            })
            .catch(error => {
                console.error('Error toggling sort preference:', error);
                window.location.reload();
            });
    });
    
    function updateButtonLabel(sortByCalls) {
        if (sortByCalls) {
            sortLabel.textContent = 'By Calls';
            sortToggle.querySelector('i').className = 'bi bi-sort-numeric-down';
        } else {
            sortLabel.textContent = 'Alphabetical';
            sortToggle.querySelector('i').className = 'bi bi-sort-alpha-down';
        }
    }
});
</script>
{% endblock %}










