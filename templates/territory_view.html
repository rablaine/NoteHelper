{% extends "base.html" %}

{% block title %}{{ territory.name }} - NoteHelper{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-geo-alt"></i> {{ territory.name }}</h1>
    <a href="{{ url_for('territories.territory_edit', id=territory.id) }}" class="btn btn-primary">
        <i class="bi bi-pencil"></i> Edit Territory
    </a>
</div>

{% if territory.pod %}
<div class="alert alert-info">
    <i class="bi bi-diagram-3"></i> <strong>POD:</strong> 
    <a href="{{ url_for('pods.pod_view', id=territory.pod.id) }}" class="alert-link">{{ territory.pod.name }}</a>
</div>
{% endif %}

<div class="row">
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Sellers in this Territory</h5>
            </div>
            <div class="card-body">
                {% if sellers %}
                    <ul class="list-group list-group-flush">
                        {% for seller in sellers %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <a href="{{ url_for('sellers.seller_view', id=seller.id) }}">{{ seller.name }}</a>
                                <span class="badge bg-primary rounded-pill">{{ seller.customers|length }} customers</span>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No sellers in this territory yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    {% if show_accounts %}
                        Accounts in Territory
                    {% else %}
                        Recent Calls (Last 7 Days)
                    {% endif %}
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="territoryViewToggle" id="viewCalls" 
                           {{ 'checked' if not show_accounts else '' }}>
                    <label class="btn btn-outline-secondary" for="viewCalls" title="Recent Calls">
                        <i class="bi bi-telephone"></i>
                    </label>
                    
                    <input type="radio" class="btn-check" name="territoryViewToggle" id="viewAccounts" 
                           {{ 'checked' if show_accounts else '' }}>
                    <label class="btn btn-outline-secondary" for="viewAccounts" title="Accounts">
                        <i class="bi bi-building"></i>
                    </label>
                </div>
            </div>
            <div class="card-body">
                {% if show_accounts %}
                    {% if growth_customers or acquisition_customers %}
                        {% if growth_customers %}
                            <h6 class="mb-2"><span class="badge bg-success">Growth</span></h6>
                            <ul class="list-group list-group-flush mb-3">
                                {% for customer in growth_customers %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="{{ url_for('customers.customer_view', id=customer.id) }}">{{ customer.name }}</a>
                                        <span class="badge bg-primary rounded-pill">{{ customer.call_count }} calls</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                        
                        {% if acquisition_customers %}
                            <h6 class="mb-2"><span class="badge bg-info">Acquisition</span></h6>
                            <ul class="list-group list-group-flush">
                                {% for customer in acquisition_customers %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <a href="{{ url_for('customers.customer_view', id=customer.id) }}">{{ customer.name }}</a>
                                        <span class="badge bg-primary rounded-pill">{{ customer.call_count }} calls</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% else %}
                        <p class="text-muted">No accounts in this territory yet.</p>
                    {% endif %}
                {% else %}
                    {% if recent_calls %}
                        <ul class="list-group list-group-flush">
                            {% for call in recent_calls %}
                                <li class="list-group-item">
                                    <a href="{{ url_for('call_logs.call_log_view', id=call.id) }}">{{ call.customer.name }}</a>
                                    <br>
                                    <small class="text-muted">{{ call.call_date.strftime('%b %d, %Y') }}{% if call.call_date.hour != 0 or call.call_date.minute != 0 %} {{ call.call_date.strftime('%I:%M %p') }}{% endif %}</small>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">No recent calls in this territory.</p>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const territoryViewToggle = document.querySelectorAll('input[name="territoryViewToggle"]');
    
    territoryViewToggle.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const territoryViewAccounts = this.id === 'viewAccounts';
                
                fetch('/api/preferences/territory-view', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ territory_view_accounts: territoryViewAccounts })
                })
                .then(response => response.json())
                .then(() => {
                    // Reload page to show updated view
                    window.location.reload();
                })
                .catch(error => {
                    console.error('Error saving territory view preference:', error);
                });
            }
        });
    });
});
</script>
{% endblock %}










