{% extends "base.html" %}

{% block title %}Settings - NoteHelper{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-10 offset-md-1">
        <h1 class="mb-4"><i class="bi bi-sliders"></i> Settings</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Your Data</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col">
                        <div class="h3 text-primary">{{ stats.call_logs }}</div>
                        <small class="text-muted">Call Logs</small>
                    </div>
                    <div class="col">
                        <div class="h3 text-success">{{ stats.customers }}</div>
                        <small class="text-muted">Customers</small>
                    </div>
                    <div class="col">
                        <div class="h3 text-warning">{{ stats.topics }}</div>
                        <small class="text-muted">Topics</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Appearance</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                    <div>
                        <h6 class="mb-1">Dark Mode</h6>
                        <small class="text-muted">Use dark theme throughout the application</small>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="darkModeSwitch" 
                               {{ 'checked' if dark_mode else '' }} style="width: 3em; height: 1.5em;">
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">Seller Badge Colors</h6>
                        <small class="text-muted">Use unique colors for seller badges</small>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="coloredSellersSwitch" 
                               {{ 'checked' if colored_sellers else '' }} style="width: 3em; height: 1.5em;">
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">View Preferences</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                    <div>
                        <h6 class="mb-1">Customer Sort</h6>
                        <small class="text-muted">How to sort and display customers list</small>
                    </div>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="customerSort" id="customerAlpha" value="alphabetical" 
                               {{ 'checked' if customer_sort_by == 'alphabetical' else '' }}>
                        <label class="btn btn-outline-primary" for="customerAlpha">
                            <i class="bi bi-sort-alpha-down"></i> A-Z
                        </label>
                        
                        <input type="radio" class="btn-check" name="customerSort" id="customerGrouped" value="grouped" 
                               {{ 'checked' if customer_sort_by == 'grouped' else '' }}>
                        <label class="btn btn-outline-primary" for="customerGrouped">
                            <i class="bi bi-people"></i> Grouped
                        </label>

                        <input type="radio" class="btn-check" name="customerSort" id="customerByCalls" value="by_calls" 
                               {{ 'checked' if customer_sort_by == 'by_calls' else '' }}>
                        <label class="btn btn-outline-primary" for="customerByCalls">
                            <i class="bi bi-telephone"></i> By Calls
                        </label>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                    <div>
                        <h6 class="mb-1">Topic Sort</h6>
                        <small class="text-muted">How to sort topics list</small>
                    </div>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="topicSort" id="topicAlpha" value="false" 
                               {{ 'checked' if not topic_sort_by_calls else '' }}>
                        <label class="btn btn-outline-primary" for="topicAlpha">
                            <i class="bi bi-sort-alpha-down"></i> Alphabetical
                        </label>
                        
                        <input type="radio" class="btn-check" name="topicSort" id="topicByCalls" value="true" 
                               {{ 'checked' if topic_sort_by_calls else '' }}>
                        <label class="btn btn-outline-primary" for="topicByCalls">
                            <i class="bi bi-sort-numeric-down"></i> By Calls
                        </label>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
                    <div>
                        <h6 class="mb-1">Territory View</h6>
                        <small class="text-muted">Default view for territory pages</small>
                    </div>
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="territoryView" id="territoryCalls" value="false" 
                               {{ 'checked' if not territory_view_accounts else '' }}>
                        <label class="btn btn-outline-primary" for="territoryCalls">
                            <i class="bi bi-telephone"></i> Recent Calls
                        </label>
                        
                        <input type="radio" class="btn-check" name="territoryView" id="territoryAccounts" value="true" 
                               {{ 'checked' if territory_view_accounts else '' }}>
                        <label class="btn btn-outline-primary" for="territoryAccounts">
                            <i class="bi bi-building"></i> Accounts
                        </label>
                    </div>
                </div>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">Show Customers Without Calls</h6>
                        <small class="text-muted">Show all customers in list, even those without call logs</small>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="showCustomersWithoutCallsSwitch" 
                               {{ 'checked' if show_customers_without_calls else '' }} style="width: 3em; height: 1.5em;">
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Export Your Data</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Download your call logs and related data for backup or analysis.</p>
                
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-filetype-json"></i> JSON Format</h6>
                                <p class="card-text small text-muted">Complete export with all relationships. Best for backup or importing into another NoteHelper instance.</p>
                                <a href="/api/my-data/export/call-logs-json" class="btn btn-primary btn-sm" download>
                                    <i class="bi bi-download"></i> Download JSON
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-filetype-csv"></i> CSV Format</h6>
                                <p class="card-text small text-muted">Spreadsheet-friendly format. Best for analysis in Excel or Google Sheets.</p>
                                <a href="/api/my-data/export/call-logs-csv" class="btn btn-primary btn-sm" download>
                                    <i class="bi bi-download"></i> Download CSV
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4" id="import-section">
            <div class="card-header">
                <h5 class="mb-0">Import Data</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Import call logs from a JSON file previously exported from NoteHelper.</p>
                
                <form id="importForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="importFile" class="form-label">Select JSON File</label>
                        <input type="file" class="form-control" id="importFile" name="file" accept=".json" required>
                        <div class="form-text">Only JSON files exported from NoteHelper are supported.</div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="skipDuplicates" name="skip_duplicates" checked>
                        <label class="form-check-label" for="skipDuplicates">
                            Skip duplicate entries (recommended)
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-success" id="importBtn">
                        <i class="bi bi-upload"></i> Import Data
                    </button>
                </form>

                <div id="importProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                    </div>
                    <p class="text-muted mt-2">Importing...</p>
                </div>

                <div id="importResults" class="mt-3" style="display: none;"></div>
            </div>
        </div>

        <div class="alert alert-success d-none" id="saveSuccess">
            <i class="bi bi-check-circle"></i> Preferences saved successfully!
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const darkModeSwitch = document.getElementById('darkModeSwitch');
    const topicSortRadios = document.querySelectorAll('input[name="topicSort"]');
    const saveSuccess = document.getElementById('saveSuccess');
    
    // Dark mode toggle
    darkModeSwitch.addEventListener('change', function() {
        const darkMode = this.checked;
        
        fetch('/api/preferences/dark-mode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ dark_mode: darkMode })
        })
        .then(response => response.json())
        .then(() => {
            showSuccess();
            // Update UI immediately
            document.documentElement.setAttribute('data-bs-theme', darkMode ? 'dark' : 'light');
        })
        .catch(error => {
            console.error('Error saving dark mode preference:', error);
        });
    });
    
    // Customer sort preference
    const customerSortRadios = document.querySelectorAll('input[name="customerSort"]');
    customerSortRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const customerSortBy = this.value;
                
                fetch('/api/preferences/customer-sort-by', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ customer_sort_by: customerSortBy })
                })
                .then(response => response.json())
                .then(() => {
                    showSuccess();
                })
                .catch(error => {
                    console.error('Error saving customer sort preference:', error);
                });
            }
        });
    });
    
    // Topic sort preference
    topicSortRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const topicSortByCalls = this.value === 'true';
                
                fetch('/api/preferences/topic-sort', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ topic_sort_by_calls: topicSortByCalls })
                })
                .then(response => response.json())
                .then(() => {
                    showSuccess();
                })
                .catch(error => {
                    console.error('Error saving topic sort preference:', error);
                });
            }
        });
    });
    
    // Territory view preference
    const territoryViewRadios = document.querySelectorAll('input[name="territoryView"]');
    territoryViewRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.checked) {
                const territoryViewAccounts = this.value === 'true';
                
                fetch('/api/preferences/territory-view', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ territory_view_accounts: territoryViewAccounts })
                })
                .then(response => response.json())
                .then(() => {
                    showSuccess();
                })
                .catch(error => {
                    console.error('Error saving territory view preference:', error);
                });
            }
        });
    });
    
    // Colored sellers toggle
    const coloredSellersSwitch = document.getElementById('coloredSellersSwitch');
    if (coloredSellersSwitch) {
        coloredSellersSwitch.addEventListener('change', function() {
            const coloredSellers = this.checked;
            
            // Update HTML attribute immediately for instant toggle
            document.documentElement.setAttribute('data-colored-sellers', coloredSellers ? 'true' : 'false');
            
            fetch('/api/preferences/colored-sellers', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ colored_sellers: coloredSellers })
            })
            .then(response => response.json())
            .then(() => {
                showSuccess();
            })
            .catch(error => {
                console.error('Error saving colored sellers preference:', error);
            });
        });
    }
    
    // Show customers without calls toggle
    const showCustomersWithoutCallsSwitch = document.getElementById('showCustomersWithoutCallsSwitch');
    if (showCustomersWithoutCallsSwitch) {
        showCustomersWithoutCallsSwitch.addEventListener('change', function() {
            const showCustomersWithoutCalls = this.checked;
            
            fetch('/api/preferences/show-customers-without-calls', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ show_customers_without_calls: showCustomersWithoutCalls })
            })
            .then(response => response.json())
            .then(() => {
                showSuccess();
            })
            .catch(error => {
                console.error('Error saving show customers without calls preference:', error);
            });
        });
    }
    
    function showSuccess() {
        saveSuccess.classList.remove('d-none');
        setTimeout(() => {
            saveSuccess.classList.add('d-none');
        }, 3000);
    }
    
    // Import form handling
    document.getElementById('importForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const importBtn = document.getElementById('importBtn');
        const importProgress = document.getElementById('importProgress');
        const importResults = document.getElementById('importResults');
        const fileInput = document.getElementById('importFile');
        const skipDuplicates = document.getElementById('skipDuplicates').checked;
        
        if (!fileInput.files[0]) {
            alert('Please select a file');
            return;
        }
        
        // Show progress
        importBtn.disabled = true;
        importProgress.style.display = 'block';
        importResults.style.display = 'none';
        
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('skip_duplicates', skipDuplicates);
        
        try {
            const response = await fetch('/api/my-data/import/json', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            // Hide progress
            importProgress.style.display = 'none';
            
            // Show results
            if (result.success) {
                importResults.innerHTML = `
                    <div class="alert alert-success">
                        <h6><i class="bi bi-check-circle"></i> Import Successful!</h6>
                        <ul class="mb-0">
                            <li>Call Logs: ${result.imported.call_logs} imported, ${result.skipped.call_logs} skipped</li>
                            <li>Customers: ${result.imported.customers} imported, ${result.skipped.customers} skipped</li>
                            <li>Topics: ${result.imported.topics} imported, ${result.skipped.topics} skipped</li>
                        </ul>
                    </div>
                `;
                // Reload stats after successful import
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                importResults.innerHTML = `
                    <div class="alert alert-danger">
                        <h6><i class="bi bi-x-circle"></i> Import Failed</h6>
                        <p>${result.error}</p>
                    </div>
                `;
            }
            importResults.style.display = 'block';
            
        } catch (error) {
            importProgress.style.display = 'none';
            importResults.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="bi bi-x-circle"></i> Import Failed</h6>
                    <p>Error: ${error.message}</p>
                </div>
            `;
            importResults.style.display = 'block';
        } finally {
            importBtn.disabled = false;
            fileInput.value = '';
        }
    });
});
</script>
{% endblock %}










