{% extends "base.html" %}

{% block title %}Milestone Tracker - NoteHelper{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-0"><i class="bi bi-flag-fill text-success"></i> Milestone Tracker</h1>
        <p class="text-muted mb-0">
            Active uncommitted milestones across all customers
            {% if last_sync %}
                &middot; Last synced {{ last_sync.strftime('%b %d, %Y at %I:%M %p') }}
            {% endif %}
        </p>
    </div>
    <div>
        <button id="syncBtn" class="btn btn-primary" onclick="syncMilestones()">
            <i class="bi bi-arrow-repeat"></i> Sync from MSX
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-0 shadow-sm">
            <div class="card-body py-3">
                <h3 class="text-primary mb-0" id="totalCount">{{ summary.total_count }}</h3>
                <p class="text-muted mb-0 small">Active Milestones</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-0 shadow-sm">
            <div class="card-body py-3">
                <h3 class="text-success mb-0" id="totalValue">
                    {% if summary.total_monthly_usage %}
                        ${{ "{:,.0f}".format(summary.total_monthly_usage) }}
                    {% else %}
                        $0
                    {% endif %}
                </h3>
                <p class="text-muted mb-0 small">Total Est. Monthly $</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-0 shadow-sm">
            <div class="card-body py-3">
                <h3 class="text-danger mb-0" id="pastDueCount">{{ summary.past_due_count }}</h3>
                <p class="text-muted mb-0 small">Past Due</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-0 shadow-sm">
            <div class="card-body py-3">
                <h3 class="text-warning mb-0" id="thisWeekCount">{{ summary.this_week_count }}</h3>
                <p class="text-muted mb-0 small">Due This Week</p>
            </div>
        </div>
    </div>
</div>

<!-- Sync Progress Alert (hidden by default) -->
<div id="syncAlert" class="alert d-none mb-4" role="alert">
    <div id="syncMessage"></div>
    <div id="syncProgressWrap" class="d-none mt-2">
        <div class="progress" style="height: 22px;">
            <div id="syncProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                0%
            </div>
        </div>
        <div id="syncDetail" class="small text-muted mt-1"></div>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body py-2">
        <div class="row align-items-center">
            <div class="col-md-2">
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle w-100 text-start text-truncate" type="button" id="quarterDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                        <i class="bi bi-calendar3"></i> Quarters
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="quarterDropdown" style="min-width: 100%;">
                        <li>
                            <button class="dropdown-item small" type="button" id="quarterSelectAll">Select All</button>
                        </li>
                        <li>
                            <button class="dropdown-item small" type="button" id="quarterSelectNone">Clear All</button>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for q in quarters %}
                        <li>
                            <label class="dropdown-item small mb-0">
                                <input class="form-check-input me-2 quarter-checkbox" type="checkbox" value="{{ q }}" checked>
                                {{ q }}
                            </label>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="col-md-2">
                <select id="sellerFilter" class="form-select form-select-sm">
                    <option value="">All Sellers</option>
                    {% for seller in sellers %}
                        <option value="{{ seller.id }}">{{ seller.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <select id="statusFilter" class="form-select form-select-sm">
                    <option value="">All Statuses</option>
                    <option value="On Track">On Track</option>
                    <option value="At Risk">At Risk</option>
                    <option value="Blocked">Blocked</option>
                </select>
            </div>
            <div class="col-md-2">
                <select id="areaFilter" class="form-select form-select-sm">
                    <option value="">All Areas</option>
                    {% for area in areas %}
                        <option value="{{ area }}"{% if area == 'Data' %} selected{% endif %}>{{ area }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <div class="form-check form-switch mt-1 text-nowrap">
                    <input class="form-check-input" type="checkbox" id="myTeamFilter">
                    <label class="form-check-label small" for="myTeamFilter">My Team</label>
                </div>
            </div>
            <div class="col-md-2 text-end">
                <span id="filteredCount" class="text-muted small">{{ milestones|length }} milestones</span>
            </div>
        </div>
    </div>
</div>

<!-- Milestones Table -->
{% if milestones %}
<div class="table-responsive">
    <table class="table table-hover align-middle" id="milestonesTable">
        <thead>
            <tr>
                <th style="width: 25%;">Milestone</th>
                <th style="width: 15%; cursor: pointer;" class="sortable" data-sort="customer" onclick="sortTable('customer')">Customer <i class="bi bi-arrow-down-up text-muted small"></i></th>
                <th style="width: 12%; cursor: pointer;" class="sortable" data-sort="seller" onclick="sortTable('seller')">Seller <i class="bi bi-arrow-down-up text-muted small"></i></th>
                <th style="width: 10%; cursor: pointer;" class="sortable" data-sort="status" onclick="sortTable('status')">Status <i class="bi bi-arrow-down-up text-muted small"></i></th>
                <th style="width: 12%; cursor: pointer;" class="sortable" data-sort="due-date" onclick="sortTable('due-date')">Due Date <i class="bi bi-arrow-down-up text-muted small"></i></th>
                <th style="width: 12%; cursor: pointer;" class="sortable text-end" data-sort="monthly" onclick="sortTable('monthly')">Est. Monthly $ <i class="bi bi-arrow-down-up text-muted small"></i></th>
                <th style="width: 9%;">Workload</th>
                <th style="width: 5%;" class="text-center">MSX</th>
            </tr>
        </thead>
        <tbody>
            {% for ms in milestones %}
            <tr class="milestone-row" style="cursor: pointer;"
                onclick="window.location='{{ url_for('milestones.milestone_view', id=ms.id) }}';"
                data-seller-id="{{ ms.seller.id if ms.seller else '' }}"
                data-status="{{ ms.status }}"
                data-area="{{ ms.workload_area }}"
                data-quarter="{{ ms.fiscal_quarter }}"
                data-on-my-team="{{ 'true' if ms.on_my_team else 'false' }}"
                data-customer="{{ ms.customer.name|lower if ms.customer else '' }}"
                data-seller-name="{{ ms.seller.name|lower if ms.seller else 'zzz' }}"
                data-status-sort="{{ ms.status_sort }}"
                data-due-date="{{ ms.due_date.strftime('%Y-%m-%d') if ms.due_date else '9999-12-31' }}"
                data-monthly="{{ ms.monthly_usage or 0 }}"
                data-search="{{ ms.title|lower }} {{ ms.opportunity_name|lower if ms.opportunity_name else '' }} {{ ms.customer.name|lower if ms.customer else '' }} {{ ms.seller.name|lower if ms.seller else '' }} {{ ms.workload|lower if ms.workload else '' }}">
                
                <!-- Milestone Info -->
                <td>
                    <div class="fw-semibold">
                        {% if ms.on_my_team %}<i class="bi bi-people-fill text-primary me-1" title="On my team"></i>{% endif %}{{ ms.title }}
                    </div>
                    {% if ms.opportunity_name %}
                        <div class="text-muted small">
                            <i class="bi bi-briefcase"></i> {{ ms.opportunity_name }}
                        </div>
                    {% endif %}
                    {% if ms.milestone_number %}
                        <div class="text-muted small">
                            <i class="bi bi-hash"></i> {{ ms.milestone_number }}
                        </div>
                    {% endif %}
                </td>
                
                <!-- Customer -->
                <td>
                    {% if ms.customer %}
                        <a href="{{ url_for('customers.customer_view', id=ms.customer.id) }}" class="text-decoration-none" onclick="event.stopPropagation();">
                            {{ ms.customer.name }}
                        </a>
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </td>
                
                <!-- Seller -->
                <td>
                    {% if ms.seller %}
                        <a href="{{ url_for('sellers.seller_view', id=ms.seller.id) }}" 
                           class="badge {{ get_seller_color(ms.seller.id) }} text-decoration-none"
                           onclick="event.stopPropagation();">
                            <i class="bi bi-person"></i> {{ ms.seller.name }}
                        </a>
                    {% else %}
                        <span class="text-muted small">Unassigned</span>
                    {% endif %}
                </td>
                
                <!-- Status -->
                <td>
                    {% if ms.status == 'On Track' %}
                        <span class="badge bg-success">{{ ms.status }}</span>
                    {% elif ms.status == 'At Risk' %}
                        <span class="badge bg-warning text-dark">{{ ms.status }}</span>
                    {% elif ms.status == 'Blocked' %}
                        <span class="badge bg-danger">{{ ms.status }}</span>
                    {% else %}
                        <span class="badge bg-secondary">{{ ms.status }}</span>
                    {% endif %}
                </td>
                
                <!-- Due Date -->
                <td>
                    {% if ms.due_date %}
                        <span class="{% if ms.urgency == 'past_due' %}text-danger fw-bold{% elif ms.urgency == 'this_week' %}text-warning fw-semibold{% endif %}">
                            {{ ms.due_date.strftime('%b %d, %Y') }}
                        </span>
                        {% if ms.days_until_due is not none %}
                            <div class="small {% if ms.days_until_due < 0 %}text-danger{% elif ms.days_until_due <= 7 %}text-warning{% else %}text-muted{% endif %}">
                                {% if ms.days_until_due < 0 %}
                                    {{ (-ms.days_until_due) }}d overdue
                                {% elif ms.days_until_due == 0 %}
                                    Due today
                                {% elif ms.days_until_due == 1 %}
                                    Due tomorrow
                                {% else %}
                                    {{ ms.days_until_due }}d remaining
                                {% endif %}
                            </div>
                        {% endif %}
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </td>
                
                <!-- Est. Monthly Usage -->
                <td class="text-end">
                    {% if ms.monthly_usage %}
                        <span class="fw-semibold">${{ "{:,.0f}".format(ms.monthly_usage) }}</span>
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </td>
                
                <!-- Workload -->
                <td>
                    {% if ms.workload %}
                        <span class="small">{{ ms.workload }}</span>
                    {% else %}
                        <span class="text-muted">—</span>
                    {% endif %}
                </td>
                
                <!-- MSX Link -->
                <td class="text-center">
                    {% if ms.url %}
                        <a href="{{ ms.url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Open in MSX" onclick="event.stopPropagation();">
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% else %}
<div class="text-center py-5">
    <i class="bi bi-flag display-1 text-muted"></i>
    <h4 class="mt-3 text-muted">No Active Milestones</h4>
    <p class="text-muted">
        Click <strong>Sync from MSX</strong> to pull milestones for your customers,
        or make sure your customers have MSX account links (TPID URLs).
    </p>
    <button class="btn btn-primary" onclick="syncMilestones()">
        <i class="bi bi-arrow-repeat"></i> Sync from MSX
    </button>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// =============================================================================
// Sync from MSX
// =============================================================================
function syncMilestones() {
    const btn = document.getElementById('syncBtn');
    const alertEl = document.getElementById('syncAlert');
    const msg = document.getElementById('syncMessage');
    const progressWrap = document.getElementById('syncProgressWrap');
    const progressBar = document.getElementById('syncProgressBar');
    const detail = document.getElementById('syncDetail');

    // Warn user if they try to leave during sync
    function warnOnLeave(e) { e.preventDefault(); e.returnValue = ''; }
    window.addEventListener('beforeunload', warnOnLeave);

    // Disable button, show spinner
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Syncing...';

    // Show progress alert
    alertEl.className = 'alert alert-info mb-4';
    msg.innerHTML = '<i class="bi bi-hourglass-split"></i> Connecting to MSX...';
    progressWrap.classList.add('d-none');

    // Use EventSource-style fetch for SSE
    fetch('/api/milestone-tracker/sync', {
        method: 'POST',
        headers: { 'Accept': 'text/event-stream' },
    }).then(response => {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processEvents(text) {
            buffer += text;
            const events = buffer.split('\n\n');
            buffer = events.pop(); // keep incomplete chunk

            for (const block of events) {
                if (!block.trim()) continue;
                let eventType = 'message';
                let eventData = '';
                for (const line of block.split('\n')) {
                    if (line.startsWith('event: ')) eventType = line.slice(7);
                    else if (line.startsWith('data: ')) eventData = line.slice(6);
                }
                if (!eventData) continue;
                const data = JSON.parse(eventData);
                handleSyncEvent(eventType, data);
            }
        }

        function handleSyncEvent(type, data) {
            if (type === 'start') {
                progressWrap.classList.remove('d-none');
                msg.innerHTML = `<i class="bi bi-arrow-repeat"></i> Syncing milestones for <strong>${data.total}</strong> customers...`;
                progressBar.style.width = '0%';
                progressBar.textContent = '0%';
            } else if (type === 'progress') {
                const pct = Math.round((data.current / data.total) * 100);
                progressBar.style.width = pct + '%';
                progressBar.textContent = `${data.current} / ${data.total}`;
                progressBar.setAttribute('aria-valuenow', pct);

                if (data.status === 'ok') {
                    let info = `<i class="bi bi-check-circle text-success"></i> ${data.customer}`;
                    if (data.created > 0 || data.updated > 0) {
                        info += ` <span class="text-muted">(${data.created} new, ${data.updated} updated)</span>`;
                    }
                    detail.innerHTML = info;
                } else {
                    detail.innerHTML = `<i class="bi bi-x-circle text-danger"></i> ${data.customer}: ${data.error}`;
                }
            } else if (type === 'complete') {
                window.removeEventListener('beforeunload', warnOnLeave);
                progressBar.classList.remove('progress-bar-animated');
                progressBar.style.width = '100%';
                progressBar.textContent = '100%';
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Sync from MSX';

                if (data.success) {
                    alertEl.className = 'alert alert-success mb-4';
                    let parts = [];
                    if (data.created > 0) parts.push(`${data.created} new`);
                    if (data.updated > 0) parts.push(`${data.updated} updated`);
                    if (data.deactivated > 0) parts.push(`${data.deactivated} deactivated`);
                    let summary = parts.length > 0 ? parts.join(', ') : 'No changes';
                    msg.innerHTML = `<i class="bi bi-check-circle-fill"></i> Sync complete! ` +
                        `${data.synced} of ${data.total} customers synced in ${data.duration}s. ` +
                        `Milestones: ${summary}.`;
                    if (data.errors && data.errors.length > 0) {
                        msg.innerHTML += `<br><small class="text-warning"><i class="bi bi-exclamation-triangle"></i> ` +
                            `${data.errors.length} error(s): ${data.errors.slice(0, 3).join('; ')}</small>`;
                    }
                    setTimeout(() => window.location.reload(), 2500);
                } else {
                    alertEl.className = 'alert alert-danger mb-4';
                    let errorMsg = data.errors ? data.errors.join('; ') : 'Unknown error';
                    msg.innerHTML = `<i class="bi bi-x-circle-fill"></i> Sync failed: ${errorMsg}`;
                }
            }
        }

        function pump() {
            return reader.read().then(({ done, value }) => {
                if (done) return;
                processEvents(decoder.decode(value, { stream: true }));
                return pump();
            });
        }
        return pump();
    }).catch(error => {
        window.removeEventListener('beforeunload', warnOnLeave);
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-arrow-repeat"></i> Sync from MSX';
        alertEl.className = 'alert alert-danger mb-4';
        msg.innerHTML = `<i class="bi bi-x-circle-fill"></i> Sync error: ${error.message}`;
    });
}

// =============================================================================
// Client-side Filtering
// =============================================================================
function applyFilters() {
    const selectedQuarters = Array.from(document.querySelectorAll('.quarter-checkbox:checked')).map(cb => cb.value);
    const sellerFilter = document.getElementById('sellerFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const areaFilter = document.getElementById('areaFilter').value;
    const myTeamOnly = document.getElementById('myTeamFilter').checked;
    
    const rows = document.querySelectorAll('.milestone-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        let visible = true;
        
        // Quarter filter
        if (selectedQuarters.length > 0 && row.dataset.quarter && !selectedQuarters.includes(row.dataset.quarter)) {
            visible = false;
        }
        // Show rows with no quarter (no due date) unless quarters are actively filtered
        if (selectedQuarters.length > 0 && !row.dataset.quarter && selectedQuarters.length < document.querySelectorAll('.quarter-checkbox').length) {
            visible = false;
        }
        
        // Seller filter
        if (sellerFilter && row.dataset.sellerId !== sellerFilter) {
            visible = false;
        }
        
        // Status filter
        if (statusFilter && row.dataset.status !== statusFilter) {
            visible = false;
        }
        
        // Area filter
        if (areaFilter && row.dataset.area !== areaFilter) {
            visible = false;
        }
        
        // My Team filter
        if (myTeamOnly && row.dataset.onMyTeam !== 'true') {
            visible = false;
        }
        
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
    });
    
    document.getElementById('filteredCount').textContent = 
        `${visibleCount} of {{ milestones|length }} milestones`;
    
    // Update dropdown button text
    updateQuarterButtonText();
}

function updateQuarterButtonText() {
    const btn = document.getElementById('quarterDropdown');
    const total = document.querySelectorAll('.quarter-checkbox').length;
    const checked = document.querySelectorAll('.quarter-checkbox:checked').length;
    if (checked === 0) {
        btn.innerHTML = '<i class="bi bi-calendar3"></i> No Quarters';
    } else if (checked === total) {
        btn.innerHTML = '<i class="bi bi-calendar3"></i> All Quarters';
    } else {
        const selected = Array.from(document.querySelectorAll('.quarter-checkbox:checked')).map(cb => cb.value);
        btn.innerHTML = '<i class="bi bi-calendar3"></i> ' + selected.join(', ');
    }
}

// Quarter checkbox listeners
document.querySelectorAll('.quarter-checkbox').forEach(cb => {
    cb.addEventListener('change', applyFilters);
});
document.getElementById('quarterSelectAll')?.addEventListener('click', function() {
    document.querySelectorAll('.quarter-checkbox').forEach(cb => cb.checked = true);
    applyFilters();
});
document.getElementById('quarterSelectNone')?.addEventListener('click', function() {
    document.querySelectorAll('.quarter-checkbox').forEach(cb => cb.checked = false);
    applyFilters();
});

// Attach filter listeners
document.getElementById('sellerFilter').addEventListener('change', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('areaFilter').addEventListener('change', applyFilters);
document.getElementById('myTeamFilter').addEventListener('change', applyFilters);

// Apply default filter on page load (Area defaults to "Data")
applyFilters();

// =============================================================================
// Client-side Sorting
// =============================================================================
let currentSort = { column: 'monthly', direction: 'desc' };

function sortTable(column) {
    const table = document.getElementById('milestonesTable');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('.milestone-row'));

    // Toggle direction if clicking same column
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        // Default direction per column type
        currentSort.column = column;
        currentSort.direction = (column === 'monthly') ? 'desc' : 'asc';
    }

    const dir = currentSort.direction === 'asc' ? 1 : -1;

    rows.sort((a, b) => {
        let va, vb;
        switch (column) {
            case 'customer':
                va = a.dataset.customer || '';
                vb = b.dataset.customer || '';
                return dir * va.localeCompare(vb);
            case 'seller':
                va = a.dataset.sellerName || 'zzz';
                vb = b.dataset.sellerName || 'zzz';
                return dir * va.localeCompare(vb);
            case 'status':
                va = parseInt(a.dataset.statusSort) || 99;
                vb = parseInt(b.dataset.statusSort) || 99;
                return dir * (va - vb);
            case 'due-date':
                va = a.dataset.dueDate || '9999-12-31';
                vb = b.dataset.dueDate || '9999-12-31';
                return dir * va.localeCompare(vb);
            case 'monthly':
                va = parseFloat(a.dataset.monthly) || 0;
                vb = parseFloat(b.dataset.monthly) || 0;
                return dir * (va - vb);
            default:
                return 0;
        }
    });

    rows.forEach(r => tbody.appendChild(r));
    updateSortIndicators();
}

function updateSortIndicators() {
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'bi bi-arrow-down-up text-muted small';
    });
    const activeHeader = document.querySelector(`.sortable[data-sort="${currentSort.column}"]`);
    if (activeHeader) {
        const icon = activeHeader.querySelector('i');
        icon.className = currentSort.direction === 'asc'
            ? 'bi bi-sort-up text-primary small'
            : 'bi bi-sort-down text-primary small';
    }
}
</script>
{% endblock %}
