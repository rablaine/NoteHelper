{% extends "base.html" %}

{% block title %}{{ customer.name }} - NoteHelper{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 gap-3">
    <div style="min-width: 0; flex: 1; display: flex; align-items: baseline; gap: 0.5rem;">
        <h1 class="mb-0" style="white-space: nowrap; flex-shrink: 0;">
            <i class="bi bi-building"></i> 
        </h1>
        <h1 class="mb-0 text-truncate" style="min-width: 0;" title="{{ customer.name }}">
            {% if customer.nickname %}
                {{ customer.nickname }} <small class="text-muted">({{ customer.name }})</small>
            {% else %}
                {{ customer.name }}
            {% endif %}
        </h1>
    </div>
    <div class="flex-shrink-0 d-flex gap-2">
        <a href="{{ url_for('call_logs.call_log_create') }}?customer_id={{ customer.id }}" class="btn btn-success text-nowrap">
            <i class="bi bi-plus-circle"></i> New Call Log
        </a>
        <a href="{{ url_for('customers.customer_edit', id=customer.id) }}" class="btn btn-primary text-nowrap">
            <i class="bi bi-pencil"></i> Edit Customer
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Details</h5>
            </div>
            <div class="card-body">
                <p><strong>TPID:</strong> 
                    {% if customer.tpid_url %}
                        <a href="{{ customer.tpid_url }}" target="_blank">{{ customer.tpid }}</a>
                    {% else %}
                        {{ customer.tpid }}
                    {% endif %}
                </p>
                <p><strong>Seller:</strong> 
                    {% if customer.seller %}
                        <a href="{{ url_for('sellers.seller_view', id=customer.seller.id) }}" class="badge bg-secondary text-decoration-none"><i class="bi bi-person"></i> {{ customer.seller.name }}</a>
                        {% if customer.seller.seller_type %}
                            <span class="badge {% if customer.seller.seller_type == 'Growth' %}bg-success{% else %}bg-info{% endif %}">{{ customer.seller.seller_type }}</span>
                        {% endif %}
                    {% else %}
                        <span class="badge bg-secondary text-muted">No seller assigned</span>
                    {% endif %}
                </p>
                <p><strong>Territory:</strong> 
                    {% if customer.territory %}
                        <a href="{{ url_for('territories.territory_view', id=customer.territory.id) }}" class="badge bg-secondary text-decoration-none"><i class="bi bi-geo-alt"></i> {{ customer.territory.name }}</a>
                    {% else %}
                        <span class="badge bg-secondary text-muted">No territory assigned</span>
                    {% endif %}
                </p>
                {% if customer.verticals %}
                    <p><strong>Verticals:</strong><br>
                        {% for vertical in customer.verticals|sort(attribute='name') %}
                            <span class="badge bg-primary">{{ vertical.name }}</span>{% if not loop.last %} {% endif %}
                        {% endfor %}
                    </p>
                {% endif %}
                <p><strong>Total Calls:</strong> {{ call_logs|length }}</p>
                
                {% set partner_dict = {} %}
                {% for call in call_logs %}
                    {% for partner in call.partners %}
                        {% if partner.id not in partner_dict %}
                            {% set _ = partner_dict.update({partner.id: partner}) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
                {% if partner_dict %}
                <p><strong>Partners:</strong><br>
                    {% for partner_id, partner in partner_dict.items()|sort(attribute='1.name') %}
                        <a href="{{ url_for('partners.partner_view', id=partner.id) }}" class="badge text-decoration-none" style="background-color: #6f42c1;">
                            <i class="bi bi-building"></i> {{ partner.name }}
                        </a>
                    {% endfor %}
                </p>
                {% endif %}
            </div>
        </div>
        
        {% set milestone_dict = {} %}
        {% for call in call_logs %}
            {% for milestone in call.milestones %}
                {% if milestone.id not in milestone_dict %}
                    {% set _ = milestone_dict.update({milestone.id: milestone}) %}
                {% endif %}
            {% endfor %}
        {% endfor %}
        {% if milestone_dict %}
        <!-- Customer Milestones Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-flag"></i> Milestones</h5>
            </div>
            <div class="card-body">
                {% for milestone_id, milestone in milestone_dict.items()|sort(attribute='1.created_at', reverse=true) %}
                    <div class="{% if not loop.last %}mb-2{% endif %}">
                        <a href="{{ milestone.url }}" target="_blank" class="badge bg-success text-decoration-none" title="{{ milestone.display_text }}">
                            <i class="bi bi-flag"></i> {{ milestone.display_text[:35] }}{% if milestone.display_text|length > 35 %}...{% endif %} <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                        {% if milestone.msx_status %}
                        <span class="badge {% if milestone.msx_status == 'On Track' %}bg-success{% elif milestone.msx_status == 'At Risk' %}bg-warning text-dark{% elif milestone.msx_status == 'Blocked' %}bg-danger{% elif milestone.msx_status == 'Completed' %}bg-info{% else %}bg-secondary{% endif %}">{{ milestone.msx_status }}</span>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Customer Opportunities Card -->
        {% if customer.opportunities.count() > 0 %}
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-briefcase"></i> Opportunities</h5>
            </div>
            <div class="card-body">
                {% for opp in customer.opportunities.order_by(None).all()|sort(attribute='name') %}
                    <div class="{% if not loop.last %}mb-3 pb-3 border-bottom{% endif %}">
                        <div class="d-flex justify-content-between align-items-start">
                            <a href="{{ url_for('opportunities.opportunity_view', id=opp.id) }}" class="fw-bold text-decoration-none">
                                <i class="bi bi-briefcase"></i> {{ opp.name }}
                            </a>
                        </div>
                        {% set opp_milestones = opp.milestones.all() %}
                        {% if opp_milestones %}
                            <div class="mt-1">
                                {% for ms in opp_milestones %}
                                    <span class="badge {% if ms.msx_status == 'On Track' %}bg-success{% elif ms.msx_status == 'At Risk' %}bg-warning text-dark{% elif ms.msx_status == 'Blocked' %}bg-danger{% elif ms.msx_status == 'Completed' %}bg-info{% else %}bg-secondary{% endif %}" title="{{ ms.display_text }}">
                                        <i class="bi bi-flag"></i> {{ ms.display_text[:20] }}{% if ms.display_text|length > 20 %}...{% endif %}
                                    </span>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Customer Notes Card -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-sticky"></i> Notes</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" id="editNotesBtn" onclick="toggleNotesEdit()">
                    <i class="bi bi-pencil"></i> Edit
                </button>
            </div>
            <div class="card-body">
                <div id="notesDisplay" {% if not customer.notes %}style="display: none;"{% endif %}>
                    <p class="mb-0" style="white-space: pre-wrap;">{{ customer.notes or '' }}</p>
                </div>
                <div id="notesEmpty" {% if customer.notes %}style="display: none;"{% endif %}>
                    <p class="text-muted mb-0">No notes yet. Click Edit to add notes about opportunities or milestones.</p>
                </div>
                <form id="notesForm" action="{{ url_for('customers.customer_update_notes', id=customer.id) }}" method="post" style="display: none;">
                    <textarea class="form-control mb-2" name="notes" id="notesTextarea" rows="5" placeholder="Track opportunities, milestones, key contacts, etc.">{{ customer.notes or '' }}</textarea>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-sm btn-primary">
                            <i class="bi bi-check-lg"></i> Save
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="cancelNotesEdit()">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        {% if revenue_analyses %}
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Revenue Alerts</h5>
                <a href="{{ url_for('revenue.revenue_customer_view', customer_id=customer.id) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i> Details
                </a>
            </div>
            <div class="card-body">
                {% for analysis in revenue_analyses %}
                    <div class="{% if not loop.last %}mb-3 pb-3 border-bottom{% endif %}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <strong>{{ analysis.bucket }}</strong>
                            <span class="badge 
                                {% if analysis.category == 'CHURN_RISK' %}bg-danger
                                {% elif analysis.category == 'RECENT_DIP' %}bg-warning text-dark
                                {% elif analysis.category == 'EXPANSION_OPPORTUNITY' %}bg-success
                                {% elif analysis.category == 'VOLATILE' %}bg-info
                                {% elif analysis.category == 'STAGNANT' %}bg-secondary
                                {% elif analysis.category == 'HEALTHY' %}bg-success
                                {% elif analysis.category == 'NEW_CUSTOMER' %}bg-primary
                                {% elif analysis.category == 'CHURNED' %}bg-dark
                                {% else %}bg-secondary{% endif %}">
                                {{ analysis.category|replace('_', ' ')|title }}
                            </span>
                        </div>
                        
                        {% if analysis.recommended_action and analysis.recommended_action != 'NO ACTION' %}
                            <div class="small text-muted mb-1">
                                <i class="bi bi-exclamation-circle"></i> {{ analysis.recommended_action }}
                            </div>
                        {% endif %}
                        
                        <div class="small">
                            <span class="text-muted">Avg:</span> ${{ "{:,.0f}".format(analysis.avg_revenue) }}/mo
                            {% if analysis.trend_slope %}
                                <span class="ms-2 {% if analysis.trend_slope > 0 %}text-success{% elif analysis.trend_slope < 0 %}text-danger{% endif %}">
                                    <i class="bi bi-{% if analysis.trend_slope > 0 %}arrow-up{% elif analysis.trend_slope < 0 %}arrow-down{% else %}dash{% endif %}"></i>
                                    {{ "{:.1f}%".format(analysis.trend_slope * 100) }}
                                </span>
                            {% endif %}
                        </div>
                        
                        {% if analysis.dollars_at_risk and analysis.dollars_at_risk > 0 %}
                            <div class="small text-danger mt-1">
                                <i class="bi bi-exclamation-triangle"></i> ${{ "{:,.0f}".format(analysis.dollars_at_risk) }} at risk
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Call Logs (most recent first)</h5>
            </div>
            <div class="card-body">
                {% if call_logs %}
                    <style>
                        .clickable-call {
                            cursor: pointer;
                            transition: background-color 0.15s ease-in-out;
                        }
                        .clickable-call:hover {
                            background-color: rgba(0, 0, 0, 0.05);
                        }
                        html[data-bs-theme="dark"] .clickable-call:hover {
                            background-color: rgba(255, 255, 255, 0.15);
                        }
                        .clickable-call a {
                            position: relative;
                            z-index: 2;
                        }
                    </style>
                    {# Check if all call logs are with the same seller as the customer's seller #}
                    {% set all_same_seller = call_logs|selectattr('seller.id', 'equalto', customer.seller.id)|list|length == call_logs|length if customer.seller else false %}
                    <div class="list-group">
                        {% for call in call_logs %}
                            <div class="list-group-item clickable-call" onclick="window.location.href='{{ url_for('call_logs.call_log_view', id=call.id) }}';">
                                <div class="d-flex w-100 justify-content-between mb-2">
                                    <h6 class="mb-0">{{ call.call_date.strftime('%b %d, %Y') }}{% if call.call_date.hour != 0 or call.call_date.minute != 0 %} {{ call.call_date.strftime('%I:%M %p') }}{% endif %}</h6>
                                    {% if call.seller and not all_same_seller %}
                                        <a href="{{ url_for('sellers.seller_view', id=call.seller.id) }}" class="badge {{ get_seller_color(call.seller.id) }} text-decoration-none" onclick="event.stopPropagation();"><i class="bi bi-person"></i> {{ call.seller.name }}</a>
                                    {% endif %}
                                </div>
                                <div class="mb-2">{{ call.content|safe }}</div>
                                {% if call.topics|length > 0 or call.partners|length > 0 or call.milestones|length > 0 or call.msx_tasks.count() > 0 %}
                                    <div>
                                        {% for topic in call.topics %}
                                            <a href="{{ url_for('topics.topic_view', id=topic.id) }}" class="badge bg-warning text-dark text-decoration-none" onclick="event.stopPropagation();"><i class="bi bi-tag"></i> {{ topic.name }}</a>
                                        {% endfor %}
                                        {% for partner in call.partners %}
                                            <a href="{{ url_for('partners.partner_view', id=partner.id) }}" class="badge text-decoration-none" style="background-color: #6f42c1;" onclick="event.stopPropagation();"><i class="bi bi-building"></i> {{ partner.name }}</a>
                                        {% endfor %}
                                        {% for milestone in call.milestones %}
                                            <a href="{{ milestone.url }}" target="_blank" class="badge bg-success text-decoration-none" title="{{ milestone.display_text }}" onclick="event.stopPropagation();"><i class="bi bi-flag"></i> {{ milestone.display_text[:25] }}{% if milestone.display_text|length > 25 %}...{% endif %} <i class="bi bi-box-arrow-up-right"></i></a>
                                        {% endfor %}
                                        {% for task in call.msx_tasks %}
                                            {% if task.msx_task_url %}
                                            <a href="{{ task.msx_task_url }}" target="_blank" class="badge bg-secondary text-decoration-none" title="{{ task.subject }}" onclick="event.stopPropagation();"><i class="bi bi-check2-circle"></i> {{ task.subject[:20] }}{% if task.subject|length > 20 %}...{% endif %} <i class="bi bi-box-arrow-up-right"></i></a>
                                            {% else %}
                                            <span class="badge bg-secondary" title="{{ task.subject }}"><i class="bi bi-check2-circle"></i> {{ task.subject[:20] }}{% if task.subject|length > 20 %}...{% endif %}</span>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No call logs for this customer yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleNotesEdit() {
    document.getElementById('notesDisplay').style.display = 'none';
    document.getElementById('notesEmpty').style.display = 'none';
    document.getElementById('notesForm').style.display = 'block';
    document.getElementById('editNotesBtn').style.display = 'none';
    document.getElementById('notesTextarea').focus();
}

function cancelNotesEdit() {
    const textarea = document.getElementById('notesTextarea');
    const hasNotes = textarea.defaultValue.trim().length > 0;
    
    // Reset textarea to original value
    textarea.value = textarea.defaultValue;
    
    document.getElementById('notesForm').style.display = 'none';
    document.getElementById('editNotesBtn').style.display = 'inline-block';
    
    if (hasNotes) {
        document.getElementById('notesDisplay').style.display = 'block';
        document.getElementById('notesEmpty').style.display = 'none';
    } else {
        document.getElementById('notesDisplay').style.display = 'none';
        document.getElementById('notesEmpty').style.display = 'block';
    }
}
</script>
{% endblock %}









