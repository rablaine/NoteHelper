{% extends "base.html" %}
{% block title %}Import Revenue Data - NoteHelper{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('revenue.revenue_dashboard') }}">Revenue Alerts</a></li>
                    <li class="breadcrumb-item active">Import Data</li>
                </ol>
            </nav>
            <h1><i class="bi bi-upload"></i> Import Revenue Data</h1>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <!-- Import Form -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Upload CSV</h5>
                </div>
                <div class="card-body">
                    <form id="importForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">MSXI Revenue CSV File</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                            <div class="form-text">
                                Export from MSXI: ACR Details by Quarter / Month → Export Data → CSV
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="run_analysis" name="run_analysis" checked>
                                <label class="form-check-label" for="run_analysis">
                                    Run analysis after import
                                </label>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="importBtn">
                            <i class="bi bi-upload"></i> Import
                        </button>
                    </form>
                    
                    <!-- Progress Section -->
                    <div id="importProgress" class="mt-3 d-none">
                        <div class="progress mb-2" style="height: 20px;">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-muted mb-0"><i class="bi bi-hourglass-split"></i> Starting import...</p>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="importResults" class="mt-3 d-none"></div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> How to Export from MSXi</h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li>Go to <a href="https://aka.ms/msxi" target="_blank">aka.ms/msxi</a></li>
                        <li>Open report: <strong>SME&C ACR Service Level Subscription Details SL4 - WW</strong></li>
                        <li>Scroll to <strong>ACR Details by Quarter / Month</strong></li>
                        <li>Check <strong>ServiceLevel4</strong> on the left</li>
                        <li>Right-click in the view and choose <strong>Expand to next level</strong> and wait for that to load</li>
                        <li>Repeat step 5</li>
                        <li>Click <strong>... More Options</strong> → <strong>Export Data</strong> → <strong>Data with current layout</strong></li>
                        <li>Open .xlsx and save as .CSV</li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <!-- Import History -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Import History</h5>
                </div>
                <div class="card-body p-0">
                    {% if import_history %}
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>File</th>
                                    <th>Records</th>
                                    <th>New/Updated</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for imp in import_history %}
                                <tr>
                                    <td>{{ imp.imported_at.strftime('%b %d, %Y %H:%M') }}</td>
                                    <td><small>{{ imp.filename }}</small></td>
                                    <td>{{ imp.record_count }}</td>
                                    <td>{{ imp.records_created }} / {{ imp.records_updated }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4 text-muted">
                        <i class="bi bi-inbox"></i> No imports yet
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Data Range -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-calendar3"></i> Months in Database</h5>
                </div>
                <ul class="list-group list-group-flush">
                    {% if months_data %}
                    {% for m in months_data %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ m.fiscal_month }}</span>
                        <span class="badge bg-secondary">{{ m.record_count }} records</span>
                    </li>
                    {% endfor %}
                    {% else %}
                    <li class="list-group-item text-muted text-center">No data imported</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('importForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = this;
    const importBtn = document.getElementById('importBtn');
    const importProgress = document.getElementById('importProgress');
    const importResults = document.getElementById('importResults');
    const progressText = document.getElementById('progressText');
    const progressBar = document.getElementById('progressBar');
    
    // Disable form
    importBtn.disabled = true;
    importBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Importing...';
    
    // Warn user if they try to leave during import
    function warnOnLeave(e) { e.preventDefault(); e.returnValue = ''; }
    window.addEventListener('beforeunload', warnOnLeave);
    
    // Show progress
    importProgress.classList.remove('d-none');
    importResults.classList.add('d-none');
    
    const formData = new FormData(form);
    
    try {
        const response = await fetch('{{ url_for("revenue.revenue_import_stream") }}', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let finalResult = null;
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        if (data.message) {
                            progressText.innerHTML = `<i class="bi bi-hourglass-split"></i> ${data.message}`;
                        }
                        
                        if (data.progress !== undefined) {
                            progressBar.style.width = data.progress + '%';
                        }
                        
                        if (data.result) {
                            finalResult = data.result;
                        }
                    } catch (parseError) {
                        if (parseError.message !== 'Unexpected end of JSON input') {
                            console.error('Parse error:', parseError);
                        }
                    }
                }
            }
        }
        
        // Hide progress
        importProgress.classList.add('d-none');
        importResults.classList.remove('d-none');
        
        if (finalResult) {
            importResults.innerHTML = `
                <div class="alert alert-success">
                    <h6 class="mb-2"><i class="bi bi-check-circle"></i> Import Successful!</h6>
                    <ul class="mb-2">
                        <li>Records created: ${finalResult.records_created}</li>
                        <li>Records updated: ${finalResult.records_updated}</li>
                        <li>New months added: ${finalResult.new_months || 0}</li>
                    </ul>
                    <a href="{{ url_for('revenue.revenue_dashboard') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-arrow-right"></i> View Dashboard
                    </a>
                </div>
            `;
            form.reset();
        } else {
            throw new Error('Import completed but no results received');
        }
    } catch (error) {
        importProgress.classList.add('d-none');
        importResults.classList.remove('d-none');
        importResults.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> <strong>Error:</strong> ${error.message}
            </div>
        `;
    } finally {
        window.removeEventListener('beforeunload', warnOnLeave);
        importBtn.disabled = false;
        importBtn.innerHTML = '<i class="bi bi-upload"></i> Import';
    }
});
</script>{% endblock %}