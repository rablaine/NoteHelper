{% extends "base.html" %}
{% block title %}Import Revenue Data - NoteHelper{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('revenue.revenue_dashboard') }}">Revenue Analyzer</a></li>
                    <li class="breadcrumb-item active">Import Data</li>
                </ol>
            </nav>
            <h1><i class="bi bi-upload"></i> Import Revenue Data</h1>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <!-- Import Form -->
            <div class="card mb-4" id="revenueImportCard" style="position: relative;">
                <div id="revImportBrainrotToggle" class="brainrot-card-toggle brainrot-pos-top-right d-none">
                    <input type="checkbox" id="revImportBrainrotCheck">
                    <label for="revImportBrainrotCheck" class="small">brainrot mode</label>
                </div>
                <div class="card-header">
                    <h5 class="mb-0">Upload CSV</h5>
                </div>
                <div class="card-body">
                    <input type="file" id="file" accept=".csv" class="d-none">
                    <button type="button" class="btn btn-primary" id="importBtn">
                        <i class="bi bi-upload"></i> Import CSV
                    </button>
                    
                    <!-- Progress Section -->
                    <div id="importProgress" class="mt-3 d-none">
                        <div class="progress mb-2" style="height: 20px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p id="progressText" class="text-muted mb-0"><i class="bi bi-hourglass-split"></i> Starting import...</p>
                    </div>
                    
                    <!-- Results Section -->
                    <div id="importResults" class="mt-3 d-none"></div>
                </div>
            </div>

            <!-- Instructions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> How to Export from MSXi</h5>
                </div>
                <div class="card-body">
                    <ol>
                        <li>Go to <a href="https://msxinsights.microsoft.com/User/report/47b95fcd-1857-47f2-9c4b-8413a508ae00?reportTab=ReportSection146fc780baf4c55d7158" target="_blank">SME&C ACR Service Level Subscription Details SL4 - WW</a>
                            <br>Or go to <a href="https://aka.ms/msxi" target="_blank">https://aka.ms/msxi</a> and search for the report name</li>
                        <li>Scroll down to the <strong>"ACR Details by Quarter / Month"</strong> section</li>
                        <li>Under Choose Fields (left), check <strong>"ServiceLevel4"</strong></li>
                        <li>In Filters (right side), find <strong>ServiceCompGrouping</strong> and select your buckets</li>
                        <li>Right-click header <strong>"ACR Details by Quarter / Month"</strong> → <strong>Expand to next level</strong></li>
                        <li>Repeat step 5</li>
                        <li>Top right <strong>'...'</strong> → <strong>Export Data</strong> → <strong>Data with current layout</strong></li>
                        <li>Open in Excel → <strong>Save As</strong> → <strong>CSV (Comma delimited)</strong></li>
                    </ol>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <!-- Import History -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clock-history"></i> Import History</h5>
                </div>
                <ul class="list-group list-group-flush">
                    {% if import_history %}
                    {% for imp in import_history %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <small class="text-muted">{{ imp.imported_at.strftime('%b %d, %Y %H:%M') }}</small><br>
                                <small>{{ imp.filename }}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-secondary">{{ imp.record_count }} records</span><br>
                                <small class="text-muted">{{ imp.records_created }} new / {{ imp.records_updated }} updated</small>
                            </div>
                        </div>
                    </li>
                    {% endfor %}
                    {% else %}
                    <li class="list-group-item text-center text-muted">
                        <i class="bi bi-inbox"></i> No imports yet
                    </li>
                    {% endif %}
                </ul>
            </div>

            <!-- Data Range -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-calendar3"></i> Months in Database</h5>
                </div>
                <ul class="list-group list-group-flush">
                    {% if months_data %}
                    {% for m in months_data %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ m.fiscal_month }}</span>
                        <span class="badge bg-secondary">{{ m.record_count }} records</span>
                    </li>
                    {% endfor %}
                    {% else %}
                    <li class="list-group-item text-muted text-center">No data imported</li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
const importBtn = document.getElementById('importBtn');
const fileInput = document.getElementById('file');
const importProgress = document.getElementById('importProgress');
const importResults = document.getElementById('importResults');
const progressText = document.getElementById('progressText');
const progressBar = document.getElementById('progressBar');

// Button opens file picker
importBtn.addEventListener('click', function() {
    fileInput.click();
});

// File selected → kick off import immediately
fileInput.addEventListener('change', async function() {
    if (!this.files[0]) return;
    
    const file = this.files[0];
    
    // Disable button, show progress
    importBtn.disabled = true;
    importBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Importing...';
    
    function warnOnLeave(e) { e.preventDefault(); e.returnValue = ''; }
    window.addEventListener('beforeunload', warnOnLeave);
    
    importProgress.classList.remove('d-none');
    importResults.classList.add('d-none');

    // Show brainrot toggle during import
    const brToggle = document.getElementById('revImportBrainrotToggle');
    if (brToggle) brToggle.classList.remove('d-none');
    if (window.isBrainrotOn && window.isBrainrotOn() && window.showBrainrotPanel) {
        window.showBrainrotPanel();
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('run_analysis', 'y');
    
    try {
        const response = await fetch('{{ url_for("revenue.revenue_import_stream") }}', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error: ${response.status}`);
        }
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let finalResult = null;
        
        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split('\n');
            buffer = lines.pop();
            
            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        if (data.message) {
                            progressText.innerHTML = `<i class="bi bi-hourglass-split"></i> ${data.message}`;
                        }
                        
                        if (data.progress !== undefined) {
                            progressBar.style.width = data.progress + '%';
                        }
                        
                        if (data.result) {
                            finalResult = data.result;
                        }
                    } catch (parseError) {
                        if (parseError.message !== 'Unexpected end of JSON input') {
                            console.error('Parse error:', parseError);
                        }
                    }
                }
            }
        }
        
        importProgress.classList.add('d-none');
        importResults.classList.remove('d-none');
        
        if (finalResult) {
            importResults.innerHTML = `
                <div class="alert alert-success">
                    <h6 class="mb-2"><i class="bi bi-check-circle"></i> Import Successful!</h6>
                    <ul class="mb-2">
                        <li>Records created: ${finalResult.records_created}</li>
                        <li>Records updated: ${finalResult.records_updated}</li>
                        <li>New months added: ${finalResult.new_months || 0}</li>
                    </ul>
                    <a href="{{ url_for('revenue.revenue_dashboard') }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-arrow-right"></i> View Dashboard
                    </a>
                </div>
            `;
        } else {
            throw new Error('Import completed but no results received');
        }
    } catch (error) {
        importProgress.classList.add('d-none');
        importResults.classList.remove('d-none');
        importResults.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> <strong>Error:</strong> ${error.message}
            </div>
        `;
    } finally {
        window.removeEventListener('beforeunload', warnOnLeave);
        importBtn.disabled = false;
        importBtn.innerHTML = '<i class="bi bi-upload"></i> Import CSV';
        fileInput.value = '';
        // Hide brainrot toggle and panel when import finishes
        const brToggleEnd = document.getElementById('revImportBrainrotToggle');
        if (brToggleEnd) brToggleEnd.classList.add('d-none');
        if (window.hideBrainrotPanel) window.hideBrainrotPanel();
    }
});

// Wire up brainrot checkbox
(function() {
    const cb = document.getElementById('revImportBrainrotCheck');
    if (!cb) return;
    if (localStorage.getItem('brainrot') === '1') cb.checked = true;
    cb.addEventListener('change', function() {
        if (window.setBrainrot) window.setBrainrot(this.checked);
        if (this.checked && window.showBrainrotPanel) window.showBrainrotPanel();
        else if (!this.checked && window.hideBrainrotPanel) window.hideBrainrotPanel();
    });
})();
</script>{% endblock %}