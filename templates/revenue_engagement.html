{% extends "base.html" %}

{% block title %}Record Engagement - {{ analysis.customer_name }} - NoteHelper{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-chat-square-text"></i> Record Engagement</h1>
    <a href="{{ url_for('revenue.revenue_dashboard') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Analysis Details</h5>
            </div>
            <div class="card-body">
                <h4>{{ analysis.customer_name }}</h4>
                <p class="text-muted mb-2">{{ analysis.bucket }}</p>
                
                <span class="badge 
                    {% if analysis.category == 'CHURN_RISK' %}bg-danger
                    {% elif analysis.category == 'RECENT_DIP' %}bg-warning text-dark
                    {% elif analysis.category == 'EXPANSION_OPPORTUNITY' %}bg-success
                    {% elif analysis.category == 'VOLATILE' %}bg-info
                    {% else %}bg-secondary{% endif %} mb-3">
                    {{ analysis.category|replace('_', ' ')|title }}
                </span>
                
                {% if analysis.recommended_action and analysis.recommended_action != 'NO ACTION' %}
                    <p><strong>Recommended Action:</strong> {{ analysis.recommended_action }}</p>
                {% endif %}
                
                {% if analysis.engagement_rationale %}
                    <p><strong>Rationale:</strong> {{ analysis.engagement_rationale }}</p>
                {% endif %}
                
                <div class="mt-3">
                    <span class="text-muted">Avg Revenue:</span> ${{ "{:,.0f}".format(analysis.avg_revenue) }}/mo
                    {% if analysis.dollars_at_risk and analysis.dollars_at_risk > 0 %}
                        <span class="ms-3 text-danger">
                            <strong>${{ "{:,.0f}".format(analysis.dollars_at_risk) }} at risk</strong>
                        </span>
                    {% endif %}
                </div>
                
                {% if analysis.seller_name %}
                    <p class="mt-2"><strong>Seller:</strong> {{ analysis.seller_name }}</p>
                {% endif %}
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Record New Engagement</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <input type="hidden" name="next" value="{{ request.referrer or url_for('revenue.revenue_dashboard') }}">
                    
                    <div class="mb-3">
                        <label for="status" class="form-label">Status</label>
                        <select class="form-select" id="status" name="status" required>
                            <option value="pending">Pending - Sent to seller, awaiting response</option>
                            <option value="in_progress">In Progress - Seller acknowledged, working on it</option>
                            <option value="resolved">Resolved - Issue has been addressed</option>
                            <option value="dismissed">Dismissed - Not actionable / false positive</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="seller_response" class="form-label">Seller Response</label>
                        <textarea class="form-control" id="seller_response" name="seller_response" rows="3" 
                            placeholder="What did the seller say? Any action they're taking?"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="resolution_notes" class="form-label">Resolution Notes</label>
                        <textarea class="form-control" id="resolution_notes" name="resolution_notes" rows="2" 
                            placeholder="Your notes on how this was resolved (if resolved)"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Record Engagement
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Engagement History</h5>
            </div>
            <div class="card-body">
                {% if engagements %}
                    <div class="timeline">
                        {% for engagement in engagements %}
                            <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <span class="badge 
                                            {% if engagement.status == 'pending' %}bg-primary
                                            {% elif engagement.status == 'in_progress' %}bg-warning text-dark
                                            {% elif engagement.status == 'resolved' %}bg-success
                                            {% elif engagement.status == 'dismissed' %}bg-secondary
                                            {% else %}bg-info{% endif %}">
                                            {{ engagement.status|replace('_', ' ')|title }}
                                        </span>
                                    </div>
                                    <small class="text-muted">{{ engagement.created_at.strftime('%b %d, %Y %H:%M') }}</small>
                                </div>
                                
                                <div class="small text-muted mt-1">
                                    Sent as: {{ engagement.category_when_sent }} - {{ engagement.action_when_sent }}
                                </div>
                                
                                {% if engagement.seller_response %}
                                    <p class="mt-2 mb-1"><strong>Seller Response:</strong></p>
                                    <p class="mb-1">{{ engagement.seller_response }}</p>
                                    {% if engagement.response_date %}
                                        <small class="text-muted">Responded: {{ engagement.response_date.strftime('%b %d, %Y') }}</small>
                                    {% endif %}
                                {% endif %}
                                
                                {% if engagement.resolution_notes %}
                                    <p class="mt-2 mb-1"><strong>Resolution:</strong></p>
                                    <p class="mb-0">{{ engagement.resolution_notes }}</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted">No engagement recorded yet for this analysis.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
