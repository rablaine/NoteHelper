{% extends "base.html" %}

{% block title %}{{ 'Edit' if call_log else 'New' }} Call Log - NoteHelper{% endblock %}

{% block extra_css %}
<!-- Quill Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
{% if not call_log and previous_calls %}
<style>
    /* Override container for full-width layout when showing previous calls */
    main.container {
        max-width: min(100%, 1900px) !important;
        padding-left: 2rem !important;
        padding-right: 2rem !important;
        width: 100% !important;
    }
    
    /* Previous calls section styling */
    .previous-calls-card {
        display: flex;
        flex-direction: column;
    }
    
    .previous-calls-body {
        overflow-y: auto;
    }
</style>
{% endif %}
{% endblock %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">{{ 'Edit' if call_log else 'New' }} Call Log{% if not call_log and preselect_customer %} - {{ preselect_customer.name }}{% endif %}</h1>
    <div id="draftSaveIndicator" class="text-muted small" style="opacity: 0; transition: opacity 0.3s;">
        <i class="bi bi-check-circle text-success"></i> Draft saved
    </div>
</div>

<div class="row">
    <div class="col-md-{% if not call_log and previous_calls %}6{% else %}10{% endif %}">
        <div class="card">
            <div class="card-body">
                <form method="POST" id="callLogForm">
                    <input type="hidden" name="referrer" value="{{ referrer if referrer else '' }}">
                    
                    <!-- Customer (full width) -->
                    <div class="mb-3">
                        <label for="customer_id" class="form-label">Customer *</label>
                        <select class="form-select" id="customer_id" name="customer_id" required {% if not call_log and preselect_customer_id %}disabled{% endif %}>
                            <option value="">-- Select customer --</option>
                            {% for customer in customers %}
                                <option value="{{ customer.id }}"
                                    {% if (call_log and call_log.customer_id == customer.id) or (preselect_customer_id and preselect_customer_id == customer.id) %}selected{% endif %}>
                                    {{ customer.name }} ({{ customer.tpid }})
                                </option>
                            {% endfor %}
                        </select>
                        {% if not call_log and preselect_customer_id %}
                            <input type="hidden" name="customer_id" value="{{ preselect_customer_id }}">
                        {% endif %}
                        {% if call_log and call_log.customer and call_log.customer.seller %}
                            <div class="form-text">Seller: <strong>{{ call_log.customer.seller.name }}</strong></div>
                        {% elif preselect_customer and preselect_customer.seller %}
                            <div class="form-text">Seller: <strong>{{ preselect_customer.seller.name }}</strong></div>
                        {% endif %}
                    </div>
                    
                    <!-- Call Date and Partners side-by-side -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="call_date" class="form-label">Call Date *</label>
                            <input type="date" class="form-control" id="call_date" name="call_date" 
                                   value="{% if call_log %}{{ call_log.call_date.strftime('%Y-%m-%d') }}{% else %}{{ today }}{% endif %}" 
                                   required>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="partner_search" class="form-label">Partners</label>
                            <input type="text" class="form-control" id="partner_search" 
                                   placeholder="Search and add partners..." autocomplete="off">
                            <div id="partner_dropdown" class="list-group mt-1" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                            
                            <div id="selected_partners" class="mt-2 d-flex flex-wrap gap-2">
                                {% if call_log %}
                                    {% for partner in call_log.partners %}
                                        <span class="badge d-flex align-items-center" style="background-color: #6f42c1;" data-partner-id="{{ partner.id }}">
                                            <i class="bi bi-building me-1"></i> {{ partner.name }}
                                            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7rem;" onclick="removePartner({{ partner.id }})"></button>
                                            <input type="hidden" name="partner_ids" value="{{ partner.id }}">
                                        </span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="topic_search" class="form-label mb-0">Topics</label>
                            {% if ai_config and ai_config.enabled %}
                            <button type="button" class="btn btn-sm btn-outline-primary" id="aiSuggestBtn">
                                <i class="bi bi-stars"></i> <span id="aiSuggestBtnText">Auto-tag with AI</span>
                            </button>
                            {% endif %}
                        </div>
                        <input type="text" class="form-control" id="topic_search" 
                               placeholder="Search and add topics..." autocomplete="off">
                        <div id="topic_dropdown" class="list-group mt-1" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                        
                        <div id="selected_topics" class="mt-2 d-flex flex-wrap gap-2">
                            {% if call_log %}
                                {% for topic in call_log.topics %}
                                    <span class="badge bg-warning text-dark d-flex align-items-center" data-topic-id="{{ topic.id }}">
                                        <i class="bi bi-tag me-1"></i> {{ topic.name }}
                                        <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7rem;" onclick="removeTopic({{ topic.id }})"></button>
                                        <input type="hidden" name="topic_ids" value="{{ topic.id }}">
                                    </span>
                                {% endfor %}
                            {% endif %}
                            {% if preselect_topic_id %}
                                {% for topic in topics %}
                                    {% if topic.id == preselect_topic_id %}
                                        <span class="badge bg-warning text-dark d-flex align-items-center" data-topic-id="{{ topic.id }}">
                                            <i class="bi bi-tag me-1"></i> {{ topic.name }}
                                            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7rem;" onclick="removeTopic({{ topic.id }})"></button>
                                            <input type="hidden" name="topic_ids" value="{{ topic.id }}">
                                        </span>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div id="editor" style="height: 400px;">{{ call_log.content|safe if call_log else '' }}</div>
                        <textarea name="content" id="content" style="display:none;"></textarea>
                        <div class="form-text">Use rich formatting to capture call details, action items, and follow-ups</div>
                    </div>
                    
                    <!-- Milestone Picker -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="milestone_search" class="form-label mb-0">
                                <i class="bi bi-flag"></i> Milestone (optional)
                            </label>
                            <div id="milestone_loading" class="text-muted small" style="display: none;">
                                <span class="spinner-border spinner-border-sm me-1"></span> Loading milestones...
                            </div>
                        </div>
                        <input type="text" class="form-control" id="milestone_search" 
                               placeholder="Search milestones..." autocomplete="off" disabled>
                        <div id="milestone_dropdown" class="list-group mt-1" style="display: none; position: absolute; z-index: 1000; max-height: 300px; overflow-y: auto;"></div>
                        <div class="form-text" id="milestone_help_text">Select a customer to load milestones from MSX</div>
                        
                        <!-- Inline TPID Link Section (shown when customer has no MSX link) -->
                        <div id="inline_tpid_link" class="mt-2" style="display: none;">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark py-2">
                                    <i class="bi bi-link-45deg me-1"></i> Link Customer to MSX
                                </div>
                                <div class="card-body py-2">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <span class="text-muted small">TPID:</span>
                                        <strong id="inline_tpid_value">-</strong>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="inline_lookup_btn" onclick="inlineLookupTPID()">
                                            <i class="bi bi-search"></i> Lookup
                                        </button>
                                    </div>
                                    <div class="input-group input-group-sm">
                                        <input type="url" class="form-control" id="inline_tpid_url" 
                                               placeholder="MSX Account URL will appear here..." readonly>
                                        <button type="button" class="btn btn-success" id="inline_save_btn" style="display: none;" onclick="inlineSaveTPID()">
                                            <i class="bi bi-check"></i> Save & Load Milestones
                                        </button>
                                    </div>
                                    <div id="inline_lookup_result" class="small mt-1"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="selected_milestone" class="mt-2">
                            {% if call_log and call_log.milestones %}
                                {% for milestone in call_log.milestones %}
                                <div class="card border-success" data-milestone-id="{{ milestone.id }}" data-msx-milestone-id="{{ milestone.msx_milestone_id }}">
                                    <div class="card-body py-2 px-3">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <strong>
                                                    <i class="bi bi-flag me-1"></i>
                                                    {% if milestone.msx_milestone_id %}
                                                        <a href="{{ milestone.url }}" target="_blank">{{ milestone.display_text }}</a>
                                                    {% else %}
                                                        {{ milestone.display_text }}
                                                    {% endif %}
                                                </strong>
                                                {% if milestone.msx_status %}
                                                <span class="badge ms-2 
                                                    {% if milestone.msx_status == 'On Track' %}bg-success
                                                    {% elif milestone.msx_status == 'At Risk' %}bg-warning text-dark
                                                    {% elif milestone.msx_status == 'Blocked' %}bg-danger
                                                    {% elif milestone.msx_status == 'Completed' %}bg-secondary
                                                    {% else %}bg-light text-dark{% endif %}">
                                                    {{ milestone.msx_status }}
                                                </span>
                                                {% endif %}
                                                {% if milestone.opportunity_name %}
                                                <br><small class="text-muted">{{ milestone.opportunity_name }}</small>
                                                {% endif %}
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMilestone()">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <input type="hidden" name="milestone_msx_id" value="{{ milestone.msx_milestone_id }}">
                                    <input type="hidden" name="milestone_ids" value="{{ milestone.id }}">
                                </div>
                                {% endfor %}
                            {% endif %}
                        </div>
                        
                        <!-- Task Creation Section (appears when milestone selected) -->
                        <div id="task_creation_section" class="mt-3" style="display: none;">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white py-2">
                                    <i class="bi bi-plus-circle me-1"></i> Create Task on Milestone
                                </div>
                                <div class="card-body">
                                    <!-- Task Created Status (shown after successful creation) -->
                                    <div id="task_created_status" class="alert alert-success mb-3" style="display: none;">
                                        <i class="bi bi-check-circle-fill me-1"></i>
                                        <strong>Task Created!</strong>
                                        <a href="#" id="task_created_link" target="_blank" class="ms-2">View in MSX</a>
                                        <button type="button" class="btn btn-sm btn-outline-secondary float-end" onclick="clearCreatedTask()">
                                            <i class="bi bi-x"></i> Clear
                                        </button>
                                    </div>
                                    
                                    <!-- Task Form (hidden after task created) -->
                                    <div id="task_form_fields">
                                        <div class="mb-2">
                                            <label for="task_subject" class="form-label small mb-1">Task Title *</label>
                                            <input type="text" class="form-control form-control-sm" id="task_subject" name="task_subject" 
                                                   placeholder="Brief task description...">
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-md-8">
                                                <label for="task_category" class="form-label small mb-1">Category *</label>
                                                <select class="form-select form-select-sm" id="task_category" name="task_category">
                                                    <option value="">-- Select task category --</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="task_duration" class="form-label small mb-1">Duration (min)</label>
                                                <input type="number" class="form-control form-control-sm" id="task_duration" name="task_duration" 
                                                       value="60" min="15" step="15">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="task_description" class="form-label small mb-1">Description (optional)</label>
                                            <textarea class="form-control form-control-sm" id="task_description" name="task_description" 
                                                      rows="2" placeholder="Additional details..."></textarea>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <button type="button" class="btn btn-primary btn-sm" id="create_task_btn" onclick="createTaskInMSX()">
                                                <i class="bi bi-cloud-upload me-1"></i> Create Task in MSX
                                            </button>
                                            <small class="text-muted">Task will be linked when you save the call log</small>
                                        </div>
                                        <div id="task_creation_error" class="alert alert-danger mt-2" style="display: none;"></div>
                                    </div>
                                    
                                    <!-- Hidden fields to store created task info -->
                                    <input type="hidden" id="created_task_id" name="created_task_id" value="">
                                    <input type="hidden" id="created_task_url" name="created_task_url" value="">
                                    <input type="hidden" id="created_task_category_name" name="created_task_category_name" value="">
                                    <input type="hidden" id="created_task_is_hok" name="created_task_is_hok" value="">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <div>
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-check-circle"></i> Save Call Log
                            </button>
                            {% if not call_log %}
                            <button type="button" class="btn btn-outline-danger ms-2" onclick="discardDraft()">
                                <i class="bi bi-trash"></i> Discard Draft
                            </button>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('call_logs.call_logs_list') }}" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    {% if not call_log and previous_calls %}
    <div class="col-md-6">
        <div class="card previous-calls-card">
            <div class="card-header">
                <h5 class="mb-0">Previous Call Logs ({{ previous_calls|length }})</h5>
            </div>
            <div class="card-body previous-calls-body">
                {% for call in previous_calls %}
                    <div class="mb-4 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0">{{ call.call_date.strftime('%b %d, %Y') }}</h6>
                            <a href="{{ url_for('call_logs.call_log_view', id=call.id) }}" class="btn btn-sm btn-outline-secondary" target="_blank">
                                <i class="bi bi-box-arrow-up-right"></i> View
                            </a>
                        </div>
                        {% if call.topics|length > 0 %}
                            <div class="mb-2">
                                {% for topic in call.topics %}
                                    <span class="badge bg-warning text-dark"><i class="bi bi-tag"></i> {{ topic.name }}</span>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div>{{ call.content|safe }}</div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<!-- Quill Rich Text Editor -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script>
// Initialize Quill editor
var quill = new Quill('#editor', {
    theme: 'snow',
    modules: {
        toolbar: [
            [{ 'header': [1, 2, 3, false] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'list': 'ordered'}, { 'list': 'bullet' }],
            [{ 'indent': '-1'}, { 'indent': '+1' }],
            ['link'],
            ['clean']
        ]
    }
});

// Sync editor content to hidden textarea on form submit
document.getElementById('callLogForm').onsubmit = function(e) {
    var content = document.querySelector('textarea[name=content]');
    content.value = quill.root.innerHTML;
    
    // Validation: check if content is empty (only whitespace/tags)
    var tempDiv = document.createElement('div');
    tempDiv.innerHTML = content.value;
    var textContent = tempDiv.textContent || tempDiv.innerText || '';
    
    if (textContent.trim().length === 0) {
        e.preventDefault();
        e.stopImmediatePropagation(); // Stop other submit handlers from running
        alert('Call notes cannot be empty.');
        quill.focus();
        return false;
    }
    
    return true;
};

// Topic search and selection functionality
const allTopics = [
    {% for topic in topics %}
        { id: {{ topic.id }}, name: "{{ topic.name|escape }}", description: "{{ topic.description|escape if topic.description else '' }}" },
    {% endfor %}
];

// Customer data for inline TPID lookup
const customerData = {
    {% for customer in customers %}
        {{ customer.id }}: { tpid: "{{ customer.tpid or '' }}", name: {{ customer.name | tojson }} },
    {% endfor %}
};

const topicSearch = document.getElementById('topic_search');
const topicDropdown = document.getElementById('topic_dropdown');
const selectedTopicsContainer = document.getElementById('selected_topics');
let currentMatches = [];
let selectedIndex = -1;

topicSearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    
    if (searchTerm.length === 0) {
        topicDropdown.style.display = 'none';
        currentMatches = [];
        selectedIndex = -1;
        return;
    }
    
    // Filter topics case-insensitively
    currentMatches = allTopics.filter(topic => 
        topic.name.toLowerCase().includes(searchTerm) && 
        !isTopicSelected(topic.id)
    );
    
    if (currentMatches.length > 0) {
        selectedIndex = 0; // Auto-select first item
        renderDropdown();
        topicDropdown.style.display = 'block';
        topicDropdown.style.width = topicSearch.offsetWidth + 'px';
    } else {
        topicDropdown.style.display = 'none';
        currentMatches = [];
        selectedIndex = -1;
    }
});

// Keyboard navigation
topicSearch.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowDown' && currentMatches.length > 0) {
        e.preventDefault();
        selectedIndex = (selectedIndex + 1) % currentMatches.length;
        renderDropdown();
    } else if (e.key === 'ArrowUp' && currentMatches.length > 0) {
        e.preventDefault();
        selectedIndex = selectedIndex <= 0 ? currentMatches.length - 1 : selectedIndex - 1;
        renderDropdown();
    } else if (e.key === 'Tab') {
        e.preventDefault();
        
        if (currentMatches.length > 0 && selectedIndex >= 0 && selectedIndex < currentMatches.length) {
            // Select existing topic from search results
            const topic = currentMatches[selectedIndex];
            addTopic(topic.id, topic.name);
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        
        // Only create new topic on Enter if there are no matches
        if (currentMatches.length === 0) {
            const searchTerm = topicSearch.value.trim();
            if (searchTerm.length > 0) {
                createNewTopic(searchTerm);
            }
        } else if (selectedIndex >= 0 && selectedIndex < currentMatches.length) {
            // Select the highlighted topic
            const topic = currentMatches[selectedIndex];
            addTopic(topic.id, topic.name);
        }
    } else if (e.key === 'Escape') {
        topicDropdown.style.display = 'none';
        currentMatches = [];
        selectedIndex = -1;
    }
});

function renderDropdown() {
    topicDropdown.innerHTML = currentMatches.map((topic, index) => 
        `<button type="button" class="list-group-item list-group-item-action ${index === selectedIndex ? 'active' : ''}" 
            data-topic-id="${topic.id}" 
            data-topic-name="${topic.name.replace(/"/g, '&quot;')}"
            data-topic-index="${index}"
            onmouseenter="handleTopicHover(${index})"
            onclick="handleTopicClick(${topic.id}, '${topic.name.replace(/'/g, "\\'")}')">
            <i class="bi bi-tag"></i> ${topic.name}
            ${topic.description ? '<br><small class="text-muted">' + topic.description + '</small>' : ''}
        </button>`
    ).join('');
}

function handleTopicHover(index) {
    selectedIndex = index;
    // Update active class
    topicDropdown.querySelectorAll('button').forEach((btn, i) => {
        if (i === index) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

function handleTopicClick(topicId, topicName) {
    addTopic(topicId, topicName);
}

// Hide dropdown when clicking outside
document.addEventListener('click', function(e) {
    // Only hide if clicking outside both the search input and the dropdown
    if (!topicSearch.contains(e.target) && !topicDropdown.contains(e.target)) {
        topicDropdown.style.display = 'none';
        currentMatches = [];
        selectedIndex = -1;
    }
});

function isTopicSelected(topicId) {
    return selectedTopicsContainer.querySelector(`[data-topic-id="${topicId}"]`) !== null;
}

function addTopic(topicId, topicName) {
    if (isTopicSelected(topicId)) return;
    
    const badge = document.createElement('span');
    badge.className = 'badge bg-warning text-dark d-flex align-items-center';
    badge.setAttribute('data-topic-id', topicId);
    badge.innerHTML = `
        <i class="bi bi-tag me-1"></i> ${topicName}
        <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7rem;" onclick="removeTopic(${topicId})"></button>
        <input type="hidden" name="topic_ids" value="${topicId}">
    `;
    
    selectedTopicsContainer.appendChild(badge);
    topicSearch.value = '';
    topicDropdown.style.display = 'none';
    currentMatches = [];
    selectedIndex = -1;
    topicSearch.focus(); // Keep focus on search box
    
    // Trigger debounced auto-save
    debouncedAutoSave();
}

function removeTopic(topicId) {
    const badge = selectedTopicsContainer.querySelector(`span[data-topic-id="${topicId}"]`);
    if (badge) {
        badge.remove();
        // Trigger debounced auto-save
        debouncedAutoSave();
    }
}

function createNewTopic(topicName) {
    // Show loading indicator
    topicSearch.disabled = true;
    topicSearch.placeholder = 'Creating topic...';
    
    fetch('/api/topic/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name: topicName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            // Add newly created or existing topic to the list
            allTopics.push({
                id: data.id,
                name: data.name,
                description: data.description
            });
            
            // Add to selected topics
            addTopic(data.id, data.name);
            
            // Show feedback
            if (data.existed) {
                console.log('Topic already existed, added to selection');
            } else {
                console.log('New topic created and added');
            }
        }
    })
    .catch(error => {
        console.error('Error creating topic:', error);
        alert('Failed to create topic. Please try again.');
    })
    .finally(() => {
        // Reset search box
        topicSearch.disabled = false;
        topicSearch.placeholder = 'Search and add topics...';
        topicSearch.value = '';
        topicSearch.focus();
    });
}

// ===== PARTNER SEARCH AND SELECTION FUNCTIONALITY =====
const allPartners = [
    {% for partner in partners %}
        { id: {{ partner.id }}, name: "{{ partner.name|escape }}" },
    {% endfor %}
];

const partnerSearch = document.getElementById('partner_search');
const partnerDropdown = document.getElementById('partner_dropdown');
const selectedPartnersContainer = document.getElementById('selected_partners');
let currentPartnerMatches = [];
let selectedPartnerIndex = -1;

partnerSearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    
    if (searchTerm.length === 0) {
        partnerDropdown.style.display = 'none';
        currentPartnerMatches = [];
        selectedPartnerIndex = -1;
        return;
    }
    
    // Filter partners case-insensitively
    currentPartnerMatches = allPartners.filter(partner => 
        partner.name.toLowerCase().includes(searchTerm) && 
        !isPartnerSelected(partner.id)
    );
    
    if (currentPartnerMatches.length > 0) {
        selectedPartnerIndex = 0; // Auto-select first item
        renderPartnerDropdown();
        partnerDropdown.style.display = 'block';
        partnerDropdown.style.width = partnerSearch.offsetWidth + 'px';
    } else {
        partnerDropdown.style.display = 'none';
        currentPartnerMatches = [];
        selectedPartnerIndex = -1;
    }
});

// Keyboard navigation for partners
partnerSearch.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowDown' && currentPartnerMatches.length > 0) {
        e.preventDefault();
        selectedPartnerIndex = (selectedPartnerIndex + 1) % currentPartnerMatches.length;
        renderPartnerDropdown();
    } else if (e.key === 'ArrowUp' && currentPartnerMatches.length > 0) {
        e.preventDefault();
        selectedPartnerIndex = selectedPartnerIndex <= 0 ? currentPartnerMatches.length - 1 : selectedPartnerIndex - 1;
        renderPartnerDropdown();
    } else if (e.key === 'Tab') {
        e.preventDefault();
        
        if (currentPartnerMatches.length > 0 && selectedPartnerIndex >= 0 && selectedPartnerIndex < currentPartnerMatches.length) {
            // Select existing partner from search results
            const partner = currentPartnerMatches[selectedPartnerIndex];
            addPartner(partner.id, partner.name);
        }
    } else if (e.key === 'Enter') {
        e.preventDefault();
        
        // Only create new partner on Enter if there are no matches
        if (currentPartnerMatches.length === 0) {
            const searchTerm = partnerSearch.value.trim();
            if (searchTerm.length > 0) {
                createNewPartner(searchTerm);
            }
        } else if (selectedPartnerIndex >= 0 && selectedPartnerIndex < currentPartnerMatches.length) {
            // Select the highlighted partner
            const partner = currentPartnerMatches[selectedPartnerIndex];
            addPartner(partner.id, partner.name);
        }
    } else if (e.key === 'Escape') {
        partnerDropdown.style.display = 'none';
        currentPartnerMatches = [];
        selectedPartnerIndex = -1;
    }
});

function renderPartnerDropdown() {
    partnerDropdown.innerHTML = currentPartnerMatches.map((partner, index) => 
        `<button type="button" class="list-group-item list-group-item-action ${index === selectedPartnerIndex ? 'active' : ''}" 
            data-partner-id="${partner.id}" 
            data-partner-name="${partner.name.replace(/"/g, '&quot;')}"
            data-partner-index="${index}"
            onmouseenter="handlePartnerHover(${index})"
            onclick="handlePartnerClick(${partner.id}, '${partner.name.replace(/'/g, "\\'")}')">
            <i class="bi bi-building"></i> ${partner.name}
        </button>`
    ).join('');
}

function handlePartnerHover(index) {
    selectedPartnerIndex = index;
    // Update active class
    partnerDropdown.querySelectorAll('button').forEach((btn, i) => {
        if (i === index) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
}

function handlePartnerClick(partnerId, partnerName) {
    addPartner(partnerId, partnerName);
}

// Hide partner dropdown when clicking outside
document.addEventListener('click', function(e) {
    // Only hide if clicking outside both the search input and the dropdown
    if (!partnerSearch.contains(e.target) && !partnerDropdown.contains(e.target)) {
        partnerDropdown.style.display = 'none';
        currentPartnerMatches = [];
        selectedPartnerIndex = -1;
    }
});

function isPartnerSelected(partnerId) {
    return selectedPartnersContainer.querySelector(`[data-partner-id="${partnerId}"]`) !== null;
}

function addPartner(partnerId, partnerName) {
    if (isPartnerSelected(partnerId)) return;
    
    const badge = document.createElement('span');
    badge.className = 'badge d-flex align-items-center';
    badge.style.backgroundColor = '#6f42c1'; // Purple color
    badge.setAttribute('data-partner-id', partnerId);
    badge.innerHTML = `
        <i class="bi bi-building me-1"></i> ${partnerName}
        <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.7rem;" onclick="removePartner(${partnerId})"></button>
        <input type="hidden" name="partner_ids" value="${partnerId}">
    `;
    
    selectedPartnersContainer.appendChild(badge);
    partnerSearch.value = '';
    partnerDropdown.style.display = 'none';
    currentPartnerMatches = [];
    selectedPartnerIndex = -1;
    partnerSearch.focus(); // Keep focus on search box
    
    // Trigger debounced auto-save
    debouncedAutoSave();
}

function removePartner(partnerId) {
    const badge = selectedPartnersContainer.querySelector(`span[data-partner-id="${partnerId}"]`);
    if (badge) {
        badge.remove();
        // Trigger debounced auto-save
        debouncedAutoSave();
    }
}

function createNewPartner(partnerName) {
    // Show loading indicator
    partnerSearch.disabled = true;
    partnerSearch.placeholder = 'Creating partner...';
    
    fetch('/api/partners/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ name: partnerName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            // Add newly created or existing partner to the list
            allPartners.push({
                id: data.id,
                name: data.name
            });
            
            // Add to selected partners
            addPartner(data.id, data.name);
            
            // Show feedback
            if (data.existed) {
                console.log('Partner already existed, added to selection');
            } else {
                console.log('New partner created and added');
            }
        }
    })
    .catch(error => {
        console.error('Error creating partner:', error);
        alert('Failed to create partner. Please try again.');
    })
    .finally(() => {
        // Reset search box
        partnerSearch.disabled = false;
        partnerSearch.placeholder = 'Search and add partners...';
        partnerSearch.value = '';
        partnerSearch.focus();
    });
}

// ===== MILESTONE SEARCH AND SELECTION FUNCTIONALITY =====
let allMilestones = [];
let currentMilestoneMatches = [];
let selectedMilestoneIndex = -1;
let taskCategories = [];
let selectedMilestoneData = null;

const milestoneSearch = document.getElementById('milestone_search');
const milestoneDropdown = document.getElementById('milestone_dropdown');
const selectedMilestoneContainer = document.getElementById('selected_milestone');
const milestoneLoading = document.getElementById('milestone_loading');
const milestoneHelpText = document.getElementById('milestone_help_text');
const taskCreationSection = document.getElementById('task_creation_section');
const taskCategorySelect = document.getElementById('task_category');

// Load task categories on page load
fetch('/api/msx/task-categories')
    .then(response => response.json())
    .then(data => {
        if (data.success && data.categories) {
            taskCategories = data.categories;
            populateTaskCategories();
        }
    })
    .catch(error => console.error('Failed to load task categories:', error));

function populateTaskCategories() {
    taskCategorySelect.innerHTML = '<option value="">-- Select task category --</option>';
    taskCategories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat.value;
        option.textContent = cat.label;
        if (cat.is_hok) {
            option.style.fontWeight = 'bold';
            option.textContent = 'â˜… ' + cat.label;
        }
        taskCategorySelect.appendChild(option);
    });
}

// Load milestones when customer is selected
let currentCustomerId = null;

function loadMilestonesForCustomer(customerId) {
    currentCustomerId = customerId;
    const inlineTpidSection = document.getElementById('inline_tpid_link');
    
    if (!customerId) {
        allMilestones = [];
        milestoneSearch.disabled = true;
        milestoneSearch.placeholder = 'Search milestones...';
        milestoneHelpText.textContent = 'Select a customer to load milestones from MSX';
        inlineTpidSection.style.display = 'none';
        return;
    }
    
    // Hide inline TPID section initially
    inlineTpidSection.style.display = 'none';
    
    // Show loading
    milestoneLoading.style.display = 'inline';
    milestoneSearch.disabled = true;
    milestoneSearch.placeholder = 'Loading milestones...';
    milestoneHelpText.textContent = 'Fetching milestones from MSX...';
    
    fetch(`/api/msx/milestones-for-customer/${customerId}`)
        .then(response => response.json())
        .then(data => {
            milestoneLoading.style.display = 'none';
            
            if (data.success && data.milestones) {
                allMilestones = data.milestones;
                milestoneSearch.disabled = false;
                milestoneSearch.placeholder = `Search ${allMilestones.length} milestone${allMilestones.length !== 1 ? 's' : ''}...`;
                milestoneHelpText.textContent = `Found ${allMilestones.length} milestone${allMilestones.length !== 1 ? 's' : ''} for this customer`;
                inlineTpidSection.style.display = 'none';
            } else if (data.needs_tpid) {
                milestoneSearch.placeholder = 'Link customer to MSX first';
                milestoneHelpText.innerHTML = '<span class="text-warning"><i class="bi bi-exclamation-triangle"></i> Customer has no MSX account linked</span>';
                
                // Show inline TPID link section
                const customer = customerData[customerId];
                if (customer) {
                    document.getElementById('inline_tpid_value').textContent = customer.tpid || 'Not set';
                    document.getElementById('inline_tpid_url').value = '';
                    document.getElementById('inline_lookup_result').innerHTML = '';
                    document.getElementById('inline_save_btn').style.display = 'none';
                    document.getElementById('inline_tpid_url').readOnly = true;
                    inlineTpidSection.style.display = 'block';
                }
            } else {
                milestoneSearch.placeholder = 'Could not load milestones';
                milestoneHelpText.innerHTML = `<span class="text-danger">${data.error || 'Unknown error'}</span>`;
            }
        })
        .catch(error => {
            console.error('Failed to load milestones:', error);
            milestoneLoading.style.display = 'none';
            milestoneSearch.placeholder = 'Error loading milestones';
            milestoneHelpText.innerHTML = '<span class="text-danger">Failed to connect to MSX</span>';
        });
}

// Inline TPID lookup
async function inlineLookupTPID() {
    const btn = document.getElementById('inline_lookup_btn');
    const resultEl = document.getElementById('inline_lookup_result');
    const urlInput = document.getElementById('inline_tpid_url');
    const saveBtn = document.getElementById('inline_save_btn');
    
    const customer = customerData[currentCustomerId];
    if (!customer || !customer.tpid) {
        resultEl.innerHTML = '<span class="text-danger">Customer has no TPID set</span>';
        return;
    }
    
    // Show loading
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    resultEl.innerHTML = '<span class="text-muted">Looking up in MSX...</span>';
    
    try {
        const response = await fetch(`/api/msx/lookup-tpid/${customer.tpid}?customer_name=${encodeURIComponent(customer.name)}`);
        const data = await response.json();
        
        if (!data.success) {
            resultEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${data.error || 'Lookup failed'}</span>`;
        } else if (data.count === 0) {
            resultEl.innerHTML = '<span class="text-warning"><i class="bi bi-exclamation-triangle"></i> No accounts found for this TPID</span>';
        } else if (data.url) {
            // Success - auto-fill URL
            urlInput.value = data.url;
            urlInput.readOnly = false;
            saveBtn.style.display = 'inline-block';
            resultEl.innerHTML = `<span class="text-success"><i class="bi bi-check-circle"></i> Found: ${data.account_name || 'Account'}</span>`;
        } else if (data.name_mismatch) {
            resultEl.innerHTML = `<span class="text-warning"><i class="bi bi-exclamation-triangle"></i> MSX has "${data.msx_account_name}" - verify this is correct</span>`;
            // Still allow manual selection
            if (data.accounts && data.accounts.length > 0) {
                urlInput.value = data.accounts[0].url;
                urlInput.readOnly = false;
                saveBtn.style.display = 'inline-block';
            }
        } else if (data.count > 1) {
            // Multiple matches - show first Top parent or first account
            const topAccount = data.accounts.find(a => a.parenting_level && a.parenting_level.toLowerCase().includes('top')) || data.accounts[0];
            urlInput.value = topAccount.url;
            urlInput.readOnly = false;
            saveBtn.style.display = 'inline-block';
            resultEl.innerHTML = `<span class="text-warning"><i class="bi bi-exclamation-triangle"></i> ${data.count} accounts found - using: ${topAccount.name}</span>`;
        }
    } catch (error) {
        console.error('Inline TPID lookup error:', error);
        resultEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> Network error</span>';
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-search"></i> Lookup';
    }
}

// Save TPID URL and reload milestones
async function inlineSaveTPID() {
    const urlInput = document.getElementById('inline_tpid_url');
    const saveBtn = document.getElementById('inline_save_btn');
    const resultEl = document.getElementById('inline_lookup_result');
    
    const url = urlInput.value.trim();
    if (!url) {
        resultEl.innerHTML = '<span class="text-danger">No URL to save</span>';
        return;
    }
    
    // Show saving
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';
    
    try {
        const response = await fetch(`/api/customer/${currentCustomerId}/tpid-url`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tpid_url: url })
        });
        const data = await response.json();
        
        if (data.success) {
            resultEl.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Saved! Loading milestones...</span>';
            
            // Hide the TPID link section and reload milestones
            setTimeout(() => {
                loadMilestonesForCustomer(currentCustomerId);
            }, 500);
        } else {
            resultEl.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${data.error || 'Save failed'}</span>`;
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="bi bi-check"></i> Save & Load Milestones';
        }
    } catch (error) {
        console.error('Save TPID URL error:', error);
        resultEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle"></i> Network error</span>';
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="bi bi-check"></i> Save & Load Milestones';
    }
}

// Listen for customer changes
document.getElementById('customer_id').addEventListener('change', function() {
    loadMilestonesForCustomer(this.value);
    // Clear selected milestone when customer changes
    removeMilestone();
});

// Load milestones on page load if customer is already selected
const initialCustomerId = document.getElementById('customer_id').value;
if (initialCustomerId) {
    loadMilestonesForCustomer(initialCustomerId);
}

milestoneSearch.addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase().trim();
    
    if (searchTerm.length === 0) {
        milestoneDropdown.style.display = 'none';
        currentMilestoneMatches = [];
        selectedMilestoneIndex = -1;
        return;
    }
    
    // Filter milestones - search in name, number, opportunity name, and workload
    currentMilestoneMatches = allMilestones.filter(milestone => {
        const name = (milestone.name || '').toLowerCase();
        const number = (milestone.number || '').toLowerCase();
        const oppName = (milestone.opportunity_name || '').toLowerCase();
        const workload = (milestone.workload || '').toLowerCase();
        return name.includes(searchTerm) || number.includes(searchTerm) || oppName.includes(searchTerm) || workload.includes(searchTerm);
    });
    
    if (currentMilestoneMatches.length > 0) {
        selectedMilestoneIndex = 0;
        renderMilestoneDropdown();
        milestoneDropdown.style.display = 'block';
        milestoneDropdown.style.width = milestoneSearch.offsetWidth + 'px';
    } else {
        milestoneDropdown.style.display = 'none';
        currentMilestoneMatches = [];
        selectedMilestoneIndex = -1;
    }
});

// Keyboard navigation for milestones
milestoneSearch.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowDown' && currentMilestoneMatches.length > 0) {
        e.preventDefault();
        selectedMilestoneIndex = (selectedMilestoneIndex + 1) % currentMilestoneMatches.length;
        renderMilestoneDropdown();
    } else if (e.key === 'ArrowUp' && currentMilestoneMatches.length > 0) {
        e.preventDefault();
        selectedMilestoneIndex = selectedMilestoneIndex <= 0 ? currentMilestoneMatches.length - 1 : selectedMilestoneIndex - 1;
        renderMilestoneDropdown();
    } else if ((e.key === 'Tab' || e.key === 'Enter') && currentMilestoneMatches.length > 0) {
        e.preventDefault();
        if (selectedMilestoneIndex >= 0 && selectedMilestoneIndex < currentMilestoneMatches.length) {
            selectMilestone(currentMilestoneMatches[selectedMilestoneIndex]);
        }
    } else if (e.key === 'Escape') {
        milestoneDropdown.style.display = 'none';
        currentMilestoneMatches = [];
        selectedMilestoneIndex = -1;
    }
});

function getStatusBadgeClass(status) {
    switch (status) {
        case 'On Track': return 'bg-success';
        case 'At Risk': return 'bg-warning text-dark';
        case 'Blocked': return 'bg-danger';
        case 'Completed': return 'bg-secondary';
        case 'Cancelled': return 'bg-light text-dark';
        case 'Lost to Competitor': return 'bg-dark';
        case 'Hygiene/Duplicate': return 'bg-light text-dark';
        default: return 'bg-secondary';
    }
}

function renderMilestoneDropdown() {
    milestoneDropdown.innerHTML = currentMilestoneMatches.map((milestone, index) => {
        const name = milestone.name || 'Unnamed Milestone';
        const number = milestone.number || '';
        const status = milestone.status || 'Unknown';
        const oppName = milestone.opportunity_name || '';
        const workload = milestone.workload || '';
        const monthlyUsage = milestone.monthly_usage;
        const usedIn = milestone.used_in_call_logs || 0;
        const statusClass = getStatusBadgeClass(status);
        
        // Format monthly usage as currency
        const usageDisplay = monthlyUsage ? '$' + monthlyUsage.toLocaleString() : '';
        
        return `<button type="button" class="list-group-item list-group-item-action ${index === selectedMilestoneIndex ? 'active' : ''}" 
            data-milestone-index="${index}"
            onmouseenter="handleMilestoneHover(${index})"
            onclick="selectMilestone(currentMilestoneMatches[${index}])">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <i class="bi bi-flag"></i> <strong>${name}</strong>
                    ${number ? '<span class="text-muted small">(' + number + ')</span>' : ''}
                    <span class="badge ${statusClass} ms-1">${status}</span>
                    ${usedIn > 0 ? '<span class="badge bg-info ms-1" title="Used in ' + usedIn + ' call log(s)"><i class="bi bi-journal-text"></i> ' + usedIn + '</span>' : ''}
                </div>
                ${usageDisplay ? '<span class="badge bg-success">' + usageDisplay + '/mo</span>' : ''}
            </div>
            ${oppName ? '<small class="text-muted">' + oppName + '</small>' : ''}
            ${workload ? '<br><small class="text-info">' + workload + '</small>' : ''}
        </button>`;
    }).join('');
}

function handleMilestoneHover(index) {
    selectedMilestoneIndex = index;
    milestoneDropdown.querySelectorAll('button').forEach((btn, i) => {
        btn.classList.toggle('active', i === index);
    });
}

// Hide milestone dropdown when clicking outside
document.addEventListener('click', function(e) {
    if (!milestoneSearch.contains(e.target) && !milestoneDropdown.contains(e.target)) {
        milestoneDropdown.style.display = 'none';
        currentMilestoneMatches = [];
        selectedMilestoneIndex = -1;
    }
});

function selectMilestone(milestone) {
    selectedMilestoneData = milestone;
    const msxId = milestone.id;
    const name = milestone.name || 'Unnamed Milestone';
    const number = milestone.number || '';
    const status = milestone.status || 'Unknown';
    const oppName = milestone.opportunity_name || '';
    const workload = milestone.workload || '';
    const monthlyUsage = milestone.monthly_usage;
    const url = milestone.url || '';
    const statusClass = getStatusBadgeClass(status);
    
    // Format monthly usage as currency
    const usageDisplay = monthlyUsage ? '$' + monthlyUsage.toLocaleString() + '/mo' : '';
    
    selectedMilestoneContainer.innerHTML = `
        <div class="card border-success" data-msx-milestone-id="${msxId}">
            <div class="card-body py-2 px-3">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <strong>
                            <i class="bi bi-flag me-1"></i>
                            ${url ? '<a href="' + url + '" target="_blank">' + name + '</a>' : name}
                        </strong>
                        ${number ? '<span class="text-muted small">(' + number + ')</span>' : ''}
                        <span class="badge ${statusClass} ms-1">${status}</span>
                        ${usageDisplay ? '<span class="badge bg-success ms-1">' + usageDisplay + '</span>' : ''}
                        ${oppName ? '<br><small class="text-muted">' + oppName + '</small>' : ''}
                        ${workload ? '<br><small class="text-info"><i class="bi bi-cpu"></i> ' + workload + '</small>' : ''}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeMilestone()">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
            <input type="hidden" name="milestone_msx_id" value="${msxId}">
            <input type="hidden" name="milestone_name" value="${name}">
            <input type="hidden" name="milestone_number" value="${number}">
            <input type="hidden" name="milestone_status" value="${status}">
            <input type="hidden" name="milestone_status_code" value="${milestone.status_code || ''}">
            <input type="hidden" name="milestone_opportunity_name" value="${oppName}">
            <input type="hidden" name="milestone_workload" value="${workload}">
            <input type="hidden" name="milestone_monthly_usage" value="${monthlyUsage || ''}">
            <input type="hidden" name="milestone_url" value="${url}">
        </div>
    `;
    
    // Show task creation section
    taskCreationSection.style.display = 'block';
    
    // Clear search
    milestoneSearch.value = '';
    milestoneDropdown.style.display = 'none';
    currentMilestoneMatches = [];
    selectedMilestoneIndex = -1;
    
    debouncedAutoSave();
}

function removeMilestone() {
    selectedMilestoneData = null;
    selectedMilestoneContainer.innerHTML = '';
    taskCreationSection.style.display = 'none';
    
    // Clear task fields and created task
    clearCreatedTask();
    
    debouncedAutoSave();
}

// ===== MSX TASK CREATION =====
function createTaskInMSX() {
    const milestoneId = document.querySelector('input[name="milestone_msx_id"]')?.value;
    const subject = document.getElementById('task_subject').value.trim();
    const category = document.getElementById('task_category').value;
    const duration = document.getElementById('task_duration').value || 60;
    const description = document.getElementById('task_description').value.trim();
    
    // Validation
    if (!milestoneId) {
        showTaskError('No milestone selected');
        return;
    }
    if (!subject) {
        showTaskError('Task title is required');
        return;
    }
    if (!category) {
        showTaskError('Task category is required');
        return;
    }
    
    // Show loading state
    const btn = document.getElementById('create_task_btn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Creating...';
    hideTaskError();
    
    // Get category info for storing
    const categoryInfo = taskCategories.find(c => c.value == category) || {label: 'Unknown', is_hok: false};
    
    // Call API
    fetch('/api/msx/tasks', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            milestone_id: milestoneId,
            subject: subject,
            task_category: parseInt(category),
            duration_minutes: parseInt(duration),
            description: description || null
        })
    })
    .then(response => response.json())
    .then(result => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        
        if (result.success) {
            // Store created task info
            document.getElementById('created_task_id').value = result.task_id;
            document.getElementById('created_task_url').value = result.task_url || '';
            document.getElementById('created_task_category_name').value = categoryInfo.label;
            document.getElementById('created_task_is_hok').value = categoryInfo.is_hok ? '1' : '0';
            
            // Show success state
            document.getElementById('task_form_fields').style.display = 'none';
            document.getElementById('task_created_status').style.display = 'block';
            if (result.task_url) {
                document.getElementById('task_created_link').href = result.task_url;
                document.getElementById('task_created_link').style.display = 'inline';
            } else {
                document.getElementById('task_created_link').style.display = 'none';
            }
            
            debouncedAutoSave();
        } else {
            showTaskError(result.error || 'Failed to create task');
        }
    })
    .catch(error => {
        btn.disabled = false;
        btn.innerHTML = originalText;
        showTaskError('Network error: ' + error.message);
    });
}

function clearCreatedTask() {
    // Clear hidden fields
    document.getElementById('created_task_id').value = '';
    document.getElementById('created_task_url').value = '';
    document.getElementById('created_task_category_name').value = '';
    document.getElementById('created_task_is_hok').value = '';
    
    // Clear form fields
    document.getElementById('task_subject').value = '';
    document.getElementById('task_category').value = '';
    document.getElementById('task_duration').value = '60';
    document.getElementById('task_description').value = '';
    
    // Reset UI
    document.getElementById('task_form_fields').style.display = 'block';
    document.getElementById('task_created_status').style.display = 'none';
    hideTaskError();
    
    debouncedAutoSave();
}

function showTaskError(message) {
    const errorDiv = document.getElementById('task_creation_error');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
}

function hideTaskError() {
    document.getElementById('task_creation_error').style.display = 'none';
}

// AI Topic Suggestion
let lastAiCallFailed = false;
let aiButtonDisabledUntil = 0;

// Show AI button if AI is enabled (no need for API call - we already have this from template)
{% if ai_config and ai_config.enabled %}
document.getElementById('aiSuggestBtn').style.display = 'block';
{% endif %}

document.getElementById('aiSuggestBtn').addEventListener('click', function() {
    const aiBtn = this;
    const btnText = document.getElementById('aiSuggestBtnText');
    const originalText = btnText.textContent;
    
    // Check if button is in cooldown
    if (Date.now() < aiButtonDisabledUntil) {
        return;
    }
    
    // Get call notes from Quill editor
    const callNotes = quill.getText().trim();
    
    if (!callNotes || callNotes.length < 10) {
        alert('Please enter some call notes first (at least 10 characters).');
        return;
    }
    
    // Disable button and show loading
    aiBtn.disabled = true;
    btnText.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Analyzing...';
    
    fetch('/api/ai/suggest-topics', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ call_notes: callNotes })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Add suggested topics that aren't already selected
            let addedCount = 0;
            data.topics.forEach(topic => {
                if (!isTopicSelected(topic.id)) {
                    addTopic(topic.id, topic.name);
                    addedCount++;
                }
            });
            
            if (addedCount > 0) {
                btnText.textContent = `Added ${addedCount} topic${addedCount > 1 ? 's' : ''}!`;
                setTimeout(() => btnText.textContent = 'Auto-tag with AI', 2000);
            } else {
                btnText.textContent = 'All suggested topics already added';
                setTimeout(() => btnText.textContent = 'Auto-tag with AI', 2000);
            }
            
            lastAiCallFailed = false;
            aiBtn.disabled = false;
        } else {
            // Handle error
            btnText.textContent = 'Error - Try again in 5s';
            lastAiCallFailed = true;
            aiButtonDisabledUntil = Date.now() + 5000;
            setTimeout(() => {
                aiBtn.disabled = false;
                btnText.textContent = originalText;
            }, 5000);
            alert('AI Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('AI request failed:', error);
        btnText.textContent = 'Error - Try again in 5s';
        lastAiCallFailed = true;
        aiButtonDisabledUntil = Date.now() + 5000;
        setTimeout(() => {
            aiBtn.disabled = false;
            btnText.textContent = originalText;
        }, 5000);
        alert('Failed to get AI suggestions. Please try again.');
    });
});

// ===== AUTO-SAVE FUNCTIONALITY =====
const DRAFT_KEY_PREFIX = 'notehelper_draft_';
const MAX_DRAFTS = 5;
const DEBOUNCE_DELAY = 1500; // 1.5 seconds after user stops typing
let autoSaveTimeout = null;
let draftRestored = false;

// Get customer-specific draft key
function getDraftKey() {
    const customerId = document.getElementById('customer_id').value;
    return customerId ? `${DRAFT_KEY_PREFIX}${customerId}` : null;
}

// Get customer name from select dropdown
function getCustomerName() {
    const customerSelect = document.getElementById('customer_id');
    const selectedOption = customerSelect.options[customerSelect.selectedIndex];
    return selectedOption ? selectedOption.textContent.trim() : '';
}

// Save draft to localStorage
function saveDraft() {
    const draftKey = getDraftKey();
    if (!draftKey) return; // Can't save without customer selected
    
    // Get milestone data if selected
    const milestoneData = selectedMilestoneData ? {
        id: selectedMilestoneData.id,
        name: selectedMilestoneData.name,
        number: selectedMilestoneData.number,
        status: selectedMilestoneData.status,
        status_code: selectedMilestoneData.status_code,
        opportunity_name: selectedMilestoneData.opportunity_name,
        workload: selectedMilestoneData.workload,
        monthly_usage: selectedMilestoneData.monthly_usage,
        url: selectedMilestoneData.url
    } : null;
    
    // Get task form data
    const taskData = {
        subject: document.getElementById('task_subject').value,
        category: document.getElementById('task_category').value,
        duration: document.getElementById('task_duration').value,
        description: document.getElementById('task_description').value,
        // Include created task info if task was already created
        created_task_id: document.getElementById('created_task_id').value,
        created_task_url: document.getElementById('created_task_url').value,
        created_task_category_name: document.getElementById('created_task_category_name').value,
        created_task_is_hok: document.getElementById('created_task_is_hok').value
    };
    
    const draftData = {
        customer_id: document.getElementById('customer_id').value,
        customer_name: getCustomerName(),
        call_date: document.getElementById('call_date').value,
        content: quill.root.innerHTML,
        topics: Array.from(selectedTopicsContainer.querySelectorAll('input[name="topic_ids"]')).map(input => ({
            id: parseInt(input.value),
            name: input.closest('.badge').textContent.trim().replace('Ã—', '').trim()
        })),
        partners: Array.from(selectedPartnersContainer.querySelectorAll('input[name="partner_ids"]')).map(input => ({
            id: parseInt(input.value),
            name: input.closest('.badge').textContent.trim().replace('Ã—', '').trim()
        })),
        milestone: milestoneData,
        task: taskData,
        call_log_id: {% if call_log %}{{ call_log.id }}{% else %}null{% endif %},
        timestamp: Date.now()
    };
    
    // Only save if there's actual content
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = draftData.content;
    const textContent = (tempDiv.textContent || tempDiv.innerText || '').trim();
    
    if (textContent.length > 0 || draftData.topics.length > 0 || draftData.partners.length > 0 || milestoneData) {
        try {
            localStorage.setItem(draftKey, JSON.stringify(draftData));
            console.log('Draft auto-saved');
            showDraftSavedIndicator();
        } catch (e) {
            console.error('Failed to save draft:', e);
            // Storage quota exceeded - prune old drafts
            pruneOldDrafts();
        }
    }
}

// Show draft saved indicator with fade animation
function showDraftSavedIndicator() {
    const indicator = document.getElementById('draftSaveIndicator');
    if (!indicator) return;
    
    indicator.style.opacity = '1';
    setTimeout(() => {
        indicator.style.opacity = '0';
    }, 2000);
}

// Restore draft from localStorage
function restoreDraft() {
    const draftKey = getDraftKey();
    if (!draftKey) return false;
    
    try {
        const draftJson = localStorage.getItem(draftKey);
        if (!draftJson) return false;
        
        const draft = JSON.parse(draftJson);
        
        // Check if draft has any content
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = draft.content || '';
        const textContent = (tempDiv.textContent || tempDiv.innerText || '').trim();
        
        if (textContent.length === 0 && (!draft.topics || draft.topics.length === 0) && (!draft.partners || draft.partners.length === 0) && !draft.milestone) {
            return false; // No content to restore
        }
        
        // Restore form data
        if (draft.call_date) {
            document.getElementById('call_date').value = draft.call_date;
        }
        
        if (draft.content) {
            quill.root.innerHTML = draft.content;
        }
        
        if (draft.topics && draft.topics.length > 0) {
            draft.topics.forEach(topic => {
                if (!isTopicSelected(topic.id)) {
                    addTopic(topic.id, topic.name);
                }
            });
        }
        
        if (draft.partners && draft.partners.length > 0) {
            draft.partners.forEach(partner => {
                if (!isPartnerSelected(partner.id)) {
                    addPartner(partner.id, partner.name);
                }
            });
        }
        
        // Restore milestone selection
        if (draft.milestone) {
            selectedMilestoneData = draft.milestone;
            selectMilestone(draft.milestone);
        }
        
        // Restore task form data
        if (draft.task) {
            document.getElementById('task_subject').value = draft.task.subject || '';
            document.getElementById('task_category').value = draft.task.category || '';
            document.getElementById('task_duration').value = draft.task.duration || '60';
            document.getElementById('task_description').value = draft.task.description || '';
            
            // Restore created task info if it was already created
            if (draft.task.created_task_id) {
                document.getElementById('created_task_id').value = draft.task.created_task_id;
                document.getElementById('created_task_url').value = draft.task.created_task_url || '';
                document.getElementById('created_task_category_name').value = draft.task.created_task_category_name || '';
                document.getElementById('created_task_is_hok').value = draft.task.created_task_is_hok || '';
                
                // Show the "task created" state
                document.getElementById('task_form_fields').style.display = 'none';
                document.getElementById('task_created_status').style.display = 'block';
                if (draft.task.created_task_url) {
                    document.getElementById('task_created_link').href = draft.task.created_task_url;
                    document.getElementById('task_created_link').style.display = 'inline';
                }
            }
        }
        
        // If draft has a call_log_id, we need to update the form action to edit that log
        if (draft.call_log_id) {
            const form = document.getElementById('callLogForm');
            form.action = `/call-log/${draft.call_log_id}/edit`;
            console.log('Draft restored for editing call log', draft.call_log_id);
        }
        
        return true;
    } catch (e) {
        console.error('Failed to restore draft:', e);
        return false;
    }
}

// Clear draft from localStorage
function clearDraft() {
    const draftKey = getDraftKey();
    if (!draftKey) return;
    
    try {
        localStorage.removeItem(draftKey);
        console.log('Draft cleared');
    } catch (e) {
        console.error('Failed to clear draft:', e);
    }
}

// Prune old drafts (keep only MAX_DRAFTS most recent)
function pruneOldDrafts() {
    try {
        const drafts = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith(DRAFT_KEY_PREFIX)) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    drafts.push({ key, timestamp: data.timestamp || 0 });
                } catch (e) {
                    // Invalid draft, remove it
                    localStorage.removeItem(key);
                }
            }
        }
        
        // Sort by timestamp descending
        drafts.sort((a, b) => b.timestamp - a.timestamp);
        
        // Remove drafts beyond MAX_DRAFTS
        if (drafts.length > MAX_DRAFTS) {
            drafts.slice(MAX_DRAFTS).forEach(draft => {
                localStorage.removeItem(draft.key);
                console.log('Pruned old draft:', draft.key);
            });
        }
    } catch (e) {
        console.error('Failed to prune drafts:', e);
    }
}

// Listen for storage changes (multi-tab coordination)
window.addEventListener('storage', function(e) {
    if (e.key && e.key.startsWith(DRAFT_KEY_PREFIX)) {
        const draftKey = getDraftKey();
        if (e.key === draftKey && !draftRestored) {
            // Another tab modified our draft - reload if we haven't restored yet
            if (e.newValue) {
                console.log('Draft updated from another tab');
                const shouldRestore = confirm('A draft was updated in another tab. Reload it?');
                if (shouldRestore) {
                    restoreDraft();
                    draftRestored = true;
                }
            }
        }
    }
});

// Debounced auto-save - saves after user stops typing for DEBOUNCE_DELAY ms
function debouncedAutoSave() {
    // Clear any existing timeout
    if (autoSaveTimeout) {
        clearTimeout(autoSaveTimeout);
    }
    
    // Set new timeout to save after delay
    const customerId = document.getElementById('customer_id').value;
    if (customerId) {
        autoSaveTimeout = setTimeout(() => {
            saveDraft();
        }, DEBOUNCE_DELAY);
    }
}

// Function to start auto-save for selected customer
function startAutoSave() {
    const customerSelect = document.getElementById('customer_id');
    const customerId = customerSelect.value || customerSelect.querySelector('option[selected]')?.value;
    
    // Check for existing draft when customer changes
    if (customerId && !draftRestored) {
        const hasDraft = restoreDraft();
        if (hasDraft) {
            draftRestored = true;
            
            // Show dismissible alert
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="bi bi-info-circle"></i> <strong>Draft restored!</strong> Your unsaved changes have been recovered.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('form').insertBefore(alertDiv, document.querySelector('form').firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 150);
            }, 5000);
        }
    }
    
    // Set up debounced auto-save listeners if customer selected
    if (customerId) {
        // Listen to Quill text changes
        quill.on('text-change', debouncedAutoSave);
        
        // Listen to date field changes
        document.getElementById('call_date').addEventListener('input', debouncedAutoSave);
        
        console.log('Debounced auto-save enabled for customer', customerId);
    }
}

// Start auto-save when customer is selected
document.getElementById('customer_id').addEventListener('change', startAutoSave);

// Flag to prevent saving after successful submission
let formSubmittedSuccessfully = false;

// Save draft before page unload (unless form was successfully submitted)
window.addEventListener('beforeunload', function(e) {
    const customerId = document.getElementById('customer_id').value;
    if (customerId && !formSubmittedSuccessfully) {
        saveDraft();
    }
});

// Clear draft only after successful form submission
document.getElementById('callLogForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent default form submission
    
    const form = e.target;
    const formData = new FormData(form);
    const submitButton = form.querySelector('button[type="submit"]');
    
    // Disable submit button to prevent double submission
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    
    // Submit via fetch so we can wait for response
    fetch(form.action, {
        method: 'POST',
        body: formData,
        redirect: 'follow' // Follow redirects automatically
    })
    .then(response => {
        console.log('Response status:', response.status, 'OK:', response.ok, 'Redirected:', response.redirected);
        if (response.ok || response.redirected) {
            // Success! Set flag to prevent beforeunload from saving
            console.log('Setting submission success flag...');
            formSubmittedSuccessfully = true;
            
            // Stop auto-save first, then clear the draft
            console.log('Stopping auto-save...');
            if (autoSaveTimeout) {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = null;
            }
            console.log('Clearing draft before redirect...');
            clearDraft();
            console.log('Draft cleared, redirecting to:', response.url);
            // Redirect to the final URL (after any server redirects)
            window.location.href = response.url;
        } else {
            // Server returned an error - keep the draft
            throw new Error('Form submission failed');
        }
    })
    .catch(error => {
        console.error('Form submission error:', error);
        alert('Failed to save call log. Your draft has been preserved. Please try again.');
        // Re-enable submit button
        submitButton.disabled = false;
        submitButton.innerHTML = '<i class="bi bi-save"></i> Save Call Log';
    });
});

// Discard draft function
function discardDraft() {
    if (confirm('Discard this draft? This will clear all unsaved changes and cannot be undone.')) {
        clearDraft();
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
        }
        
        // Clear the form
        quill.setContents([]);
        document.getElementById('call_date').value = '';
        document.querySelectorAll('.badge[data-topic-id]').forEach(badge => badge.remove());
        document.querySelectorAll('.badge[data-partner-id]').forEach(badge => badge.remove());
        
        // Redirect back to call logs list
        window.location.href = '{{ url_for("call_logs.call_logs_list") }}';
    }
}

// Set current date as default if creating new call log (only if not already set by server)
{% if not call_log %}
document.addEventListener('DOMContentLoaded', function() {
    var dateInput = document.getElementById('call_date');
    // Only set to today if the server didn't provide a date
    if (!dateInput.value) {
        var now = new Date();
        var year = now.getFullYear();
        var month = String(now.getMonth() + 1).padStart(2, '0');
        var day = String(now.getDate()).padStart(2, '0');
        dateInput.value = year + '-' + month + '-' + day;
    }
    
    // Initialize auto-save if customer is preselected
    startAutoSave();
    
    {% if previous_calls %}
    // Match previous calls card height to new call log card height
    function matchCardHeights() {
        const newCallCard = document.querySelector('.col-md-6:first-child .card');
        const previousCallsCard = document.querySelector('.previous-calls-card');
        const previousCallsBody = document.querySelector('.previous-calls-body');
        
        if (newCallCard && previousCallsCard && previousCallsBody) {
            const newCallHeight = newCallCard.offsetHeight;
            previousCallsCard.style.height = newCallHeight + 'px';
            
            // Calculate available height for scrollable body
            const cardHeader = previousCallsCard.querySelector('.card-header');
            const headerHeight = cardHeader ? cardHeader.offsetHeight : 0;
            const bodyPadding = 32; // Card body padding
            previousCallsBody.style.maxHeight = (newCallHeight - headerHeight - bodyPadding) + 'px';
        }
    }
    
    // Match heights on load and when Quill editor is initialized
    matchCardHeights();
    setTimeout(matchCardHeights, 100); // Retry after Quill loads
    window.addEventListener('resize', matchCardHeights);
    {% endif %}
});
{% endif %}
</script>
{% endblock %}










