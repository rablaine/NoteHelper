{% extends "base.html" %}

{% block title %}Customers - NoteHelper{% endblock %}

{% block extra_css %}
<style>
    /* Subtle contrast improvement for unchecked switch */
    #showCustomersWithoutCalls {
        opacity: 1 !important;
    }
    
    #showCustomersWithoutCalls:not(:checked) {
        border-width: 1.5px !important;
        border-color: rgba(var(--bs-body-color-rgb), 0.5) !important;
        opacity: 1 !important;
    }
    
    #showCustomersWithoutCalls:not(:checked):hover {
        border-color: var(--bs-primary) !important;
        opacity: 1 !important;
    }

    /* Chevron rotation for collapsible seller groups */
    .seller-chevron {
        transition: transform 0.2s ease;
    }
    .collapsed .seller-chevron {
        transform: rotate(-90deg);
    }

    /* Seller group header card */
    .seller-header {
        border: 1px solid rgba(var(--bs-body-color-rgb), 0.15);
        border-radius: 0.375rem;
        padding: 0.6rem 0.85rem;
        display: flex;
        align-items: center;
        gap: 0.35rem;
        background-color: rgba(var(--bs-body-color-rgb), 0.06);
        cursor: pointer;
    }
    .seller-header:hover {
        background-color: rgba(var(--bs-body-color-rgb), 0.1);
    }
    .seller-header.expanded {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        border-bottom: none;
    }

    /* Connect customer list to seller header */
    .seller-collapse .list-group {
        margin-top: 0 !important;
    }
    .seller-collapse .list-group .list-group-item:first-child {
        border-top: 2px solid rgba(var(--bs-body-color-rgb), 0.15);
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <i class="bi bi-building"></i> Customers
    </h1>
    <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-sm {{ 'btn-primary' if show_customers_without_calls else 'btn-outline-secondary' }}" id="toggleShowWithoutCalls" title="Toggle showing customers with no calls">
            <i class="bi bi-{{ 'eye-slash' if show_customers_without_calls else 'eye' }}"></i> {{ 'Hide' if show_customers_without_calls else 'Show' }} No Calls
        </button>
        <div class="btn-group" role="group" aria-label="Sort customers">
            <button type="button" class="btn btn-sm {{ 'btn-primary' if sort_by == 'alphabetical' else 'btn-outline-secondary' }}" data-sort="alphabetical" title="Sort alphabetically">
                <i class="bi bi-sort-alpha-down"></i> A-Z
            </button>
            <button type="button" class="btn btn-sm {{ 'btn-primary' if sort_by == 'grouped' else 'btn-outline-secondary' }}" data-sort="grouped" title="Group by seller">
                <i class="bi bi-people"></i> Grouped
            </button>
            <button type="button" class="btn btn-sm {{ 'btn-primary' if sort_by == 'by_calls' else 'btn-outline-secondary' }}" data-sort="by_calls" title="Sort by number of calls">
                <i class="bi bi-telephone"></i> By Calls
            </button>
        </div>
        <a href="{{ url_for('customers.customer_create') }}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle"></i> New Customer
        </a>
    </div>
</div>

{% if sort_by == 'grouped' %}
    {# Grouped View #}
    {% if grouped_customers or customers_without_seller %}
        <div class="d-flex justify-content-end mb-2 gap-2">
            <button class="btn btn-sm btn-outline-secondary" id="expandAllBtn"><i class="bi bi-arrows-expand"></i> Expand All</button>
            <button class="btn btn-sm btn-outline-secondary" id="collapseAllBtn"><i class="bi bi-arrows-collapse"></i> Collapse All</button>
        </div>
        {% for group in grouped_customers %}
            <div class="mb-3">
                <div class="seller-header collapsed" data-bs-toggle="collapse" data-bs-target="#sellerGroup{{ group.seller.id }}" role="button" aria-expanded="false" aria-controls="sellerGroup{{ group.seller.id }}">
                    <i class="bi bi-chevron-down me-2 seller-chevron"></i>
                    <h4 class="mb-0 d-inline"><i class="bi bi-person"></i>&nbsp;{{ group.seller.name }}</h4>
                    {% if group.seller.seller_type %}
                        <span class="badge {% if group.seller.seller_type == 'Growth' %}bg-success{% else %}bg-info{% endif %}">{{ group.seller.seller_type }}</span>
                    {% endif %}
                    <a href="{{ url_for('sellers.seller_view', id=group.seller.id) }}" class="btn btn-sm btn-outline-primary" title="View seller" onclick="event.stopPropagation();"><i class="bi bi-box-arrow-up-right"></i></a>
                    <span class="ms-auto d-flex align-items-center flex-wrap gap-1">
                        {% if group.seller.territories %}
                            {% if group.seller.territories|length <= 2 %}
                                {% for territory in group.seller.territories|sort(attribute='name') %}
                                    <a href="{{ url_for('territories.territory_view', id=territory.id) }}" class="badge bg-secondary text-decoration-none" onclick="event.stopPropagation();"><i class="bi bi-geo-alt"></i> {{ territory.name }}</a>
                                {% endfor %}
                            {% else %}
                                <a href="{{ url_for('territories.territory_view', id=group.seller.territories|sort(attribute='name')|first|attr('id')) }}" class="badge bg-secondary text-decoration-none" onclick="event.stopPropagation();"><i class="bi bi-geo-alt"></i> {{ group.seller.territories|sort(attribute='name')|first|attr('name') }}</a>
                                <span class="badge bg-secondary" title="{{ group.seller.territories|sort(attribute='name')|map(attribute='name')|join(', ') }}">+{{ group.seller.territories|length - 1 }} more</span>
                            {% endif %}
                        {% endif %}
                        <span class="text-muted" style="font-size: 0.9rem;">({{ group.customers|length }} customers)</span>
                    </span>
                </div>
                <div class="collapse seller-collapse" id="sellerGroup{{ group.seller.id }}" data-seller-key="seller-{{ group.seller.id }}">
                    <div class="list-group mt-2">
                    {% for customer in group.customers %}
                        <div class="list-group-item" style="cursor: pointer;" onclick="window.location='{{ url_for('customers.customer_view', id=customer.id) }}'">
                            <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                <h5 class="mb-0">
                                    <span>{{ customer.name }}</span>
                                    {% if customer.tpid_url %}
                                        (<a href="{{ customer.tpid_url }}" target="_blank" onclick="event.stopPropagation();">{{ customer.tpid }}</a>)
                                    {% else %}
                                        ({{ customer.tpid }})
                                    {% endif %}
                                </h5>
                                <div class="d-flex align-items-center gap-2">
                                    <small class="text-muted text-nowrap">{{ customer.call_logs|length }} calls</small>
                                    <a href="{{ url_for('call_logs.call_log_create', customer_id=customer.id) }}" class="btn btn-sm btn-success text-white" onclick="event.stopPropagation();">
                                        <i class="bi bi-plus-circle"></i> New Call Log
                                    </a>
                                </div>
                            </div>
                            <div>
                                {% if customer.territory %}
                                    {% if group.seller.territories|length != 1 %}
                                        <span class="badge bg-info"><i class="bi bi-geo-alt"></i> {{ customer.territory.name }}</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
        
        {% if customers_without_seller %}
            <div class="mb-3">
                <div class="seller-header collapsed" data-bs-toggle="collapse" data-bs-target="#sellerGroupUnassigned" role="button" aria-expanded="false" aria-controls="sellerGroupUnassigned">
                    <i class="bi bi-chevron-down me-2 seller-chevron"></i>
                    <h4 class="mb-0 d-inline"><i class="bi bi-question-circle"></i>&nbsp;No Seller Assigned</h4>
                    <span class="ms-auto">
                        <span class="text-muted" style="font-size: 0.9rem;">({{ customers_without_seller|length }} customers)</span>
                    </span>
                </div>
                <div class="collapse seller-collapse" id="sellerGroupUnassigned" data-seller-key="seller-unassigned">
                    <div class="list-group mt-2">
                    {% for customer in customers_without_seller %}
                        <div class="list-group-item" style="cursor: pointer;" onclick="window.location='{{ url_for('customers.customer_view', id=customer.id) }}'">
                            <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                                <h5 class="mb-0">
                                    <span>{{ customer.name }}</span>
                                    {% if customer.tpid_url %}
                                        (<a href="{{ customer.tpid_url }}" target="_blank" onclick="event.stopPropagation();">{{ customer.tpid }}</a>)
                                    {% else %}
                                        ({{ customer.tpid }})
                                    {% endif %}
                                </h5>
                                <div class="d-flex align-items-center gap-2">
                                    <small class="text-muted text-nowrap">{{ customer.call_logs|length }} calls</small>
                                    <a href="{{ url_for('call_logs.call_log_create', customer_id=customer.id) }}" class="btn btn-sm btn-success text-white" onclick="event.stopPropagation();">
                                        <i class="bi bi-plus-circle"></i> New Call Log
                                    </a>
                                </div>
                            </div>
                            <div>
                                {% if customer.territory %}
                                    <span class="badge bg-info"><i class="bi bi-geo-alt"></i> {{ customer.territory.name }}</span>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No customers yet. <a href="{{ url_for('customers.customer_create') }}">Create your first customer</a>!
        </div>
    {% endif %}
{% else %}
    {# Alphabetical View #}
    {% if customers %}
        <div class="list-group">
            {% for customer in customers %}
                <div class="list-group-item" style="cursor: pointer;" onclick="window.location='{{ url_for('customers.customer_view', id=customer.id) }}'">
                    <div class="d-flex w-100 justify-content-between align-items-start mb-2">
                        <h5 class="mb-0">
                            <span>{{ customer.name }}</span>
                            {% if customer.tpid_url %}
                                (<a href="{{ customer.tpid_url }}" target="_blank" onclick="event.stopPropagation();">{{ customer.tpid }}</a>)
                            {% else %}
                                ({{ customer.tpid }})
                            {% endif %}
                        </h5>
                        <div class="d-flex align-items-center gap-2">
                            <small class="text-muted text-nowrap">{{ customer.call_logs|length }} calls</small>
                            <a href="{{ url_for('call_logs.call_log_create', customer_id=customer.id) }}" class="btn btn-sm btn-success text-white" onclick="event.stopPropagation();">
                                <i class="bi bi-plus-circle"></i> New Call Log
                            </a>
                        </div>
                    </div>
                    <div>
                        {% if customer.seller %}
                            <a href="{{ url_for('sellers.seller_view', id=customer.seller.id) }}" class="badge {{ get_seller_color(customer.seller.id) }} text-decoration-none"><i class="bi bi-person"></i> {{ customer.seller.name }}</a>
                            {% if customer.seller.seller_type %}
                                <span class="badge {% if customer.seller.seller_type == 'Growth' %}bg-success{% else %}bg-info{% endif %}">{{ customer.seller.seller_type }}</span>
                            {% endif %}
                        {% endif %}
                        {% if customer.territory %}
                            <span class="badge bg-info text-dark"><i class="bi bi-geo-alt"></i> {{ customer.territory.name }}</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No customers yet. <a href="{{ url_for('customers.customer_create') }}">Create your first customer</a>!
        </div>
    {% endif %}
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Handle sort button clicks
document.addEventListener('DOMContentLoaded', function() {
    const sortButtons = document.querySelectorAll('[data-sort]');
    
    sortButtons.forEach(button => {
        button.addEventListener('click', function() {
            const sortBy = this.getAttribute('data-sort');
            
            // Save preference
            fetch('/api/preferences/customer-sort-by', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ customer_sort_by: sortBy })
            })
            .then(response => response.json())
            .then(() => {
                // Reload page to show new sorting
                window.location.reload();
            })
            .catch(error => {
                console.error('Error saving preference:', error);
                window.location.reload();
            });
        });
    });
    
    // Handle "Show customers with no calls" toggle button
    const toggleShowWithoutCalls = document.getElementById('toggleShowWithoutCalls');
    if (toggleShowWithoutCalls) {
        toggleShowWithoutCalls.addEventListener('click', function() {
            const currentState = {{ 'true' if show_customers_without_calls else 'false' }};
            const newState = !currentState;
            
            // Save preference
            fetch('/api/preferences/show-customers-without-calls', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ show_customers_without_calls: newState })
            })
            .then(response => response.json())
            .then(() => {
                // Reload page to apply filter
                window.location.reload();
            })
            .catch(error => {
                console.error('Error saving preference:', error);
                window.location.reload();
            });
        });
    }
    
    // Show draft indicators for customers with unsaved drafts
    function showDraftIndicators() {
        const DRAFT_KEY_PREFIX = 'notehelper_draft_';
        
        // Find all drafts in localStorage
        const customerDrafts = new Set();
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key && key.startsWith(DRAFT_KEY_PREFIX)) {
                // Extract customer ID from key (e.g., "notehelper_draft_123" -> "123")
                const customerId = key.replace(DRAFT_KEY_PREFIX, '');
                if (customerId) {
                    customerDrafts.add(customerId);
                }
            }
        }
        
        // Add draft indicators to matching customer rows
        customerDrafts.forEach(customerId => {
            // Find all list items and check if they link to this customer
            document.querySelectorAll('.list-group-item').forEach(item => {
                const onclick = item.getAttribute('onclick');
                if (onclick && onclick.includes(`/customer/${customerId}`)) {
                    // Check if indicator already exists
                    if (!item.querySelector('.draft-indicator')) {
                        // Add draft badge next to customer name
                        const heading = item.querySelector('h5');
                        if (heading) {
                            const draftBadge = document.createElement('span');
                            draftBadge.className = 'badge bg-warning text-dark ms-2 draft-indicator';
                            draftBadge.innerHTML = '<i class="bi bi-pencil"></i> Draft';
                            draftBadge.title = 'This customer has an unsaved draft call log';
                            heading.appendChild(draftBadge);
                        }
                    }
                }
            });
        });
    }
    
    // Show indicators on page load
    showDraftIndicators();
    
    // Listen for storage changes from other tabs
    window.addEventListener('storage', function(e) {
        if (e.key && e.key.startsWith('notehelper_draft_')) {
            // A draft was added or removed in another tab - update indicators
            document.querySelectorAll('.draft-indicator').forEach(el => el.remove());
            showDraftIndicators();
        }
    });

    // Seller group collapse state persistence via localStorage
    const STORAGE_KEY = 'notehelper_expanded_sellers';

    function getExpandedSellers() {
        try {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            return [];
        }
    }

    function saveExpandedSellers(expanded) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(expanded));
        } catch (e) { /* ignore */ }
    }

    // Restore expanded state from localStorage
    const expandedSellers = getExpandedSellers();
    document.querySelectorAll('.seller-collapse').forEach(el => {
        const key = el.getAttribute('data-seller-key');
        if (key && expandedSellers.includes(key)) {
            el.classList.add('show');
            // Update the toggle link and header to match
            const toggle = document.querySelector(`[aria-controls="${el.id}"]`);
            if (toggle) {
                toggle.classList.remove('collapsed');
                toggle.setAttribute('aria-expanded', 'true');
            }
            const header = el.previousElementSibling;
            if (header && header.classList.contains('seller-header')) {
                header.classList.add('expanded');
            }
        }
    });

    // Listen for show/hide events to persist state and toggle header style
    document.querySelectorAll('.seller-collapse').forEach(el => {
        el.addEventListener('shown.bs.collapse', function() {
            const header = this.previousElementSibling;
            if (header && header.classList.contains('seller-header')) {
                header.classList.add('expanded');
            }
            const key = this.getAttribute('data-seller-key');
            if (!key) return;
            const expanded = getExpandedSellers();
            if (!expanded.includes(key)) {
                expanded.push(key);
                saveExpandedSellers(expanded);
            }
        });
        el.addEventListener('hidden.bs.collapse', function() {
            const header = this.previousElementSibling;
            if (header && header.classList.contains('seller-header')) {
                header.classList.remove('expanded');
            }
            const key = this.getAttribute('data-seller-key');
            if (!key) return;
            const expanded = getExpandedSellers().filter(k => k !== key);
            saveExpandedSellers(expanded);
        });
    });

    // Expand/Collapse All seller groups
    const expandAllBtn = document.getElementById('expandAllBtn');
    const collapseAllBtn = document.getElementById('collapseAllBtn');
    if (expandAllBtn) {
        expandAllBtn.addEventListener('click', function() {
            const allKeys = [];
            document.querySelectorAll('.seller-collapse').forEach(el => {
                if (!el.classList.contains('show')) {
                    new bootstrap.Collapse(el, { toggle: true });
                }
                const key = el.getAttribute('data-seller-key');
                if (key) allKeys.push(key);
            });
            saveExpandedSellers(allKeys);
        });
    }
    if (collapseAllBtn) {
        collapseAllBtn.addEventListener('click', function() {
            document.querySelectorAll('.seller-collapse.show').forEach(el => {
                new bootstrap.Collapse(el, { toggle: true });
            });
            saveExpandedSellers([]);
        });
    }
});
</script>
{% endblock %}









