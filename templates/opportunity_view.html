{% extends "base.html" %}

{% block title %}{{ opportunity.name }} - NoteHelper{% endblock %}

{% block content %}
{% include 'partials/msx_auth_banner.html' %}

<div class="d-flex justify-content-between align-items-center mb-4 gap-3">
    <div style="min-width: 0; flex: 1; display: flex; align-items: baseline; gap: 0.5rem;">
        <h1 class="mb-0" style="white-space: nowrap; flex-shrink: 0;">
            <i class="bi bi-briefcase"></i>
        </h1>
        <h1 class="mb-0 text-truncate" style="min-width: 0;" title="{{ opportunity.name }}">
            {{ opportunity.name }}
        </h1>
    </div>
    <div class="flex-shrink-0 d-flex gap-2">
        {% if opportunity.customer %}
            <a href="{{ url_for('customers.customer_view', id=opportunity.customer.id) }}" class="btn btn-outline-secondary text-nowrap">
                <i class="bi bi-building"></i> {{ opportunity.customer.get_display_name() }}
            </a>
        {% endif %}
        {% if msx_data %}
            <a href="{{ msx_data.url }}" target="_blank" class="btn btn-outline-primary text-nowrap">
                <i class="bi bi-box-arrow-up-right"></i> Open in MSX
            </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- Left column: Details + Milestones -->
    <div class="col-md-4">
        <!-- Opportunity Details Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0">Details</h5>
            </div>
            <div class="card-body">
                {% if msx_data %}
                    <!-- Deal Team Status -->
                    <div class="mb-3 pb-3 border-bottom" id="dealTeamRow">
                        <strong>Deal Team:</strong>
                        {% if opportunity.on_deal_team %}
                        <span class="badge bg-success ms-2"><i class="bi bi-people-fill"></i> On Team</span>
                        {% else %}
                        <button class="btn btn-outline-primary btn-sm ms-2" id="joinDealTeamBtn" onclick="joinDealTeam({{ opportunity.id }})">
                            <i class="bi bi-person-plus"></i> Join Deal Team
                        </button>
                        {% endif %}
                    </div>
                    {% if msx_data.number %}
                        <p><strong>Opp Number:</strong> {{ msx_data.number }}</p>
                    {% endif %}
                    <p><strong>Status:</strong>
                        <span class="badge {% if msx_data.statecode == 0 %}bg-success{% elif msx_data.statecode == 1 %}bg-primary{% else %}bg-danger{% endif %}">
                            {{ msx_data.state }}
                        </span>
                        {% if msx_data.status %}
                            <span class="badge bg-secondary">{{ msx_data.status }}</span>
                        {% endif %}
                    </p>
                    {% if msx_data.estimated_value %}
                        <p><strong>Estimated Value:</strong> ${{ "{:,.0f}".format(msx_data.estimated_value) }}</p>
                    {% endif %}
                    {% if msx_data.estimated_close_date %}
                        <p><strong>Est. Close:</strong> {{ msx_data.estimated_close_date[:10] }}</p>
                    {% endif %}
                    {% if msx_data.owner %}
                        <p><strong>Owner:</strong> {{ msx_data.owner }}</p>
                    {% endif %}
                    {% if msx_data.compete_threat %}
                        <p><strong>Compete Threat:</strong> {{ msx_data.compete_threat }}</p>
                    {% endif %}
                    {% if msx_data.customer_need %}
                        <p><strong>Customer Need:</strong></p>
                        <p class="small" style="white-space: pre-wrap;">{{ msx_data.customer_need }}</p>
                    {% endif %}
                    {% if msx_data.description %}
                        <p><strong>Description:</strong></p>
                        <p class="small" style="white-space: pre-wrap;">{{ msx_data.description }}</p>
                    {% endif %}
                {% elif vpn_blocked %}
                    <div class="alert alert-secondary mb-0">
                        <i class="bi bi-shield-lock"></i> <strong>VPN Required</strong><br>
                        <small>Connect to VPN to load opportunity details.</small>
                    </div>
                {% elif msx_error %}
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle"></i> {{ msx_error }}
                    </div>
                {% else %}
                    <p class="text-muted">No MSX data available.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Milestones Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-flag"></i> Milestones ({{ milestones|length }})</h5>
            </div>
            <div class="card-body">
                {% if milestones %}
                    {% for ms in milestones %}
                        <div class="{% if not loop.last %}mb-2 pb-2 border-bottom{% endif %}">
                            <div class="d-flex justify-content-between align-items-start">
                                <a href="{{ url_for('milestones.milestone_view', id=ms.id) }}" class="text-decoration-none" title="{{ ms.display_text }}">
                                    <i class="bi bi-flag"></i> {{ ms.display_text[:40] }}{% if ms.display_text|length > 40 %}...{% endif %}
                                </a>
                                <span class="badge {% if ms.msx_status == 'On Track' %}bg-success{% elif ms.msx_status == 'At Risk' %}bg-warning text-dark{% elif ms.msx_status == 'Blocked' %}bg-danger{% elif ms.msx_status == 'Completed' %}bg-info{% else %}bg-secondary{% endif %}">
                                    {{ ms.msx_status or 'Unknown' }}
                                </span>
                            </div>
                            {% if ms.workload %}
                                <small class="text-muted">{{ ms.workload }}</small>
                            {% endif %}
                            {% if ms.dollar_value %}
                                <small class="text-muted ms-2">${{ "{:,.0f}".format(ms.dollar_value) }}</small>
                            {% endif %}
                            {% if ms.due_date %}
                                <small class="text-muted ms-2"><i class="bi bi-calendar"></i> {{ ms.due_date.strftime('%b %d, %Y') }}</small>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted mb-0">No milestones linked to this opportunity.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Right column: Comments -->
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-chat-dots"></i> Forecast Comments</h5>
                {% if msx_data and msx_data.comments %}
                    <span class="badge bg-secondary">{{ msx_data.comments|length }} comment{{ 's' if msx_data.comments|length != 1 }}</span>
                {% endif %}
            </div>
            <div class="card-body">
                {% if vpn_blocked %}
                    <div class="alert alert-secondary">
                        <i class="bi bi-shield-lock"></i> <strong>VPN Required</strong><br>
                        <small>Connect to VPN to load forecast comments.</small>
                    </div>
                {% elif msx_error %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> Could not load comments: {{ msx_error }}
                    </div>
                {% elif msx_data %}
                    <!-- Add Comment Form -->
                    <form action="{{ url_for('opportunities.opportunity_add_comment', id=opportunity.id) }}" method="post" class="mb-4">
                        <div class="input-group">
                            <textarea class="form-control" name="comment" rows="2" placeholder="Add a forecast comment..." required></textarea>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i> Post
                            </button>
                        </div>
                        <small class="text-muted">This comment will be posted to the MSX opportunity record.</small>
                    </form>
                    
                    {% if msx_data.comments %}
                        <div class="list-group">
                            {% for comment in msx_data.comments|reverse %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between mb-1">
                                        <strong>{{ comment.displayName|default('Unknown') }}</strong>
                                        <small class="text-muted">
                                            <i class="bi bi-clock"></i> {{ comment.modifiedOn }}
                                        </small>
                                    </div>
                                    <p class="mb-0" style="white-space: pre-wrap;">{{ comment.comment }}</p>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No forecast comments yet. Be the first to add one!</p>
                    {% endif %}
                {% else %}
                    <p class="text-muted">Comments not available (MSX connection required).</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Disable join-team button when VPN is blocked
fetch('/api/msx/vpn-status').then(r => r.json()).then(data => {
    if (data.blocked) {
        const btn = document.getElementById('joinDealTeamBtn');
        if (btn) {
            btn.disabled = true;
            btn.classList.replace('btn-outline-primary', 'btn-outline-secondary');
            btn.title = 'VPN required â€” connect to corpnet first';
        }
    }
}).catch(() => {});

async function joinDealTeam(opportunityId) {
    const btn = document.getElementById('joinDealTeamBtn');
    if (!btn) return;
    // Pre-flight VPN check
    if (window.isVpnBlocked && window.isVpnBlocked()) {
        window.showVpnBanner();
        return;
    }
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btn.disabled = true;
    try {
        const resp = await fetch('/api/msx/join-deal-team', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ opportunity_id: opportunityId })
        });
        const data = await resp.json();
        if (data.success) {
            const badge = document.createElement('span');
            badge.className = 'badge bg-success ms-2';
            badge.innerHTML = '<i class="bi bi-people-fill"></i> On Team';
            btn.replaceWith(badge);
        } else {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            alert('Failed to join deal team: ' + (data.error || 'Unknown error'));
        }
    } catch (err) {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        alert('Failed to join deal team: ' + err.message);
    }
}
</script>
{% endblock %}